<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-AndroidFramework/AOSP/TaskA4-sf-research/sf-howto">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="南川笔记 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="南川笔记 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ00XLDNZ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-QFQ00XLDNZ",{anonymize_ip:!0})</script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">surfaceflinger display research | 南川笔记</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://markshawn2020.github.io/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="surfaceflinger display research | 南川笔记"><meta data-rh="true" name="description" content="1. 核心文章"><meta data-rh="true" property="og:description" content="1. 核心文章"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://markshawn2020.github.io/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto"><link data-rh="true" rel="alternate" href="https://markshawn2020.github.io/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://markshawn2020.github.io/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6bbfa55a.css">
<link rel="preload" href="/assets/js/runtime~main.0e36595f.js" as="script">
<link rel="preload" href="/assets/js/main.9949ef9b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">南川笔记</b></a><a class="navbar__item navbar__link" href="/blog/tags">My Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">My Dev Notes</a><a class="navbar__item navbar__link" href="/gallery">Gallery</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/markshawn2020/keeps-learning" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/TODO">TODO</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/SLAM/A01-recognizeLights">SLAM</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SLAM/A01-recognizeLights">A01: recognize lights</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SLAM/slam-research">slam-research</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SLAM/slambook2-ch13">slambook2-ch13</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SLAM/slambook2-learning">slambook2-learning</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">AndroidFramework</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">AOSP</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">TaskA1-aosp-pull</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA2-aosp-compile/aosp-compile-bugfix">TaskA2-aosp-compile</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA3-aosp-changes/aosp-changes">TaskA3-aosp-changes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA4-sf-research/arpara-distortion-logic">TaskA4-sf-research</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA4-sf-research/arpara-distortion-logic">arpara distortion logic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto">surfaceflinger display research</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021">TaskA5-sf-patches</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA6-aosp-read/aosp-read-howto">TaskA6-aosp-read</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/AOSP/TaskA7-aosp-coding/aosp-coding-howto">TaskA7-aosp-coding</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/AndroidFramework/adb-howto">adb howto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/arpara/arpara-vr-logic">arpara</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/AndroidFramework/frameworks-howto">frameworks howto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/hmdservice/TaskB1-hmdservice-compile/how-to-compile-arpara-hmdservice-on-AOSP10">hmdservice</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/rockchip/rockchip4-flash-manual">rockchip</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-bugfix">timewarp</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Coding/CPP/cpp-howto">Coding</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/OS/Linux/centos-init-manual">OS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Software/Adobe/PS/support-for-little-stars/">Software</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/TODO-closed">TODO-closed</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AndroidFramework</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AOSP</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">TaskA4-sf-research</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">surfaceflinger display research</span><meta itemprop="position" content="4"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：0.16.50+</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>surfaceflinger display research</h1><ol><li><a href="#%E6%A0%B8%E5%BF%83%E6%96%87%E7%AB%A0">核心文章</a><ol><li><a href="#%E8%B0%B7%E6%AD%8C%E5%AE%98%E6%96%B9">谷歌官方</a></li><li><a href="#%E6%8E%A8%E8%8D%90%E7%B3%BB%E5%88%97%E4%B8%80android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F---yulong%E7%9A%84%E4%B8%93%E6%A0%8F---%E6%8E%98%E9%87%91">推荐系列一：Android图形系统 - YuLong的专栏 - 掘金</a></li><li><a href="#%E6%8E%A8%E8%8D%90%E7%B3%BB%E5%88%97%E4%BA%8C">推荐系列二</a></li><li><a href="#%E6%8E%A8%E8%8D%90%E7%B3%BB%E5%88%97%E4%B8%89">推荐系列三</a></li><li><a href="#%E5%85%B6%E4%BB%96%E9%98%85%E8%AF%BB">其他阅读</a></li></ol></li><li><a href="#core-logic">core logic</a><ol><li><a href="#createdisplay--destroydisplay"><code>createDisplay | destroyDisplay</code></a></li><li><a href="#getphysicaldisplayids--getphysicaldisplaytoken"><code>getPhysicalDisplayIds | getPhysicalDisplayToken</code></a></li><li><a href="#gethwcomposer--getrenderengine--getcompositionengine"><code>getHwComposer | getRenderEngine | getCompositionEngine</code></a></li><li><a href="#mvrflingerrequestdisplay"><code>mVrFlingerRequestDisplay</code></a></li><li><a href="#initializedisplays"><code>initializeDisplays</code></a></li><li><a href="#surfaceflingersurfaceflinger"><code>SurfaceFlinger::SurfaceFlinger</code></a></li><li><a href="#docomposition"><code>doComposition</code></a></li><li><a href="#surfaceflingerdodisplaycomposition"><code>SurfaceFlinger::doDisplayComposition</code></a></li><li><a href="#surfaceflingerhandlemessagerefresh"><code>SurfaceFlinger::handleMessageRefresh</code></a></li><li><a href="#%E6%8E%A5%E6%94%B6%E5%88%B0%E6%96%B0%E5%BA%94%E7%94%A8%E5%88%87%E6%8D%A2%E4%BF%A1%E6%81%AF%E5%BC%80%E5%A7%8B%E5%87%86%E5%A4%87%E6%96%B0%E7%9A%84%E5%9B%BE%E5%B1%82%E7%9A%84%E7%BB%98%E5%88%B6">接收到新应用切换信息，开始准备新的图层的绘制</a><ol><li><a href="#fixme-%E4%B8%80%E5%88%86%E9%92%9F%E5%90%8E-%E5%BC%80%E5%A7%8B%E5%88%9B%E5%BB%BA%E6%96%B0%E5%BA%94%E7%94%A8%E7%9A%84%E5%9B%BE%E5%B1%82">FIXME: (一分钟后?) 开始创建新应用的图层</a></li><li><a href="#%E5%BA%94%E7%94%A8%E4%BA%A4%E6%9B%BF%E5%AE%8C%E6%88%90%E5%90%8E%E5%90%8E%E5%B0%86%E6%8C%81%E7%BB%AD%E7%BB%98%E5%88%B6%E6%96%B0%E5%BA%94%E7%94%A8%E4%B8%8D%E5%86%8D%E6%9C%89%E6%97%A7%E5%BA%94%E7%94%A8%E4%BF%A1%E6%81%AF">应用交替，完成后后将持续绘制新应用，不再有旧应用信息</a></li><li><a href="#%E5%AE%8C%E6%88%90%E6%96%B0%E7%9A%84%E5%BA%94%E7%94%A8%E5%9B%BE%E5%B1%82%E7%BB%98%E5%88%B6%E5%90%8E%E5%BA%94%E7%94%A8%E5%A6%82%E6%97%A0%E6%9B%B4%E6%96%B0%E5%9B%BE%E5%B1%82%E5%B0%86%E4%B8%8D%E5%86%8D%E7%BB%98%E5%88%B6">完成新的应用/图层绘制后，应用如无更新，图层将不再绘制</a></li><li><a href="#important-%E5%85%B3%E4%BA%8Edisplay%E4%B8%8Blayer%E7%9A%84%E7%BB%98%E5%88%B6%E5%88%86%E6%9E%90%E7%BB%93%E8%AE%BA">IMPORTANT: 关于display下layer的绘制分析结论</a></li></ol></li><li><a href="#%E4%BF%AE%E6%94%B9%E9%80%BB%E8%BE%91">修改逻辑</a><ol><li><a href="#todo-%E4%BB%80%E4%B9%88%E6%98%AF-handleroundedcorners%E6%88%91%E7%9B%AE%E5%89%8D%E4%B8%8D%E7%AE%A1%E5%AE%83%E7%9B%B4%E6%8E%A5%E6%B8%B2%E6%9F%93%E4%BA%86">TODO: 什么是 <code>handleRoundedCorners</code>，我目前不管它，直接渲染了</a></li><li><a href="#fixed-%E5%A6%82%E6%9E%9C%E8%B5%B0%E5%8E%9F%E5%85%88%E7%B3%BB%E7%BB%9F%E6%B8%B2%E6%9F%93%E7%9A%84%E5%88%86%E6%94%AF%E5%AF%BC%E8%87%B4%E7%94%BB%E9%9D%A2%E4%B8%8D%E6%AD%A3%E5%B8%B8-no-its-all-because-of-scrcpy">FIXED: 如果走原先系统渲染的分支，导致画面不正常 (No! It&#x27;s all because of Scrcpy!)</a></li><li><a href="#%E5%8A%A0%E5%85%A5%E6%88%91%E4%BB%AC%E7%9A%84%E5%B1%8F%E5%B9%95%E9%80%BB%E8%BE%91">加入我们的屏幕逻辑</a></li></ol></li></ol></li><li><a href="#%E5%B1%8F%E5%B9%95%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF">屏幕基本信息</a><ol><li><a href="#displayid"><code>DisplayId</code></a></li><li><a href="#display--displaydevicegetdebugname"><code>Display | DisplayDevice::getDebugName</code></a></li><li><a href="#mesh--meshbuilder"><code>Mesh | Mesh::Builder</code></a></li></ol></li><li><a href="#%E5%B1%9E%E6%80%A7">属性</a><ol><li><a href="#%E5%85%B3%E4%BA%8E%E5%B1%9E%E6%80%A7%E7%9A%84%E5%AE%98%E6%96%B9%E5%8F%82%E8%80%83">关于属性的官方参考</a></li><li><a href="#property_get--property_set"><code>property_get | property_set</code></a></li></ol></li><li><a href="#%E6%8A%95%E5%B1%8F-scrcpy">投屏 (<code>scrcpy</code>)</a><ol><li><a href="#adb-server-version-41-doesnt-match-this-client-40-527"><code>adb server version (41) doesn&#x27;t match this client (40) #527</code></a></li><li><a href="#%E5%A4%9A%E7%AA%97%E5%8F%A3%E6%94%AF%E6%8C%81%E8%99%9A%E6%8B%9F%E5%89%AF%E5%B1%8F">多窗口支持（虚拟副屏）</a><ol><li><a href="#%E5%9C%A8android%E6%A8%A1%E6%8B%9F%E5%99%A8%E4%B8%8A%E5%90%AF%E5%8A%A8%E5%8F%8C%E5%B1%8F%E5%BC%82%E6%98%BE">在Android模拟器上启动双屏异显</a></li><li><a href="#best-practice-disable-simulate-secondary-display">BEST-PRACTICE: disable <code>simulate secondary display</code></a></li></ol></li></ol></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心文章">核心文章<a class="hash-link" href="#核心文章" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="谷歌官方">谷歌官方<a class="hash-link" href="#谷歌官方" title="标题的直接链接">​</a></h3><ul><li><p><a href="https://source.android.google.cn/devices/graphics/architecture?hl=zh-cn" target="_blank" rel="noopener noreferrer">图形架构  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/arch-bq-gralloc?hl=zh-cn" target="_blank" rel="noopener noreferrer">BufferQueue 和 Gralloc  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/arch-sh?hl=zh-cn" target="_blank" rel="noopener noreferrer">Surface 和 SurfaceHolder  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/surfaceflinger-windowmanager?hl=zh-cn" target="_blank" rel="noopener noreferrer">SurfaceFlinger 和 WindowManager  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/hwc?hl=zh-cn" target="_blank" rel="noopener noreferrer">硬件混合渲染器 HAL  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/layers-displays?hl=zh-cn" target="_blank" rel="noopener noreferrer">层和屏幕  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/implement-vsync?hl=zh-cn" target="_blank" rel="noopener noreferrer">VSYNC  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/frame-pacing?hl=zh-cn" target="_blank" rel="noopener noreferrer">Frame Pacing 库概览  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/arch-egl-opengl?hl=zh-cn" target="_blank" rel="noopener noreferrer">EGLSurface 和 OpenGL ES  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/arch-vulkan?hl=zh-cn" target="_blank" rel="noopener noreferrer">Vulkan  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/sync?hl=zh-cn" target="_blank" rel="noopener noreferrer">同步框架  |  Android 开源项目  |  Android Open Source Project</a></p></li><li><p><a href="https://source.android.google.cn/devices/graphics/implement?hl=zh-cn" target="_blank" rel="noopener noreferrer">实现测试  |  Android 开源项目  |  Android Open Source Project</a></p></li></ul><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-howto-1644813248011-1b74af291c18328e8beb97146675c9747e0b71c81bb9270e5e24103eaa39c9e1.png" alt="picture 58" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="推荐系列一android图形系统---yulong的专栏---掘金">推荐系列一：<a href="https://juejin.cn/column/7021525822439686174" target="_blank" rel="noopener noreferrer">Android图形系统 - YuLong的专栏 - 掘金</a><a class="hash-link" href="#推荐系列一android图形系统---yulong的专栏---掘金" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644767185263-319f6789b39c13e5a6b86a0a949f42e6ad2f41664ceb6e16e85f3d05e52faaf9.png" alt="picture 29" class="img_ev3q">  </p><ul><li><p><a href="https://juejin.cn/post/7026351143714308132" target="_blank" rel="noopener noreferrer">[Android禅修之路] Android 图形系统开篇 - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7026352122941669413" target="_blank" rel="noopener noreferrer">[Android禅修之路] SurfaceFlinger的启动过程 - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7027848653511327751" target="_blank" rel="noopener noreferrer">[Android禅修之路] SurfaceFlinger合成总览 - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7028950385251319815" target="_blank" rel="noopener noreferrer">[Android禅修之路] SurfaceFlinger 合成前的预处理 - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7028951141710823432" target="_blank" rel="noopener noreferrer">[Android禅修之路] SurfaceFlinger 中的一些对象 - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7030402577875337230" target="_blank" rel="noopener noreferrer">[Android禅修之路] SurfaceFlinger 合成中的工作 - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7033402333128032286" target="_blank" rel="noopener noreferrer">[Android禅修之路] 解读SurfaceFlinger中的BufferQueue - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7045996528942448648" target="_blank" rel="noopener noreferrer">[Android禅修之路] 解读Vsync(一) - 掘金</a></p></li><li><p><a href="https://juejin.cn/post/7045996703219974157" target="_blank" rel="noopener noreferrer">[Android禅修之路] 解读Vsync(二) - 掘金</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="推荐系列二">推荐系列二<a class="hash-link" href="#推荐系列二" title="标题的直接链接">​</a></h3><ul><li><p>这篇写的非常不错，很清晰详细，包括很多类图也是独有的：<a href="https://www.jianshu.com/p/824a9ddf68b9" target="_blank" rel="noopener noreferrer">Android P 图形显示系统（一）硬件合成HWC2 - 简书</a></p></li><li><p>这篇继承上篇，讲到了layer相关的：<a href="https://wizzie.top/Blog/2019/12/22/2019/191222_android_HWC2/" target="_blank" rel="noopener noreferrer">Android SurfaceFlinger和HWC2概述 | sunwengang blog</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="推荐系列三">推荐系列三<a class="hash-link" href="#推荐系列三" title="标题的直接链接">​</a></h3><ul><li><a href="https://juejin.cn/post/6844903955709837326" target="_blank" rel="noopener noreferrer">Android图形系统系统篇之HWC - 掘金</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他阅读">其他阅读<a class="hash-link" href="#其他阅读" title="标题的直接链接">​</a></h3><ul><li><p><a href="https://www.twblogs.net/a/5e4ed7f0bd9eee101e83b715" target="_blank" rel="noopener noreferrer">Oculus VR SDK實現 -主要結構體及Api接口設計 - 台部落</a></p></li><li><p><a href="https://www.twblogs.net/a/5ef3a16b26bc8c4a8eb3f242" target="_blank" rel="noopener noreferrer">Native層-OpenGL ES-雙緩衝離屏渲染 - 台部落</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-logic">core logic<a class="hash-link" href="#core-logic" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="createdisplay--destroydisplay"><code>createDisplay | destroyDisplay</code><a class="hash-link" href="#createdisplay--destroydisplay" title="标题的直接链接">​</a></h3><p><code>createDisplay</code> 函数里面没有什么特别的地方，就是把名字和安全性信息保存了下来，并且返回了一个新生成的token</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644396165436-95dab24e23025dd4ff192453d15e3a3163f253153f9d51040684201037c8d9a0.png" alt="picture 26" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getphysicaldisplayids--getphysicaldisplaytoken"><code>getPhysicalDisplayIds | getPhysicalDisplayToken</code><a class="hash-link" href="#getphysicaldisplayids--getphysicaldisplaytoken" title="标题的直接链接">​</a></h3><p>FIXME: <code>getPhysicalDisplayIds</code> 这个函数也没啥东西，就是把<code>mPhysicalDisplayTokens</code>中不是内置屏（<code>internalDisplayId</code>）的都记为物理屏（不太理解，非内置，也就是外置，外置就等于物理屏了吗？所以虚拟屏属于内置屏？但虚拟屏的id也不等于<code>internalDisplayId</code>吧）</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644396656636-7978143298f058bdfc673509bd1c643a73300b7d17a45240d5ceb46d8b29f815.png" alt="picture 27" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gethwcomposer--getrenderengine--getcompositionengine"><code>getHwComposer | getRenderEngine | getCompositionEngine</code><a class="hash-link" href="#gethwcomposer--getrenderengine--getcompositionengine" title="标题的直接链接">​</a></h3><p>这几个函数都是基于 <code>mCompositionEngine</code>的。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644396948455-34c7feeb8f30cd7df711e413a3e9c5dbd925f21979bd2331070735df2c646d31.png" alt="picture 28" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mvrflingerrequestdisplay"><code>mVrFlingerRequestDisplay</code><a class="hash-link" href="#mvrflingerrequestdisplay" title="标题的直接链接">​</a></h3><p>FIXME: 也许 <code>getHwComposer().getComposer()-&gt;isRemote()</code> 可以判断是否是有外接屏？还是啥？</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644398131632-f7c5ca93c1500c823a52d6b8bafc1f61c5160830c11af2e9cfb479f2342a8807.png" alt="picture 29" class="img_ev3q">  </p><p>这一段应该就是google目前处理<code>vrFlinger</code>的逻辑，主要是<code>HwComposer</code>处理的。（和我们用<code>OpenGL</code>的方案不同）</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644398536604-9ae51ad41ef0e8d08c1713c867287544b1f7a5ac70c43b775ad24e009b9ef034.png" alt="picture 30" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initializedisplays"><code>initializeDisplays</code><a class="hash-link" href="#initializedisplays" title="标题的直接链接">​</a></h3><p>在 <code>init</code> 函数中，判断完 <code>vrFlinger</code> 之后就开始初始化 displays 了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644398712378-18ac3844d81a3332d3b5e6de49bfeb0dbed36e0f8b9a94e9d77a9f8f25423ecb.png" alt="picture 31" class="img_ev3q">  </p><p>不过 <code>initializeDisplays</code> 中也没有做什么特别神奇的事，就是初始化了一个 <code>Vector&lt;DisplayState&gt; displays</code> 向量，然后装进了一个初始化几乎为0的 <code>displayState</code>。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644399394079-f2aa7b40d5aed66ad5b55c6e0c0ad7e2b1717f96d84d1d0f33ab886596ca9562.png" alt="picture 32" class="img_ev3q">  </p><p>也就是说，<code>displays</code> 是 <code>displayState</code> 的一个集合。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="surfaceflingersurfaceflinger"><code>SurfaceFlinger::SurfaceFlinger</code><a class="hash-link" href="#surfaceflingersurfaceflinger" title="标题的直接链接">​</a></h3><p>总体看下来，基本都是一些值的初始化，看起来也主要是三种类型：<code>debug | ro | sys</code>，猜测 <code>ro</code> 是 <code>rockchip</code> 的意思，也就是 rockchip 自己定义的变量，sys 是系统属性。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644400920798-067e47132aee75aff619a393935b42c56c96686c9754cc7237bbe2d8659b2430.png" alt="picture 36" class="img_ev3q">  </p><p>FIXME: 比较耐人寻味的是 <code>debug</code> 的含义，到底是单纯的 debug 呢？还是既用作debug，又用作变量。</p><p>比如如下中那句注释 <code>debugging stuff...</code>，好像表明这些变量似乎就是用来debug的，而没有其他作用（即：打开与否不影响系统运行）……：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644400566554-c3ec11a248e4378729955f0e1372a3412fe046db59e096bb3d92e1ce0fe32285.png" alt="picture 34" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docomposition"><code>doComposition</code><a class="hash-link" href="#docomposition" title="标题的直接链接">​</a></h3><p>cpp++
auto display = displayDevice-&gt;getCompositionDisplay();
const auto&amp; displayState = display-&gt;getState();</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 37](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644402161945-7aad65da4ea112adac978d23aff3e6408a252f7da25e6bfcab95b767a9a76d06.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`DisplayState` 是定义在 `native/libs/gui/include/gui/LayerState.h` 中的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 38](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644402585796-305163d611c8eed7ededc4794881c87adf57cb8667f5dd7574955a590385d56f.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其中，并无我想要的 `displayName`，2333。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### `SurfaceFlinger::doDisplayComposition`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FIXME: display从readyFence中取出buffer，我们也不用管这个函数吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 39](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644404173728-11ba658674b9747f87dff9d0c53283db5829e13e0d7a0bcfa9e3b5bdf290a66a.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### `SurfaceFlinger::handleMessageRefresh`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这里面首先遍历了`mDisplay`，这是一个`Map&lt;token: DisplayDevice&gt;`的结构，所以我们用`displayDevice`的`getDebugName`函数直接打印具体信息。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 2](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644458370072-00d1d3e326503541b125f3eb38cb5ba8e779fbadaf46313d384db6926df284e4.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">试着打印了一下，捕捉系统重启的动作，但结果很诡异（关于`scrcpy`部分），竟然直接跳过了我前面几个语句的打印，直接就`doCompositionFinished`了，感觉是错过了一些log：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 4](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644462417643-8764cab02fd0d69f26b68af7260ab81ded0e571845cf540f08976dc8f1515ca1.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">但我的log应该是完整的啊，因为第一行就是`beginning of system`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 5](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644462478626-319d98178fddb294f2a0b3ae55e81695efd4513578088c153a256b9ebc803248.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">也可能是`scrcpy`和`adb logcat`的时机不对？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我再试一遍，先logcat，再scrcpy看看。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">找到了！确实（很可能）是`adb` 和 `scrcpy`之间的顺序问题，现在使用以下命令收集日志，就完整了！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 需要重启手机，以重置log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adb reboot &amp;&amp; (adb logcat &gt; logcat.log &amp; sc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># sc是</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export sc() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while [[ -z $(adb devices | grep -E &quot;device$&quot;) ]]; do echo &quot;waiting...&quot;; sleep 2; done;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ADB=$(which adb) scrcpy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644462951227-efd3217d6d170ae1329108103654678bc4d0d6e6ac56d48ef01b65510c47d8c0.png" alt="picture 6" class="img_ev3q">  </p><p>从这个log来看，<code>scrcpy</code>最后一步 <code>doComposition</code> 的回路明显要比 <code>internalDisplay</code> 和 <code>Overlay #1</code> 要长很多（可能是无限循环渲染的原因），具体也不清楚啊，理论上，scrcpy只要把主屏投过去就可以了啊（基于一个完整的屏），结果不是，看这log，scrcpy是又创建了一个虚拟屏啊……</p><p>我们在主屏上，基于开发者模式模拟了副屏，默认的副屏会捕捉主屏，于是出现了直播软件的无限套屏现象；然后我们还用用scrcpy又创了一块虚拟屏……</p><p>我已经傻傻分不清了……</p><p>不过目测应该暂时问题不大。</p><p>另外一点，就是我发现，如果<strong>主屏和副屏都是桌面致使无限套屏</strong>的话，log会疯狂输出；直到我们在副屏启动了一个新的应用（比如：设置），log才会稳定下来，这大概就是套屏与不套屏的最大区别，值得警惕。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644463441714-3fb634b55447d3ec520a44ac0d06d2a39f76295bfb5b07b9c89e58ae3ee180b3.png" alt="picture 7" class="img_ev3q">  </p><p>好在我们只需要调试主副屏异显的场景，目前来看，也是相对来说更好调试的。</p><hr><p>接下来，我们就发现，不同屏幕的渲染逻辑与顺序了。</p><p>可以看到，是 <code>Overlap #1</code> -&gt; <code>scrcpy</code> -&gt; <code>internalDisplay</code> 的顺序，并且 <code>scrcpy</code> 和 <code>internalDisplay</code> 渲染的图层信息是一样的，而 <code>Overlap #1</code>没有渲染层的日志信息，因为它只是打开了一个设置应用</p><p>FIXED: 但为啥这个应用就没有layer层的log信息呢？</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644463723806-9e313bce2dd541de5985515ab226e4056c78a893064e00c7fa9a2d4fe2bec63b.png" alt="picture 8" class="img_ev3q">  </p><hr><p>因为每次打开应用，屏幕会有多次刷新，只在最初几（可能从1到n-k）次会有 <code>Overlap #1</code> display里的层渲染。</p><p>比如，我用 <code>adb shell am start -n com.android.settings/.Settings --display 1</code> 与 <code>adb shell am start -n com.android.gallery3d/.app.GalleryActivity --display 1</code> 在副屏上交换打开 设置 与 图库应用，打开之后的初步就会有反应。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644464633264-c6a869a8e63e758abfad9eda6bbaf95aea94ae15d948ad9df7157f2ffdb48a2b.png" alt="picture 9" class="img_ev3q"> </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="接收到新应用切换信息开始准备新的图层的绘制">接收到新应用切换信息，开始准备新的图层的绘制<a class="hash-link" href="#接收到新应用切换信息开始准备新的图层的绘制" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644466090539-148e02f3ff1f322fb01ec520ad07e85969620b6b10ff3f4a1784f7ae520d0919.png" alt="picture 13" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fixme-一分钟后-开始创建新应用的图层">FIXME: (一分钟后?) 开始创建新应用的图层<a class="hash-link" href="#fixme-一分钟后-开始创建新应用的图层" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644466013667-658bfd9c15c01e0f07194c42fd8aab25409ed95128920c5f633c6fed079a45fe.png" alt="picture 12" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="应用交替完成后后将持续绘制新应用不再有旧应用信息">应用交替，完成后后将持续绘制新应用，不再有旧应用信息<a class="hash-link" href="#应用交替完成后后将持续绘制新应用不再有旧应用信息" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644465915980-05885c5806f2286d4f01f97f42ea3044d2ac6eb76e7f1fe49862dccef3eed53f.png" alt="picture 11" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="完成新的应用图层绘制后应用如无更新图层将不再绘制">完成新的应用/图层绘制后，应用如无更新，图层将不再绘制<a class="hash-link" href="#完成新的应用图层绘制后应用如无更新图层将不再绘制" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644465763962-ca34e30c5d98f5e86a80997ba0b0af79988ce8c7a153bf5e18949f11aada4067.png" alt="picture 10" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="important-关于display下layer的绘制分析结论">IMPORTANT: 关于display下layer的绘制分析结论<a class="hash-link" href="#important-关于display下layer的绘制分析结论" title="标题的直接链接">​</a></h4><p>在准备新的图层时，确实是将所有layer一一绘制然后叠加到目标display上。</p><p>也就是说，<code>SurfaceFlinger</code>在渲染时，首先遍历所有display（按照一定的优先顺序），这是外层循环。然后内层，会对所有layer再进行遍历绘制。如果没有新的layer，则不绘制（没有 <code>doComposition</code> 的动作，大概如一些文章所说的，那就会直接从 <code>BufferQueue</code> 中取了。</p><p>而外层循环函数就是 <code>SurfaceFlinger::handleMessageRefresh</code>。</p><p>所以我们可以在外层循环中，对每个display进行区分，传入是否启用vr的参数，以实现<strong>主屏不反畸变，副屏畸变</strong>的效果。</p><p>相关log调试已保存在 <a target="_blank" href="/assets/files/logcat_settings-gallery3d-b937e728e879cfd057c1b8f80fbc9ee7.log">logcat_settings-gallery3d.log</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="修改逻辑">修改逻辑<a class="hash-link" href="#修改逻辑" title="标题的直接链接">​</a></h3><p><code>doDebugFlashRegions</code> 函数内部有部分关于重新绘制整个屏幕的函数 <code>doComposeSurface</code>。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644466983284-f1545ac87774b0fd57fe39d2cc3d6f249944a057703aa32be40f64cf1dd2fbb1.png" alt="picture 14" class="img_ev3q">  </p><p><del>FIXED: 但是奇怪的是，我们好像确实没有操作这边（log里没有我在 <code>doDisplayComposition</code> 函数中的断点，所以可能正如晓研哥所说：我们没有操纵 <code>FrameBuffer</code>。）</del></p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644467241837-e0831761d7ec0cfd2eefa8d35cc17ec8de97b0881658464bc3a5f0406ba3f4fe.png" alt="picture 15" class="img_ev3q">  </p><p>No，这是因为我们……用的是<code>ALOGV</code>，所以才默认没有打印……</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="todo-什么是-handleroundedcorners我目前不管它直接渲染了">TODO: 什么是 <code>handleRoundedCorners</code>，我目前不管它，直接渲染了<a class="hash-link" href="#todo-什么是-handleroundedcorners我目前不管它直接渲染了" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644468422163-ed20507e28f83af75cb98b5c777071508a85cf7caf10307fb2b354907e7a0a84.png" alt="picture 16" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fixed-如果走原先系统渲染的分支导致画面不正常-no-its-all-because-of-scrcpy">FIXED: 如果走原先系统渲染的分支，导致画面不正常 (No! It&#x27;s all because of Scrcpy!)<a class="hash-link" href="#fixed-如果走原先系统渲染的分支导致画面不正常-no-its-all-because-of-scrcpy" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644469165742-7d1256b230e0674fbb7a003cd95a57d06063e15f2864a88a47b3b4fade3ea8c1.png" alt="picture 18" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644469069781-15fb45e551e02364e8258fee829d9888421ab7966644c8f2ae6fd8474b7a7cac.png" alt="picture 17" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644471022048-a14a4f38d5b1a9b57b6c6331287bce1c17e08d0eb2052c50995cdcb3b7841603.png" alt="picture 19" class="img_ev3q">  </p><p>如果强制走ARPARA的逻辑，也不正常了：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644471286167-c6fdbcbecf700f881652c481297545741a5b299edd10a5fdfdc1065c982e1883.png" alt="picture 20" class="img_ev3q">  </p><p>好恐怖，得把之前的逻辑改回来。。。</p><hr><p>经过不断地“回退”后，发现没能解决这个问题，由于我实质上只改动过 <code>$sf/SurfaceFlinger.cpp</code> 和 <code>$gl/GLESRenderEngine.cpp</code>，因此最终确定，一定不是程序的问题。</p><p>后来意识到了！</p><p>是 <code>scrcpy --max-size 360</code> 的问题！</p><p>这个参数会提前限制屏幕的大小，导致渲染异常！</p><p>所以正确的做法，应该是 <code>resize</code> 而非 <code>max-size</code>！</p><p>这是两个不同的操作！</p><p>回退后就出现目前暂时想要的预期效果了：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644474394720-8198a5744f9ee9749121c8f56ad986f08e693dcf1c4e53a1e4077e891b718c4b.png" alt="picture 21" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="加入我们的屏幕逻辑">加入我们的屏幕逻辑<a class="hash-link" href="#加入我们的屏幕逻辑" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644474507400-bce3205434fb4b88750554a56097b99f5e49da10b6713cf5b22cd50b4fb9b70c.png" alt="picture 22" class="img_ev3q">  </p><p>检测 <code>DisplayDevice.getDebugName()</code> 中的信息，比如是不是 <code>Overlap XX</code>(模拟测试)，或是有什么id </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644476692368-e43a6b98641a6f298e3776f1942c52e4e5506f04e78d6ab6682cb46d0e8e94ed.png" alt="picture 24" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644476259875-d13018feaa960c2ac8f0398bd61d5a623e8be4b9fab4e39b49babad9309deec8.png" alt="picture 23" class="img_ev3q">  </p><p>当 内置屏不做反畸变，然后误把 scrcpy 反畸变后，实际上等同于把内置屏做了反畸变：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644481108953-5a1302167ca99f49cdb411a75095b1e46b82c2caf1c6fd88efd4f986f73917b0.png" alt="picture 28" class="img_ev3q">  </p><p>【修改好语法】（花了接近两小时）后，终于实现了。</p><p>这是清理代码后的结果：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644493134518-5344037de67107f2679304c562532591400da7f72702ceb447e97c1bcf1052f6.png" alt="picture 5" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="屏幕基本信息">屏幕基本信息<a class="hash-link" href="#屏幕基本信息" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="displayid"><code>DisplayId</code><a class="hash-link" href="#displayid" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644478810088-0cfccc9ea75c9b0cddc108c95e5478363f2a6a57a4b088ed9c30292239b54f76.png" alt="picture 26" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644480089749-5cc880adbf88b6073f67964cb2926af288cdc7c1e3ad772b8d588122d75a9c53.png" alt="picture 27" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644478376848-124329d51189ef791f124d7bf594a3bc68eb7f930a1bc075e8c0e51789ea2e05.png" alt="picture 25" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="display--displaydevicegetdebugname"><code>Display | DisplayDevice::getDebugName</code><a class="hash-link" href="#display--displaydevicegetdebugname" title="标题的直接链接">​</a></h3><p>可以使用 <code>DisplayDevice::getDebugName</code> 方便获取屏幕信息，如果直接用 <code>getId</code> 的话，有可能为空，信息也不是很够。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644404592849-c88a4470d37f5e2c1773096e99b464ad2a394ce5b4ec8d64b23ad00784d09be2.png" alt="picture 40" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644405345360-4b5d7b81a0f4fc99acc31206a1458d64b0200ebaf7d640cf16da9bc06bec5e30.png" alt="picture 41" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mesh--meshbuilder"><code>Mesh | Mesh::Builder</code><a class="hash-link" href="#mesh--meshbuilder" title="标题的直接链接">​</a></h3><p><code>Mesh::Builder</code> 如下：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-howto-1644999320206-07ea6d50b136d13f95e7634d861d8c84e8e9d22cb5d8fb3b71e2f08389b6c97a.png" alt="picture 23" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="属性">属性<a class="hash-link" href="#属性" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于属性的官方参考">关于属性的官方参考<a class="hash-link" href="#关于属性的官方参考" title="标题的直接链接">​</a></h3><ul><li><a href="https://source.android.com/devices/architecture/configuration/add-system-properties" target="_blank" rel="noopener noreferrer">添加系统属性  |  Android 开源项目  |  Android Open Source Project</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="property_get--property_set"><code>property_get | property_set</code><a class="hash-link" href="#property_get--property_set" title="标题的直接链接">​</a></h3><p><code>property_get</code> 用于获取一个属性，存储到（一般是临时的）<code>value</code>变量中，然后再基于<code>atoi</code>转换存储到对应变量。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644400482897-e556a2c0c12b9364bcfbfd78951955fc97f631bda5f8b7834627d2e84b33c9ba.png" alt="picture 33" class="img_ev3q">  </p><p>例如：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644400566554-c3ec11a248e4378729955f0e1372a3412fe046db59e096bb3d92e1ce0fe32285.png" alt="picture 34" class="img_ev3q">  </p><p>而 <code>property_set</code> 则是用于修改属性值，并且一般都是字符串。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644400615270-f540e1d2e892b333e3a4aabd6b6ef58cc957d2a029008e45799ca1b342bd72e3.png" alt="picture 35" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="投屏-scrcpy">投屏 (<code>scrcpy</code>)<a class="hash-link" href="#投屏-scrcpy" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="adb-server-version-41-doesnt-match-this-client-40-527"><code>adb server version (41) doesn&#x27;t match this client (40) #527</code><a class="hash-link" href="#adb-server-version-41-doesnt-match-this-client-40-527" title="标题的直接链接">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># force scrcpy to use specific adb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADB=specified-adb scrcpy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/sf-displays-research-1644415248041-ce024be52e9fcd0c82716539849b9c571bf79addb73f7c55301e43c575cb8df4.png" alt="picture 42" class="img_ev3q">  </p><blockquote><p>ref</p></blockquote><ul><li><p>✨✨ solution: <a href="https://github.com/Genymobile/scrcpy/issues/527" target="_blank" rel="noopener noreferrer">adb server version (41) doesn&#x27;t match this client (40) · Issue #527 · Genymobile/scrcpy</a></p></li><li><p><a href="https://github.com/Genymobile/scrcpy/issues/2856" target="_blank" rel="noopener noreferrer">adb-server version mismatch + device offline error · Issue #2856 · Genymobile/scrcpy</a></p></li><li><p><a href="https://thedarksource.com/how-to-solve-this-adb-server-version-doesnt-match-this-client-error-in-android/" target="_blank" rel="noopener noreferrer">How To Resolve This ADB Server Version Doesn&#x27;t Match This Client Error In Android? | The Dark Source</a></p></li><li><p><a href="https://stackoverflow.com/questions/55634367/install-specific-adb-version-on-linux/55724130" target="_blank" rel="noopener noreferrer">android - Install specific adb version on Linux - Stack Overflow</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="多窗口支持虚拟副屏">多窗口支持（虚拟副屏）<a class="hash-link" href="#多窗口支持虚拟副屏" title="标题的直接链接">​</a></h3><ul><li><a href="https://developer.android.com/guide/topics/large-screens/multi-window-support" target="_blank" rel="noopener noreferrer">多窗口支持  |  Android 开发者  |  Android Developers</a></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="在android模拟器上启动双屏异显">在Android模拟器上启动双屏异显<a class="hash-link" href="#在android模拟器上启动双屏异显" title="标题的直接链接">​</a></h4><p>模拟器中打开&quot;设置-开发者选项&quot;界面，在列表中找到&quot;Simulate secondary displays&quot;条目。</p><p>点击后，在弹出的对话框中选择副屏的分辨率。</p><p>比如我们选中720p，模拟器屏幕的左上角上会立即呈现出副屏的窗口，其显示内容默认为与主屏显示一致：</p><blockquote><p>see</p></blockquote><ul><li><a href="https://blog.csdn.net/weixin_33612966/article/details/112932641" target="_blank" rel="noopener noreferrer">(1条消息) 安卓系统双屏异显_Android10模拟器上调试双屏异显_wlj509的博客-CSDN博客</a></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="best-practice-disable-simulate-secondary-display">BEST-PRACTICE: disable <code>simulate secondary display</code><a class="hash-link" href="#best-practice-disable-simulate-secondary-display" title="标题的直接链接">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adb shell settings put global overlay_display_devices 1920x1080/320</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>ref</p></blockquote><ul><li><p><a href="https://www.reddit.com/r/tasker/comments/akwso9/developer_settings_simulate_secondary_screen/" target="_blank" rel="noopener noreferrer">Developer Settings simulate secondary screen : tasker</a></p></li><li><p><a href="https://stackoverflow.com/questions/46810503/adb-change-developer-settings-options-programmatically" target="_blank" rel="noopener noreferrer">android - adb change developer settings options programmatically - Stack Overflow</a></p></li><li><p><a href="https://android.stackexchange.com/questions/61454/added-simulated-external-display-in-developer-settings-and-cant-boot-now" target="_blank" rel="noopener noreferrer">cyanogenmod - Added simulated external display in Developer Settings and can&#x27;t boot now - Android Enthusiasts Stack Exchange</a></p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/markshawn2020/keeps-learning/edit/master/library/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2022-07-29T11:41:19.000Z">2022年7月29日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/AndroidFramework/AOSP/TaskA4-sf-research/arpara-distortion-logic"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">arpara distortion logic</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">surfaceflinger patch research</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#核心文章" class="table-of-contents__link toc-highlight">核心文章</a><ul><li><a href="#谷歌官方" class="table-of-contents__link toc-highlight">谷歌官方</a></li><li><a href="#推荐系列一android图形系统---yulong的专栏---掘金" class="table-of-contents__link toc-highlight">推荐系列一：Android图形系统 - YuLong的专栏 - 掘金</a></li><li><a href="#推荐系列二" class="table-of-contents__link toc-highlight">推荐系列二</a></li><li><a href="#推荐系列三" class="table-of-contents__link toc-highlight">推荐系列三</a></li><li><a href="#其他阅读" class="table-of-contents__link toc-highlight">其他阅读</a></li></ul></li><li><a href="#core-logic" class="table-of-contents__link toc-highlight">core logic</a><ul><li><a href="#createdisplay--destroydisplay" class="table-of-contents__link toc-highlight"><code>createDisplay | destroyDisplay</code></a></li><li><a href="#getphysicaldisplayids--getphysicaldisplaytoken" class="table-of-contents__link toc-highlight"><code>getPhysicalDisplayIds | getPhysicalDisplayToken</code></a></li><li><a href="#gethwcomposer--getrenderengine--getcompositionengine" class="table-of-contents__link toc-highlight"><code>getHwComposer | getRenderEngine | getCompositionEngine</code></a></li><li><a href="#mvrflingerrequestdisplay" class="table-of-contents__link toc-highlight"><code>mVrFlingerRequestDisplay</code></a></li><li><a href="#initializedisplays" class="table-of-contents__link toc-highlight"><code>initializeDisplays</code></a></li><li><a href="#surfaceflingersurfaceflinger" class="table-of-contents__link toc-highlight"><code>SurfaceFlinger::SurfaceFlinger</code></a></li><li><a href="#docomposition" class="table-of-contents__link toc-highlight"><code>doComposition</code></a></li><li><a href="#接收到新应用切换信息开始准备新的图层的绘制" class="table-of-contents__link toc-highlight">接收到新应用切换信息，开始准备新的图层的绘制</a></li><li><a href="#修改逻辑" class="table-of-contents__link toc-highlight">修改逻辑</a></li></ul></li><li><a href="#屏幕基本信息" class="table-of-contents__link toc-highlight">屏幕基本信息</a><ul><li><a href="#displayid" class="table-of-contents__link toc-highlight"><code>DisplayId</code></a></li><li><a href="#display--displaydevicegetdebugname" class="table-of-contents__link toc-highlight"><code>Display | DisplayDevice::getDebugName</code></a></li><li><a href="#mesh--meshbuilder" class="table-of-contents__link toc-highlight"><code>Mesh | Mesh::Builder</code></a></li></ul></li><li><a href="#属性" class="table-of-contents__link toc-highlight">属性</a><ul><li><a href="#关于属性的官方参考" class="table-of-contents__link toc-highlight">关于属性的官方参考</a></li><li><a href="#property_get--property_set" class="table-of-contents__link toc-highlight"><code>property_get | property_set</code></a></li></ul></li><li><a href="#投屏-scrcpy" class="table-of-contents__link toc-highlight">投屏 (<code>scrcpy</code>)</a><ul><li><a href="#adb-server-version-41-doesnt-match-this-client-40-527" class="table-of-contents__link toc-highlight"><code>adb server version (41) doesn&#39;t match this client (40) #527</code></a></li><li><a href="#多窗口支持虚拟副屏" class="table-of-contents__link toc-highlight">多窗口支持（虚拟副屏）</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Docusaurus</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/category/guides" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0e36595f.js"></script>
<script src="/assets/js/main.9949ef9b.js"></script>
</body>
</html>