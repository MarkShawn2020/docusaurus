<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/keeps-learning/blog/rss.xml" title="南川笔记 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/keeps-learning/blog/atom.xml" title="南川笔记 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QFQ00XLDNZ","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">surfaceflinger patch research | 南川笔记</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="surfaceflinger patch research | 南川笔记"><meta data-rh="true" name="description" content="- gerrit codes"><meta data-rh="true" property="og:description" content="- gerrit codes"><link data-rh="true" rel="icon" href="/keeps-learning/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021"><link data-rh="true" rel="alternate" href="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021" hreflang="x-default"><link rel="stylesheet" href="/keeps-learning/assets/css/styles.6bbfa55a.css">
<link rel="preload" href="/keeps-learning/assets/js/runtime~main.3d1d49db.js" as="script">
<link rel="preload" href="/keeps-learning/assets/js/main.09e96f98.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/keeps-learning/"><div class="navbar__logo"><img src="/keeps-learning/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/keeps-learning/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">南川笔记</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/keeps-learning/docs/">My Docs</a><a class="navbar__item navbar__link" href="/keeps-learning/blog">My Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/markshawn2020/keeps-learning" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keeps-learning/docs/">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keeps-learning/docs/TODO">TODO</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/keeps-learning/docs/SLAM/A01-recognizeLights">SLAM</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/A01-recognizeLights">A01: recognize lights</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/slam-research">slam-research</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/slambook2-ch13">slambook2-ch13</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/slambook2-learning">slambook2-learning</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">AndroidFramework</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">AOSP</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">TaskA1-aosp-pull</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA2-aosp-compile/aosp-compile-bugfix">TaskA2-aosp-compile</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA3-aosp-changes/aosp-changes">TaskA3-aosp-changes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA4-sf-research/arpara-distortion-logic">TaskA4-sf-research</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021">TaskA5-sf-patches</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021">surfaceflinger patch research</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2022">surfaceflinger patch research 2022</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA6-aosp-read/aosp-read-howto">TaskA6-aosp-read</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA7-aosp-coding/aosp-coding-howto">TaskA7-aosp-coding</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/adb-howto">adb howto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/arpara/arpara-vr-logic">arpara</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/frameworks-howto">frameworks howto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/hmdservice/TaskB1-hmdservice-compile/how-to-compile-arpara-hmdservice-on-AOSP10">hmdservice</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/rockchip/rockchip4-flash-manual">rockchip</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-bugfix">timewarp</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/Coding/CPP/cpp-howto">Coding</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/Notes/uploaded/I-am-me">Notes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/OS/Linux/centos-init-manual">OS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/Softwares/Adobe/PS/support-for-little-stars/">Softwares</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keeps-learning/docs/TODO-closed">TODO-closed</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/keeps-learning/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AndroidFramework</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AOSP</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">TaskA5-sf-patches</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">surfaceflinger patch research</span><meta itemprop="position" content="4"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：0.16.0+</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>surfaceflinger patch research</h1><ul><li><a href="#gerrit-codes">gerrit codes</a><ul><li><a href="#search-the-target-gerrit">search the target gerrit</a></li></ul></li><li><a href="#patch-1--2-analysis">patch 1 &amp; 2 analysis</a><ul><li><a href="#definition">definition</a></li><li><a href="#classification">classification</a></li><li><a href="#easy-suppress-error-problem-of-imported-gls2h">EASY: suppress <code>#error</code> problem of imported <code>gls2.h</code></a></li><li><a href="#easy-servicessurfaceflingerandroidmk">EASY: <code>services/surfaceflinger/Android.mk</code></a></li><li><a href="#pass-libsguiglconsumercpp">PASS: <code>libs/gui/GLConsumer.cpp</code></a><ul><li><a href="#variable-initialization">variable initialization</a></li></ul></li><li><a href="#servicessurfaceflingersurfaceflingercpp"><code>services/surfaceflinger/SurfaceFlinger.cpp</code></a><ul><li><a href="#part-1-initfb">part 1. initFB</a></li><li><a href="#part-2-function-of-initfb">part 2. function of <code>initFB</code></a></li><li><a href="#hard-part-3-docomposesurfaces">HARD: part 3. <code>doComposeSurfaces</code></a></li><li><a href="#drawing-flow">drawing flow</a></li><li><a href="#docomposesurfaces-code-flow">doComposeSurfaces code flow</a></li><li><a href="#rendering-client-layers">rendering client layers</a></li></ul></li></ul></li><li><a href="#%E7%BC%96%E8%AF%91">编译</a><ul><li><a href="#%E7%9B%AE%E5%89%8D%E7%AD%96%E7%95%A5">目前策略</a></li><li><a href="#%E7%9B%AE%E5%89%8D%E7%AD%96%E7%95%A5%E6%9B%B4%E6%96%B02022-01-27-151638">目前策略更新@2022-01-27 15:16:38</a></li><li><a href="#white_check_mark-error-use-of-undeclared-identifier-dirty">✅ <code>error: use of undeclared identifier &#x27;dirty&#x27;</code></a></li><li><a href="#white_check_mark-error-use-of-undeclared-identifier-displaytransform">✅ <code>error: use of undeclared identifier &#x27;displayTransform&#x27;</code></a></li><li><a href="#white_check_mark-error-unknown-type-name-transform">✅ <code>error: unknown type name &#x27;Transform&#x27;</code></a></li><li><a href="#white_check_mark-error-no-member-named-draw-in-androidlayer">✅ <code>error: no member named &#x27;draw&#x27; in &#x27;android::Layer&#x27;</code></a></li><li><a href="#white_check_mark-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine">✅ <code>error: use of undeclared identifier &#x27;mRenderEngine&#x27;; did you mean &#x27;renderEngine&#x27;?</code></a></li><li><a href="#white_check_mark-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending">✅ <code>error: too few arguments to function call, expected 5, have 3 (RenderEngine-&gt;setupLayerBlending)</code></a></li><li><a href="#white_check_mark-error-use-of-undeclared-identifier-renderarea">✅ <code>error: use of undeclared identifier &#x27;renderArea&#x27;</code></a></li><li><a href="#%E7%BB%88%E4%BA%8E%E6%88%90%E5%8A%9F%E4%BA%862022-01-27-233703">终于成功了！2022-01-27 23:37:03</a></li></ul></li><li><a href="#%E5%B9%B4%E5%89%8D%E4%B8%BB%E8%A6%81%E5%B7%A5%E4%BD%9C%E7%9B%AE%E6%A0%87">年前主要工作目标</a><ul><li><a href="#pre-check-list">pre-check list</a></li><li><a href="#core-1-list">core 1 list</a></li><li><a href="#core-2-list">core 2 list</a></li><li><a href="#core-3-list">core 3 list</a></li></ul></li><li><a href="#%E5%B9%B4%E5%89%8D%E4%B8%BB%E8%A6%81%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90">年前主要困难分析</a><ul><li><a href="#layercpp%E4%B8%AD%E5%85%B3%E4%BA%8Ewin%E5%92%8Cposition"><code>Layer.cpp</code>中关于<code>win</code>和<code>position</code></a><ul><li><a href="#%E5%8F%AF%E7%96%911-layerprepareclientcomposition">可疑1. <code>Layer::prepareClientComposition()</code></a></li><li><a href="#%E5%8F%AF%E7%96%912-inputwindowinfo-layerfillinputinfo">可疑2. <code>InputWindowInfo Layer::fillInputInfo()</code></a></li><li><a href="#position%E4%BC%BC%E4%B9%8E%E6%B2%A1%E6%9C%89%E8%A2%AB%E8%B0%83%E7%94%A8%E7%9A%84%E5%9B%B0%E6%83%91">position似乎没有被调用的困惑</a></li></ul></li><li><a href="#surfaceflingercpp%E4%B8%AD%E5%85%B3%E4%BA%8E-docomposesurfaces"><code>surfaceflinger.cpp</code>中关于 <code>doComposeSurfaces</code></a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gerrit-codes">gerrit codes<a class="hash-link" href="#gerrit-codes" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="search-the-target-gerrit">search the target gerrit<a class="hash-link" href="#search-the-target-gerrit" title="标题的直接链接">​</a></h3><p>search: <code>status:merged project:oneos/platform/frameworks/native branch:project-dev</code></p><p>url: <a href="http://192.168.0.241:8080/#/q/status:merged+project:oneos/platform/frameworks/native+branch:project-dev" target="_blank" rel="noopener noreferrer">http://192.168.0.241:8080/#/q/status:merged+project:oneos/platform/frameworks/native+branch:project-dev</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="patch-1--2-analysis">patch 1 &amp; 2 analysis<a class="hash-link" href="#patch-1--2-analysis" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="definition">definition<a class="hash-link" href="#definition" title="标题的直接链接">​</a></h3><p><code>p1</code> 指 patch 1，即 <code>merge from rk3399</code></p><p><code>p2</code> 指 patch 2，即 <code>feature vr 2d mode</code></p><p>p2 基于 p1，中间还有其他一个commit，不过貌似和p2无关，不构成依赖关系。</p><p>目前基于<code>combinediff</code>将<code>p1</code>与<code>p2</code>合并也是没有问题，不报错的。</p><p>p1改动涉及到60个左右的文件，主要作用是aosp向rk的适配（大致作用肯定是这个，具体场景等不清楚），而p2改动涉及9个，使支持了vr模式的功能。</p><p>p1和p2之间有几个文件是重合的，也就是先后改动的，因此要想直接打patch 2，需要对patch 1中相关的文件进行分析，理出专属于p2的改动的极小集。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="classification">classification<a class="hash-link" href="#classification" title="标题的直接链接">​</a></h3><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Both in p1, p2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] libs/gui/GLConsumer.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/Android.mk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/Layer.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/Layer.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/SurfaceFlinger.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/SurfaceFlinger.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Added in p2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] libs/gui/include/gui/ISurfaceComposerClient.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/HmdType6DistortionMesh.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [ ] services/surfaceflinger/HmdType6DistortionMesh.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这些文件大概可以分成以下几组，并分批分析完成。</p><ol><li>编译部分：<code>Android.mk</code>，很简单，p1不用考虑，直接考虑在p2中加一个cpp即可。</li><li>不用考虑但两部分都有的文件：<code>GLConsumer.cpp</code>，这个文件经过分析，没有必要动。</li><li>不用动脑的核心文件:<code>ISurfaceComposerClient.h</code>，这个文件主要是定义了一个vr变量，供<code>surfaceflinger</code>使用，所以很简单。</li><li>不用修改的两个核心文件：<code>HmdType6DistortionMesh.cpp|h</code>，这两个文件基本可以写死，而且是基于算法自动生成的，所以也不需要手改。</li><li>需要看但不难的两个核心文件：<code>Layer.cpp|h</code>，这两个文件要看一下。</li><li>需要看最难的两个核心文件：<code>surfaceflinger.cpp|h</code>，重点分析！</li><li>其它只在p1中动的文件，我们可以暂时先不看，如果接下来编译有用到的，再加！</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="easy-suppress-error-problem-of-imported-gls2h">EASY: suppress <code>#error</code> problem of imported <code>gls2.h</code><a class="hash-link" href="#easy-suppress-error-problem-of-imported-gls2h" title="标题的直接链接">​</a></h3><blockquote><p>⚠️ 不注释这个就编不过去，luci用的旧版依赖，或者单纯地不该把它们导入到 <code>surfaceflinger.cpp / Layer.cpp</code>内</p></blockquote><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sed  -E &quot;s|(#error.*gl2)|//\1|p&quot; services/surfaceflinger/Layer.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed  -E &quot;s|(#error.*gl2)|//\1|p&quot; services/surfaceflinger/SurfaceFlinger.cpp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="easy-servicessurfaceflingerandroidmk">EASY: <code>services/surfaceflinger/Android.mk</code><a class="hash-link" href="#easy-servicessurfaceflingerandroidmk" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643106263791-f437ddb26e9cb79f654853b88a29b64f8d9f9de30885faa31bb710648a3556f0.png" alt="picture 41" class="img_ev3q">  </p><p>p1关于mk部分，最大的篇幅是<code>rockchip support</code>，我们也可以直接跳过，看了也没用，目标是高通的。（如果后期实在要对这部分，那就认了吧）</p><p>除此之外，就是加了<code>rk</code>专用的<code>librga</code>依赖，这个高通也用不着。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643106525915-0556ab703bde3abacaa1c349aaae854f0ca887e0fe95340acee86a82caa20a8c.png" alt="picture 42" class="img_ev3q">  </p><p>p1就是这么些改动，所以实际上对项目没有任何帮助。</p><p>p2则加了一个<code>HmdType6DistortionMesh.cpp</code>的依赖，就是我们自己的那个。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643106603903-23b4912d18a8053a444b0b247f94e5c560891a0ee252b35e2bb87f5352874967.png" alt="picture 43" class="img_ev3q">  </p><p>在原生8的<code>Android.mk</code>中，它其实就是加在<code>LOCAL_SRC_FILES</code>里的。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643109587318-b2da803315284f3547262e9706ab1bb73a568cc72e647c18d114e3a065da522f.png" alt="picture 44" class="img_ev3q">  </p><p>尽管8已经有<code>Android.bp</code>了，但其实还没正式开始用（TODO: 具体区别待查）。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643116633259-574c82039d43cc89a3a7a9a9f2a1266bacc4274b22a481e9d3e0dde6e44f5474.png" alt="picture 46" class="img_ev3q">  </p><p>所以要把加cpp的动作改到11的<code>bp</code>中去。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643109875995-7539232556a1fa87e9ffb6910c80c63c2a7b31833dd97cc814efcd6816b7cbe6.png" alt="picture 45" class="img_ev3q">  </p><p>根据检索，实际上就是要加在<code>filegroup.srcs</code>下（和<code>Layer.cpp | FrameTracker.cpp</code>一起）。</p><p>命令可如下：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># mac sed -&gt; gsed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># :warning: alias need to work in next commands</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ $(uname) == Darwin ]]; then alias sed=gsed; fi;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在surfaceflinger/Android.bp内加入私有实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SRC=&quot;HmdType6DistortionMesh.cpp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T=&#x27;&quot;&#x27;$SRC&#x27;&quot;, // mark added at &#x27;$(date +%Y-%m-%d\ %H:%M:%S)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">F=&quot;services/surfaceflinger/Android.bp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P=&#x27;&quot;Layer.cpp&quot;,&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if grep $SRC $F;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">then echo &quot;found&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else echo &quot;not found&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $T | sed &#x27;s|^.*$|s_^(.*?)(&#x27;$P&#x27;.*)$_\\1\\2\\n\\1\0_|&#x27; | sed -i.bak -E -f- $F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pass-libsguiglconsumercpp">PASS: <code>libs/gui/GLConsumer.cpp</code><a class="hash-link" href="#pass-libsguiglconsumercpp" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643103121263-7460c1d919e7a11e5e65830708304f8a20cc09bd6175822271cd62deeef3c31f.png" alt="picture 34" class="img_ev3q">  </p><p>在<code>GLConsumer.cpp</code>中，p1主要是加了一个<strong>对齐函数</strong>：</p><p>cpp++
bufferWidth = (cropRect.width() + 31) &amp; (~31);</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">具体可以看我和chen姐的请教记录：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 35](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104031704-cdeb8648205dc69ec4352cbda34fa9718f611cdf5b5e08c046e0d3ed1927bad0.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 36](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104038721-0c2f2634d5070f0493f786e6a96626cf5d376545c8703d566149d21bc1d78dcc.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 37](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104043233-a06964a558bbe6829684e3032f2f2a5b2efc439c70004fccb88b6a3a2e8c021a.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，实际上 p1只是一个小小的性能优化，对于业务来说，应该影响不大，不过确实是值得关注的一个改动，得去11上看看。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而11看的结果就是，完全没有这回事！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 38](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104398250-911dad0fe36ae180059835431f11e15d4e6150e50ab7806f75daea4506b345b8.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，我们也不用管这个函数了！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">接着是p2中的改动，坦白说，我没懂他改动的意义。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 1](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643032866621-9dd0251e560a24ddc5d1b91d91d8bbb013d2da3597a4887bca852187fcf2a09b.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在原来的逻辑中，有一个静态变量`sReleasedTexImageBuffer`初始化为空，然后接收buffer数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这是一个初始化设计，注意注释：`// The first time, create the debug texture in case the application continues to use it.`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">但后来的逻辑中，却把这个初始化判断给去掉了，于是乎每次都会新生成一个buffer（显然，这个效率会大大降低）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在另一个官方diff：[Diff - 9870c9b^! - platform/frameworks/native - Git at Google](https://android.googlesource.com/platform/frameworks/native/+/9870c9b%5E!/) 中（不知道是哪个版本对哪个版本），很清晰地将原先的获得`mReleasedTexImageBuffer`改成了获得`getDebugTexImageBuffer()`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 2](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643033403953-02c9e6213fd5519490cd23b29c05719ee9531b24ed9e97bf2ad9435991334eea.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">基于此，有理由判定，这里的改动只是一个`debug/release`或初始化相关的区别，对目前的vr集成目标可能没有什么影响，只不过令人困惑的是，它的改动似乎与官方的改动有些相近，却又不完全一样，不知到底是版本升级的问题还是啥（比如说使用debug的版本是8，而源代码版本是7，于是为了将7的部分升级成8，就用了这种改动办法，仅仅是一种猜测，很有可能不对）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">具体见我和晓研哥的讨论：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 40](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104628305-66437969f15d8a23eb8f491d7e2d8c0e8839c24a0c7238396fe1df0317abcbf1.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check了一下11中的代码，也是没变的：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 39](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104552627-777845363dfb2d005d2c5e6aa9b3869987fcc1fec7a8e7880b5ac6ec54090c86.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以p2的改动也忽视！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ref:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 完整的实现：[libs/gui/GLConsumer.cpp - platform/frameworks/native - Git at Google](https://android.googlesource.com/platform/frameworks/native/+/master/libs/gui/GLConsumer.cpp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### EASY: `services/surfaceflinger/Layer.h`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; :sparkles: 见识到`对比浏览分析(line in side)`的强大了吧！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 51](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643132425592-dc09daee4b9581cabb5142d14c3cee28a9714568f336451ac657a3609793a513.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">可以看到，在 `Layer.h` 中，p1里基本都是定义的和 rk 相关的变量和函数，虽然有一个 `RK_VR` 的变量和逻辑处理很吸引注意力，但是询问了晓研得到的回复都是明确的不用看。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 52](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643132607551-8c8e22178f1d4f0ad220e613f209239047cef5fea7b0c5f6ec0b4217acda5427.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">而 p2 很简单，就是加入了vr的变量标识，并提供了`get | set`的方法。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 14](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643041501426-002bd50f36a307ff05a627d558984c31d8ce0877b03b6bb2b21fcc2264c88963.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### `services/surfaceflinger/Layer.cpp`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### HARD: `win.right = hw-&gt;getWidth();`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 53](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643133906128-eaaf0240b6d8e31bda6fcaf21527e860a64303c889e1a90f8966e45f0e5de36e.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不出意外，p1中有大量和RK相关的定义与实现，篇幅很长，目测主要实现了`RK_VR`和`RK_STEREO`两个模式，但根据晓研指示，都不用看，这样的话，就实际上等于p1没改啥了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">唯一改的影响到p2的应该是这个`win`，它把原先的`ComputeBounds`改成了`FloatRectBounds`，估计是为了更精确的实现旋转、VR等变换的意思吧。但对p2的接口却是可以不变的，目测来看。也就是以下代码几乎可以照抄。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpp++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(mIsVr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        win.right = hw-&gt;getWidth();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而它的下方就是</p><p>cpp++
float left   = float(win.left)   / float(s.active.w);
float top    = float(win.top)    / float(s.active.h);
float right  = float(win.right)  / float(s.active.w);</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~~可以基于这个写sed脚本。~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而，这个想法失败了，8到11变得太大了，已经搜不到 ` float left   = float(win.left)   / float(s.active.w);` 这个了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 54](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643134635239-1d6f9de87874186699deb6ed33071fb79b0389f60e8dab41332727b8da9010e8.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以得定位到出处。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 55](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643137004483-5b3b4140ab77de72ef4a5b848121194f6d2102e27c2fe23e84823f184ad2f7b8.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 `drawWithOpenGL` 函数中，它接收的第一个参数是`hw`，类型是`DisplayDevice`，紧接着开始创建`Rect`类型的`win`变量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">改动就是在这里进行的，一旦检测到是vr模式，就让这个`win`变量的宽度修改为`hw`的宽度：`win.right = hw-&gt;getWidth()`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这里我们得知道这个`computeBounds()`构造函数是咋回事。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 56](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643137518943-d8297585f5c0fa99e05666d3eaeb3a8e87e544c55deb73dd390d224ab758b3c9.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">还好，8和11在这里的区别不是很大，只不过`computeBounds`名字改成了`getBounds`，内部实现也相应地更简洁了一些，核心思想就是窗口区域减去透明区域，得到的就是所谓`Rect`，也就是实际区域吧。~~至于结构体是啥，四个坐标吗，还是啥，应该倒也不是那么重要。~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不过这样，回到前面那个函数：`win.right = hw-&gt;getWidth`就有点怪了，`hw`和`getBounds()`之间又是什么关系呢。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TODO: 我这里其实主要困惑的在于，如果`win`是指那个活动窗口，比如说某个浮动窗口，那在vr模式下单独改其`right`为`hw`的宽度，而不把`left`改成0，这是否会有问题呢？至少看起来不是那么对称，所以这里在原理上来说，是一个非常大的困惑。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">还是，先看看如何在11中实现这个修改吧。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### 可疑1. `Layer::prepareClientComposition()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 58](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138949603-bd8010805a1b2d7274c9adf4c6c21c43c549711742aadeb94d21c388e1468ca7.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在这块里，最大的可疑原因是正好与左边8的版本对齐，并且函数名就是在画图：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 59](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139039422-45fe81e61a85a9a61de7d2d34b40023143d959a149be023b1f89ef875e73a6eb.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">另外也有一个关键赋值语句：`layerSettings.geometry.boundaries = bounds;`，我们若在赋值之前，修改`bounds.right`为`hw.getWidth()`，或许就和8对齐了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">只不过最大的问题是，这个函数不接收`hw`的参数……，所以，很可能，不是我们相要的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">但我又找了一下`hw`的类`DeviceDisplay`，发现这个文件里很少用：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 60](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139341595-57becab0aa04cd092d41f5176b3f5afd575609567c75524f460af9e009e9996e.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">并且 `hw-&gt;`的调用也是一个都没。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### 可疑2. `InputWindowInfo Layer::fillInputInfo()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 57](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138409793-047823adc1fbf5db5d36fc05a824d31ff9e81110a4ce1a4ef69833d217f0c026.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我基于`getBounds`函数追到这块（可疑1也有`getBounds`），发现代码结构就比较像目标代码。尤其是`x|ySurfaceInset`的构造与使用，可以看到`xSurfaceInset`也用到了`layerBounds.getWidth()`函数，并且后续还有一句`layerBounds.inset(xSurfaceInset, ySurfaceInset, xSurfaceInset, ySurfaceInset);`看起来仿佛在构造两个眼镜的某些参数一样。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### MID: `position`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 61](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139564016-37973fb37dbac73e4fa89c3e2d7fb127e1415c0699dc370f39de3ffd47749d10.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">分析了`win`后，下面的一个问题就是关于`position`的，然而光从这段来看的话，似乎没有起到任何作用，仅仅是一个赋值，所以不太懂这个设计。如果这是个全局变量，我还比较明白，说明`position[2]`可能是左眼右边点，而`position[3]`是右眼左边点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### EASY: `libs/gui/include/gui/ISurfaceComposerClient.h`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 3](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643033846337-6802e52cc14b9224fef4725b5669c87755209b419956bd021bf4d9964743f521.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">该文件中，只增加了一个`eVrWindow`的变量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">而它其实只是在`surfaceflinger.cpp`中用于判断是否是`vr`模式，这个比较简单直白。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 4](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643034044680-f14735982c660c54119d8c30ba2c493318c839a4dcc947981240d04b555f4b70.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### MID: `services/surfaceflinger/HmdType6DistortionMesh.h`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这个文件也是新增的，和 [[3/9, MID] `services/surfaceflinger/HmdType6DistortionMesh.cpp`](#39-mid-servicessurfaceflingerHmdType6DistortionMeshcpp) 配套，是其头文件定义，需要仔细分析一下。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其中&#x27;DistortionCorrection tool&#x27; 可以生成mesh矩阵，目前这个sdk后续需要的话还要再找晓研看看。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 9](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643040148049-06f4be1b8f9329cbd382b432af2ed50f60d1f2570370536de4095854cbd4c8f0.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">大致理解了一下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. ~~`#define HMD_TYPE6_DM_VERTCOUNT 10201` 应该就是宽度像素`1020`乘以10再加一，也就是每个像素点有10个`vert`，应该是指`vertex`顶点的意思~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. `HMD_TYPE6_DM_WIDTH/HEIGHT`代表一个mesh的宽与高，长度都是100，也就是有101个顶点，所以一个mesh就有`HMD_TYPE6_DM_VERTCOUNT = 101 * 101 = 10201`个顶点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. `#define HMD_TYPE6_DM_IDXCOUNT  (HMD_TYPE6_DM_WIDTH * HMD_TYPE6_DM_HEIGHT * 3 * 2)` ：两个三角形，每个三角形三个顶点，`IDXCOUNT`就是总索引数的意思</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. `#define HMD_TYPE6_DM_ELEMCOUNT (HMD_TYPE6_DM_VERTCOUNT * 4)` 每个`vert`应该有4个维度的数据，`x y u v` 或者 `a b c d`，可以看做是结构体内最小单元的总个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. `#define HMD_TYPE6_DM_SIZE (HMD_TYPE6_DM_ELEMCOUNT * sizeof(float))` 所有顶点的存储空间大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. `#define HMD_TYPE6_DM_K0~5` 六个参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### EASY: `services/surfaceflinger/HmdType6DistortionMesh.cpp`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 5](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643036038107-6f5bfa4f08a73c080083d6658e6c99c07bda32e73215ff0da0cc550426c67150.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">该文件属于新增，内容是基于程序自动生成的，不过生成脚本也是老SDK了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 6](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643036091354-24e7e13ad10eeb2616e356fc5fb3c324683ec92e9c6fc0347b611ebe179a5fbb.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### MID: `services/surfaceflinger/SurfaceFlinger.h`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 62](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643141116414-687d66c090a80e5605ccb2195b6f58e78cb17670744a61c5488e8aae8e1f495c.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p1里面全是和RK相关的，没啥好看的，直接看p2。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 16](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643042375823-7b1c802f21be285ac5167118355b488311204fe26cfb06c306d771a612851110.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p2里主要是定义了8个变量和1个初始化函数。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其中4个变量都是mesh，两个（`mLeftEyeMesh | mRightEyeMesh`）是vr模式下的左右眼mesh，两个（`mLMesh | mRMesh`）应该是正常情况下的左右眼mesh。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`mDistortionEnabled`控制是否启用反畸变。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`mFrameBuffer | mTextureName | mTexture` 应该都是为 `initFB` 函数服务的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">现在，我们要追踪一下，这几个包的导入问题，因为API变动很大。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首先是`Mesh.h`和`Texture.h`，原先在8中是在`surfaceflinger/RenderEngine`下，11则换了地方：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  native git:(b8293fd0e0) ✗ find . -name &quot;Mesh.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./libs/renderengine/include/renderengine/Mesh.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  native git:(b8293fd0e0) ✗ find . -name &quot;Texture.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./libs/renderengine/include/renderengine/Texture.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>追过去。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643141519785-f873abee7c470d96e142c3aa5364827a8a82bb4123ea6c6eaa34c801dc63c45d.png" alt="picture 63" class="img_ev3q">  </p><p>可以看到，在8的<code>surfaceflinger.cpp</code>中需要的两个函数<code>getPositionArray()</code>和<code>getTexCoordArray()</code>都在，这说明api接口没变，只是位置变了，那就比较好说。基于此，<code>Texture.h</code>的调用部分暂时就不看了，应该比较稳妥。</p><p>update at 2022-01-27: NO! 编译到10后发现有各种问题，主要是语法层面的，后来发现，接口还是有一些变化。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643256750858-a6fc4675727af6e51e1500700eaec2cd7d3be2feaae48ba2dac19424d599e11c.png" alt="picture 89" class="img_ev3q">  </p><p>首先，如上，命名空间有变化，原来是<code>android::Mesh</code>，现在变成<code>android::renderengine::Mesh</code>了。</p><p><code>gl2.h</code>和<code>gl2ext.h</code>的位置不太一样，在另一个模块下：</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">➜  native git:(b8293fd0e0) ✗ find . -name &quot;gl2.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./opengl/include/GLES2/gl2.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  native git:(b8293fd0e0) ✗ find . -name &quot;gl2ext.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./opengl/include/GLES2/gl2ext.h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但本质还是一样的，所以这部分代码应该就比较好写了。具体来说，就是把<code>RenderEngine</code>改成<code>renderengine</code>其它照抄。前缀应该不用加了，因为<code>include</code>下应该会有环境变量，自动能搜索到。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="variable-initialization">variable initialization<a class="hash-link" href="#variable-initialization" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643184157839-37d1c335d7b499ec969a1e6772e7ca1b23cdab2daabb0f64366f3ee2c80a56af.png" alt="picture 74" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643184227668-9c72ba2d4ab05453921ad65bca9735089fc63a0966706c0883373601e8476b1b.png" alt="picture 75" class="img_ev3q">  </p><p>对比来看，确定把初始化变量写在位置5即可。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="servicessurfaceflingersurfaceflingercpp"><code>services/surfaceflinger/SurfaceFlinger.cpp</code><a class="hash-link" href="#servicessurfaceflingersurfaceflingercpp" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643142332055-4ad345818863122d35aca8a353f315178b086666c831a3fefd0e32257b294f1d.png" alt="picture 64" class="img_ev3q">  </p><p><code>surfaceflinger.cpp</code>的p1里对旋转做了较多的考虑，并且还包括一点非RK属性的修改，好在我们目前也不用旋转，所以p1对于我们来说依旧可以忽视。</p><p>接下来重点看p2。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="part-1-initfb">part 1. initFB<a class="hash-link" href="#part-1-initfb" title="标题的直接链接">​</a></h4><blockquote><p>⚠️ 编译顺序有问题。思路，对标8里面的一些初始化变量，在11中找对应的新的构造方式。</p></blockquote><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643042777978-417faf89b357d77feae1fa777d737459a5d70a6214656aba3790a419963e4898.png" alt="picture 17" class="img_ev3q">  </p><p>初始化过程中，可以看到，<code>mLeftEyeMesh/mRightEyeMesh</code>和<code>mLMesh/mRMesh</code>的初始化参数是不一样的，为啥这么初始化，目前还没有形象认识。</p><p>⚠️ 这段中写了一些比较关键的系统参数，是我们需要去验证核实的，值得引起注意：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## /system/build.prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persist.sys.framebuffer.main=1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># HDMI display:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys.hwc.device.primary=HDMI</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">A </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># VRG:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys.hwc.device.primary=DP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而他说<code>uint32_t width = 1920; // half of display size</code>，说明宽度都是按照3840来算的。</p><p>然后就是对标10版本。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643185687929-684a3a046f2ee223d226408e6c157616274f8c54702ac4feb37374240d8818de.png" alt="picture 76" class="img_ev3q">  </p><p>10里面虽然加了<code>Factory</code>的初始化方式，但其实只是其中一个属性，注意看<code>mFactory</code>的前缀<code>m</code>与其他的<code>mXXX</code>是等价的，而我们要加的变量正是<code>mXXX</code>类型，所以就可以不用管<code>mFactory</code>里面是什么，因为是同级的。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="part-2-function-of-initfb">part 2. function of <code>initFB</code><a class="hash-link" href="#part-2-function-of-initfb" title="标题的直接链接">​</a></h4><p>⚠️ 目测 <code>initFB</code> 函数绝大部分都不需要改，不过有一个系统属性 <code>vr.luci.distortion.enable</code> 值得注意，会基于这个决定是否启用反畸变。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643045333549-7ac057aaa61ddf8c4e60350e3789827e11e3bee1b3a21781326ec0399fcec2a5.png" alt="picture 19" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643045571855-3c6ce4abe57b1c9aef7c01beffec3e8f4422b45c0e980bd444f28dfcafd8099b.png" alt="picture 20" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hard-part-3-docomposesurfaces">HARD: part 3. <code>doComposeSurfaces</code><a class="hash-link" href="#hard-part-3-docomposesurfaces" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144378837-b02055303c54561f2c6769b85e61e9213186d752c210af0d1d507899a61f690a.png" alt="picture 65" class="img_ev3q">  </p><p>很惨啊，8里面的接口直接被剥了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144504135-08af60009b0a7f5dfecaf1b01b1d718be6b7aefaed131e72e18aa2a3a0e33496.png" alt="picture 66" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144692166-10a3bf592b15344ddcc3939b5f372ccde6f8ca9d275aaee1f53c1a12e2e47478.png" alt="picture 67" class="img_ev3q">  </p><p>太惨了！正好是10-&gt;11接口被剥了！</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643145769167-82f36a6b3eb301404a04d6cbdb6ece0c9751161413fa7882fad10c07da2661ce.png" alt="picture 68" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="drawing-flow">drawing flow<a class="hash-link" href="#drawing-flow" title="标题的直接链接">​</a></h4><p>ref: <a href="https://waynewolf.github.io/2014/06/22/surfaceflinger-and-client/" target="_blank" rel="noopener noreferrer">https://waynewolf.github.io/2014/06/22/surfaceflinger-and-client/</a></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">handleMessageRefresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; preComposition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; rebuildLayerStacks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; setUpHWComposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; HWComposer::createWorkList &lt;== hwc=&quot;&quot; structures=&quot;&quot; are=&quot;&quot; allocated=&quot;&quot; |—=&quot;&quot;&gt; Layer::setGeometry()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—  set per frame data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—  HWComposer::prepare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; hwc prepare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; doComposition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |---- skip composition on external display if condition meets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; doDisplayComposition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |    |—&gt; doComposeSurfaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |     |—&gt; DisplayDevice::swapBuffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |          |—&gt; eglSwapBuffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |          |—&gt; FramebufferSurface::advanceFrame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; DisplayDevice::flip(…)     &lt;== just=&quot;&quot; update=&quot;&quot; statistics=&quot;&quot; count=&quot;&quot; |--=&quot;&quot;&gt; Call DisplayDevice::compositionComplete(), notify each display</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |--&gt; DisplaySurface::compositionComplete()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |--&gt; FramebufferSurface::compositionComplete()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |--&gt; HWComposer::fbCompositionComplete()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              |--&gt; NoOP if HWC &gt;= 1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              |--&gt; used only in framebuffer device case.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; postFrameBuffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; HWComposer::commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |—&gt; hwc set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |—&gt; update retireFenceFd of hwc_display_contents_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; DisplayDevice::onSwapBuffersCompleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |—&gt; FramebufferSurface::onFrameComitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; Layer::onLayerDisplayed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—   update some statistics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; postComposition </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ref: <a href="https://zhuanlan.zhihu.com/p/127324424" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/127324424</a></p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643146727064-cfab15ef79d008d64d5c5c29bb93680cfbfe470563fb4a9b1fac82a572690c18.png" alt="picture 69" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="docomposesurfaces-code-flow">doComposeSurfaces code flow<a class="hash-link" href="#docomposesurfaces-code-flow" title="标题的直接链接">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">handleMessageRefresh -&gt; doComposition -&gt; doDisplayComposition -&gt; doComposeSurfaces</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Preparation work:<ul><li>If GLES and hwc compositing, clear frame buffer target first</li><li>If GLES only, drawWarmHole first</li></ul></li><li>Render layers to framebuffer<ul><li>For all layers if using hwc<ul><li>do nothing if HWC_OVERLAY layer, display hardware will blend the layer</li><li>render with opengl if HWC_FRAMEBUFFER layer, call layer-&gt;draw()</li><li>set the layer’s acquireFence</li></ul></li><li>For all layers if no hwc<ul><li>just render with OpenGL, call layer-&gt;draw()</li></ul></li></ul></li><li>Now all the GLES layers are drawn on frame buffer target, waiting to swapBuffers</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rendering-client-layers">rendering client layers<a class="hash-link" href="#rendering-client-layers" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643150328404-b6176d87255273165579bfd2a35670f914000f9426a8818582fe30c9af7a333b.png" alt="picture 70" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编译">编译<a class="hash-link" href="#编译" title="标题的直接链接">​</a></h2><p>在把第二个patch的所有内容都打进AOSP 10后进行编译，发现了新的错误，有些变量没有，这说明某些是在p1里定义的。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643259309065-400df4bbf3122953663fc51c354aedddc86e1c4e6c9bfedcc83b70fd1108c903.png" alt="picture 90" class="img_ev3q">  </p><p>这就麻烦了……</p><p>又是漫长的找变量过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="目前策略">目前策略<a class="hash-link" href="#目前策略" title="标题的直接链接">​</a></h3><p>将在ubuntu机上所有的commit保存成新的patch，打回主机n10环境，再与n8进行对比</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="目前策略更新2022-01-27-151638">目前策略更新@2022-01-27 15:16:38<a class="hash-link" href="#目前策略更新2022-01-27-151638" title="标题的直接链接">​</a></h3><p>考虑到有很多版本问题一一要修复，所以采用git方式单独对surfaceflinger进行控制管理，但是之前由于把西瓜的 <code>hmdservice</code> 加进来在<code>native</code>级别一下<code>add</code>了，导致git脏了。</p><p>所以现在，拷贝了一份当前的 <code>surfaceflinger</code>（无git版本），然后重新拉一份<code>surfaceflinger</code>，接着<code>git init</code>，再把原来的 <code>surfaceflinger</code>拷贝回来，再用<code>git commit</code>进行更新，这样就有<code>git history</code>了，可以用于生成纯净的patch。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-use-of-undeclared-identifier-dirty">✅ <code>error: use of undeclared identifier &#x27;dirty&#x27;</code><a class="hash-link" href="#-error-use-of-undeclared-identifier-dirty" title="标题的直接链接">​</a></h3><p>problem:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270250699-1c9b572414150473871cc166d63ffc1f9db000bc70832683ff679bc566a8e739.png" alt="picture 94" class="img_ev3q">  </p><p>analysis:</p><p>虽然位置对了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643260910516-4abaab424f67566d72adcc7e9abbb2b307cb061d87d4a36d150f189c45242253.png" alt="picture 91" class="img_ev3q">  </p><p>但其实10里面换名字了……</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643260957409-fa660a0b04134b6438e205e23cd65c20fb141bd3165cb11f1609294f2c26fee5.png" alt="picture 92" class="img_ev3q">  </p><p>resolution:</p><p>change <code>dirty.in</code> to be <code>debugRegion.in</code>, then fixed.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270380057-954041c435c5766e2a9246e7117a4a459a521f5a79a7a79f2303fd5285f851fd.png" alt="picture 95" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-use-of-undeclared-identifier-displaytransform">✅ <code>error: use of undeclared identifier &#x27;displayTransform&#x27;</code><a class="hash-link" href="#-error-use-of-undeclared-identifier-displaytransform" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643261575586-cfca4d2780992850c4e04abea21bf5408be3b635015dce9579b570189ec50702.png" alt="picture 93" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-unknown-type-name-transform">✅ <code>error: unknown type name &#x27;Transform&#x27;</code><a class="hash-link" href="#-error-unknown-type-name-transform" title="标题的直接链接">​</a></h3><p>reason:</p><p>when added <code>displayTransform</code> line, then introduces <code>Transform</code> which is not imported.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270733917-88cfbcc1133a098b2826d05c30e3b39d6d8ee14d7cb0b5a8f0638d9d17e8aa81.png" alt="picture 96" class="img_ev3q">  </p><p>analysis:</p><p>the <code>Transform</code> is defined at: <code>ui/</code>:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270989945-25cc87f8ab8ed0edcbb29ff230e4bae7ceac528caedc5e2d5f6c6a3a58ad77d6.png" alt="picture 98" class="img_ev3q">  </p><p>and the raw 10 used a <code>ui</code> prefix both in <code>.h</code> and in <code>.cpp</code></p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643271063371-bfa7569154cf91f89dc21bd4e5721d8c3147664285e4452d12f86b057ed18eee.png" alt="picture 99" class="img_ev3q">  </p><p><del>so we need manually add a <code>ui</code> namespace or add <code>ui</code> prefix when we use <code>Transform</code> variable.</del></p><p>So it&#x27;s not wise to add a <code>ui</code> namespace in case of introducing conflict or affecting efficiency.</p><p>It&#x27;s better for us to manually add <code>ui</code> prefix when we use the <code>Transform</code> variable.</p><p>resolution:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643271284098-f4a1b2cdf2424fa314a06bbed114872856c668e162db1bb0e1c45e39c6f9b599.png" alt="picture 100" class="img_ev3q">  </p><p>ok:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643271321290-c49b3cbb94321e9e2238ea90e0f40f39820261a82ae79eedafb2333871fb9508.png" alt="picture 101" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-no-member-named-draw-in-androidlayer">✅ <code>error: no member named &#x27;draw&#x27; in &#x27;android::Layer&#x27;</code><a class="hash-link" href="#-error-no-member-named-draw-in-androidlayer" title="标题的直接链接">​</a></h3><p>analysis:</p><p>simulate what AOSP 10 is doing when 8 is <code>draw</code>ing.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279221765-a1e4058d1e04f5d37f0a516a93209ef3d1b3ddba7f55fc4f7900eee0d1918d3a.png" alt="picture 103" class="img_ev3q">  </p><p>It can be seen that the <code>draw</code> becomes a more sophisticated <code>prepare-xxx</code>, just copy it now!</p><p>resolution:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279430687-975f38e5baea3c7fb28b39f497903ea1adff155bd30ee69226c9fed65ff8bb3a.png" alt="picture 106" class="img_ev3q">  </p><p>ok:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279186528-7be5d583cf681cd2e1ea09285900e3a16d75fa3d886125fbe68bc8922e2a823f.png" alt="picture 102" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine">✅ <code>error: use of undeclared identifier &#x27;mRenderEngine&#x27;; did you mean &#x27;renderEngine&#x27;?</code><a class="hash-link" href="#-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine" title="标题的直接链接">​</a></h3><p>problem:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279394094-1e450fe68afcb37d5e44a2828b89e1c3990fc7ab9377dc988e62fa8ff5b2c0e7.png" alt="picture 105" class="img_ev3q">  </p><p>reason:</p><p>not initialized (even not defined in <code>.h</code> ?):</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279496721-63842bc08930f43fc784d44b88fce06f6d98587154b89a735c93b057c5c253d2.png" alt="picture 107" class="img_ev3q">  </p><p>do not exist exactly in <code>.h</code> !</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279565516-6244202abc3f4d78c323b4c8f1020c9e4cbe196f7d4834eee0b32fbb9fa30657.png" alt="picture 108" class="img_ev3q">  </p><p>resolution:</p><p>just add it !</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279898807-928c19aec2a62ffc35659af4183e664b9a33be7d8e4aa0e9ffcf9f0e17aa227e.png" alt="picture 109" class="img_ev3q">  </p><p>ok:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279913238-cf52cc95e317162963545b1a547daa9dbf7b4890f7555e5f532fd24026886d8f.png" alt="picture 111" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending">✅ <code>error: too few arguments to function call, expected 5, have 3 (RenderEngine-&gt;setupLayerBlending)</code><a class="hash-link" href="#-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending" title="标题的直接链接">​</a></h3><p>reason: the api changes.</p><p><code>setupLayerBlending</code> 的新接口里取消掉了 <code>alpha</code> （这个倒觉得无所谓），但是新增了 <code>disableTexture</code>, <code>color</code>, <code>cornerRadius</code></p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643292858686-1f7a4757e6e3e83dde525b484a6bd5db04a64037f9a973c164f047b8d1a367b4.png" alt="picture 117" class="img_ev3q">  </p><p>analysis:</p><p>We can learn from this:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643292958805-09c2701d0625b1dfbd79c9f850e2f4d6283d58523ae82b34c0a383d463b708d2.png" alt="picture 118" class="img_ev3q">  </p><p>And the <code>color</code> and <code>radius</code> is derived from <code>layer</code></p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643292986311-2e4418c71630b84636051ef3671cf04d57ba17dd3b2b4b1c5db9faf3c56e468d.png" alt="picture 119" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293004105-7710cb8c71467925ad086b641ab0924796c179471cc9f608852d6088b67e7b8d.png" alt="picture 120" class="img_ev3q">  </p><p>Except the <code>mTexture</code> is alone:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293026912-63f585a4bc133f40b0e1a2135a6e8934a605ac2e788817a3d18f245329baf253.png" alt="picture 121" class="img_ev3q">  </p><p>ok:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293040926-f04cffcb41fe54e5f505f75826d5e60a17ceeb3226514f031e379afb4e1272d0.png" alt="picture 122" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-error-use-of-undeclared-identifier-renderarea">✅ <code>error: use of undeclared identifier &#x27;renderArea&#x27;</code><a class="hash-link" href="#-error-use-of-undeclared-identifier-renderarea" title="标题的直接链接">​</a></h3><p>reason:</p><p>It&#x27;s caused by my change the <code>draw</code> to be <code>prepareLayer</code> in where there is no layers.</p><p>resolution:</p><p>Now we just commented them, since it&#x27;s possible that they are not that important and annoying to simulate a <code>draw</code> function using <code>setupLayerBlending</code>.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293414679-afb2a4aa3891330597ff734e28f65e82963a1ec415b50c0fa7e64dce8b9f4fca.png" alt="picture 123" class="img_ev3q">  </p><p>ok / bonjour:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643297485831-621052ab16b1695fa050b8d0c4ebd6c8b18fcf3ca52cb65ffadc0c730dec3379.png" alt="picture 124" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="终于成功了2022-01-27-233703">终于成功了！2022-01-27 23:37:03<a class="hash-link" href="#终于成功了2022-01-27-233703" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643297534048-7dc15ff720dd39a7cf6577f3c9cc7e09e479b79e480b590062851a4ff29952b0.png" alt="picture 125" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="年前主要工作目标">年前主要工作目标<a class="hash-link" href="#年前主要工作目标" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pre-check-list">pre-check list<a class="hash-link" href="#pre-check-list" title="标题的直接链接">​</a></h3><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->++ Check props in <code>/system/build.prop</code>; note: 这个暂时先不用管了，找智伟找了一下，都没找到</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="core-1-list">core 1 list<a class="hash-link" href="#core-1-list" title="标题的直接链接">​</a></h3><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->+++ Add files of <code>HmdType6DistortionMesh</code></li><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->+++ Add <code>HmdType6DistortionMesh</code> into <code>Android.mk</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="core-2-list">core 2 list<a class="hash-link" href="#core-2-list" title="标题的直接链接">​</a></h3><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->+++ suppress <code>#error</code> of <code>gls2.h</code></li><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->++ Add variable <code>eVrWindow</code> into <code>ISurfaceComposerClient.h</code></li><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->+++ Add variables definition into <code>surfaceflinger.h</code></li><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->+++ Add <code>initFB</code> into <code>surfaceflinger.cpp</code></li><li>[?]<!-- --> +++ Add <code>doComposeSurfaces</code> into <code>surfaceflinger.cpp</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="core-3-list">core 3 list<a class="hash-link" href="#core-3-list" title="标题的直接链接">​</a></h3><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" checked="" disabled=""> <!-- -->++ Add <code>vr</code> variable and <code>get|set</code> into <code>Layer.h</code> (but implemented in <code>surfaceflinger.cpp</code>)</li><li>[?]<!-- --> + Add <code>win.right</code> and <code>position</code> into <code>Layer.cpp</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="年前主要困难分析">年前主要困难分析<a class="hash-link" href="#年前主要困难分析" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="layercpp中关于win和position"><code>Layer.cpp</code>中关于<code>win</code>和<code>position</code><a class="hash-link" href="#layercpp中关于win和position" title="标题的直接链接">​</a></h3><p>这是patch截图：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-problems-1643166975497-f3269e96a60010bb3b024829d8d884748f7870a6c070e92c708da11c0516b0a4.png" alt="picture 71" class="img_ev3q">  </p><p>这是AOSP 8 和 11 中这部分代码位置：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-problems-1643167134668-81d592f0345aba1a0e67f670a66b9ea7772884ab0a2dbe340e772325a65170f8.png" alt="picture 72" class="img_ev3q">  </p><p>8中patch修改的部分是在<code>drawWithOpenGL</code>函数内，但是11中同文件没有这块内容，11中OpenGL整体都移出去了。这是第一个问题。</p><p>第二个问题就是，这个<code>win.right = hw-&gt;getWidth()</code>我没有太理解。<code>win</code>是基于<code>bounds(computeBounds())</code>得到的，是减去透明区域后的区域，它的构造如下：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643137518943-d8297585f5c0fa99e05666d3eaeb3a8e87e544c55deb73dd390d224ab758b3c9.png" alt="picture 56" class="img_ev3q">  </p><p>8和11在这里的区别不是很大，只不过<code>computeBounds</code>名字改成了<code>getBounds</code>，内部实现也相应地更简洁了一些，核心思想就是窗口区域减去透明区域，得到的就是所谓<code>Rect</code>，也就是实际区域吧。<del>至于结构体是啥，四个坐标吗，还是啥，应该倒也不是那么重要。</del></p><p>我这里其实主要困惑的在于，如果<code>win</code>是指那个活动窗口，比如说某个浮动窗口，那在vr模式下单独改其<code>right</code>为<code>hw</code>的宽度，而不把<code>left</code>改成0，这是否会有问题呢？至少看起来不是那么对称，所以这里在原理上来说，是一个非常大的困惑。</p><p>还是，先看看如何在11中实现这个修改吧。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="可疑1-layerprepareclientcomposition">可疑1. <code>Layer::prepareClientComposition()</code><a class="hash-link" href="#可疑1-layerprepareclientcomposition" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138949603-bd8010805a1b2d7274c9adf4c6c21c43c549711742aadeb94d21c388e1468ca7.png" alt="picture 58" class="img_ev3q">  </p><p>在这块里，最大的可疑原因是正好与左边8的版本对齐，并且函数名就是在画图：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139039422-45fe81e61a85a9a61de7d2d34b40023143d959a149be023b1f89ef875e73a6eb.png" alt="picture 59" class="img_ev3q">  </p><p>另外也有一个关键赋值语句：<code>layerSettings.geometry.boundaries = bounds;</code>，我们若在赋值之前，修改<code>bounds.right</code>为<code>hw.getWidth()</code>，或许就和8对齐了。</p><p>只不过最大的问题是，这个函数不接收<code>hw</code>的参数……，所以，很可能，不是我们相要的。</p><p>但我又找了一下<code>hw</code>的类<code>DeviceDisplay</code>，发现这个文件里很少用：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139341595-57becab0aa04cd092d41f5176b3f5afd575609567c75524f460af9e009e9996e.png" alt="picture 60" class="img_ev3q">  </p><p>并且 <code>hw-&gt;</code>的调用也是一个都没。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="可疑2-inputwindowinfo-layerfillinputinfo">可疑2. <code>InputWindowInfo Layer::fillInputInfo()</code><a class="hash-link" href="#可疑2-inputwindowinfo-layerfillinputinfo" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138409793-047823adc1fbf5db5d36fc05a824d31ff9e81110a4ce1a4ef69833d217f0c026.png" alt="picture 57" class="img_ev3q">  </p><p>我基于<code>getBounds</code>函数追到这块（可疑1也有<code>getBounds</code>），发现代码结构就比较像目标代码。尤其是<code>x|ySurfaceInset</code>的构造与使用，可以看到<code>xSurfaceInset</code>也用到了<code>layerBounds.getWidth()</code>函数，并且后续还有一句<code>layerBounds.inset(xSurfaceInset, ySurfaceInset, xSurfaceInset, ySurfaceInset);</code>看起来仿佛在构造两个眼镜的某些参数一样。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="position似乎没有被调用的困惑">position似乎没有被调用的困惑<a class="hash-link" href="#position似乎没有被调用的困惑" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139564016-37973fb37dbac73e4fa89c3e2d7fb127e1415c0699dc370f39de3ffd47749d10.png" alt="picture 61" class="img_ev3q">  </p><p>分析了<code>win</code>后，下面的一个问题就是关于<code>position</code>的，然而光从这段来看的话，似乎没有起到任何作用，仅仅是一个赋值，所以不太懂这个设计。如果这是个全局变量，我还比较明白，说明<code>position[2]</code>可能是左眼右边点，而<code>position[3]</code>是右眼左边点。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="surfaceflingercpp中关于-docomposesurfaces"><code>surfaceflinger.cpp</code>中关于 <code>doComposeSurfaces</code><a class="hash-link" href="#surfaceflingercpp中关于-docomposesurfaces" title="标题的直接链接">​</a></h3><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-problems-1643167933698-db055f067f102fdb102f9439b13842250003015447719c5459a4593af867b2b9.png" alt="picture 73" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144378837-b02055303c54561f2c6769b85e61e9213186d752c210af0d1d507899a61f690a.png" alt="picture 65" class="img_ev3q">  </p><p>很惨，8里面的接口直接被剥了，经过对比，实际上10还是有的，所以是11时删的。</p><p>而 <code>doComposeSurfaces</code> 函数正好还比较复杂：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">handleMessageRefresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; preComposition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; rebuildLayerStacks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; setUpHWComposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; HWComposer::createWorkList &lt;== hwc=&quot;&quot; structures=&quot;&quot; are=&quot;&quot; allocated=&quot;&quot; |—=&quot;&quot;&gt; Layer::setGeometry()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—  set per frame data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—  HWComposer::prepare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; hwc prepare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; doComposition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |---- skip composition on external display if condition meets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; doDisplayComposition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |    |—&gt; doComposeSurfaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |     |—&gt; DisplayDevice::swapBuffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |          |—&gt; eglSwapBuffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |          |—&gt; FramebufferSurface::advanceFrame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; DisplayDevice::flip(…)     &lt;== just=&quot;&quot; update=&quot;&quot; statistics=&quot;&quot; count=&quot;&quot; |--=&quot;&quot;&gt; Call DisplayDevice::compositionComplete(), notify each display</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |--&gt; DisplaySurface::compositionComplete()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |--&gt; FramebufferSurface::compositionComplete()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |--&gt; HWComposer::fbCompositionComplete()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              |--&gt; NoOP if HWC &gt;= 1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              |--&gt; used only in framebuffer device case.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |—&gt; postFrameBuffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; HWComposer::commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |—&gt; hwc set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |—&gt; update retireFenceFd of hwc_display_contents_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; DisplayDevice::onSwapBuffersCompleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |—&gt; FramebufferSurface::onFrameComitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—&gt; Layer::onLayerDisplayed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |—   update some statistics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |—&gt; postComposition </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>目前已知的，关于opengl的实现路径变动：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Mesh.h, Texture.h 都在该目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RenderEngine --&gt; ./libs/renderengine/include/renderengine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## gls2.h, gls2ext.h 都在该目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GLES2 --&gt; ./opengl/include/GLES2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是关键是 <code>doComposeSurfaces</code> 中的函数体非常大，结果到11全被割出去了。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/markshawn2020/keeps-learning/edit/master/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2021.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2022-07-27T07:28:22.000Z">2022年7月27日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA4-sf-research/sf-howto"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">surfaceflinger display research</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA5-sf-patches/sf-patch-research-2022"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">surfaceflinger patch research 2022</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#gerrit-codes" class="table-of-contents__link toc-highlight">gerrit codes</a><ul><li><a href="#search-the-target-gerrit" class="table-of-contents__link toc-highlight">search the target gerrit</a></li></ul></li><li><a href="#patch-1--2-analysis" class="table-of-contents__link toc-highlight">patch 1 &amp; 2 analysis</a><ul><li><a href="#definition" class="table-of-contents__link toc-highlight">definition</a></li><li><a href="#classification" class="table-of-contents__link toc-highlight">classification</a></li><li><a href="#easy-suppress-error-problem-of-imported-gls2h" class="table-of-contents__link toc-highlight">EASY: suppress <code>#error</code> problem of imported <code>gls2.h</code></a></li><li><a href="#easy-servicessurfaceflingerandroidmk" class="table-of-contents__link toc-highlight">EASY: <code>services/surfaceflinger/Android.mk</code></a></li><li><a href="#pass-libsguiglconsumercpp" class="table-of-contents__link toc-highlight">PASS: <code>libs/gui/GLConsumer.cpp</code></a></li><li><a href="#servicessurfaceflingersurfaceflingercpp" class="table-of-contents__link toc-highlight"><code>services/surfaceflinger/SurfaceFlinger.cpp</code></a></li></ul></li><li><a href="#编译" class="table-of-contents__link toc-highlight">编译</a><ul><li><a href="#目前策略" class="table-of-contents__link toc-highlight">目前策略</a></li><li><a href="#目前策略更新2022-01-27-151638" class="table-of-contents__link toc-highlight">目前策略更新@2022-01-27 15:16:38</a></li><li><a href="#-error-use-of-undeclared-identifier-dirty" class="table-of-contents__link toc-highlight">✅ <code>error: use of undeclared identifier &#39;dirty&#39;</code></a></li><li><a href="#-error-use-of-undeclared-identifier-displaytransform" class="table-of-contents__link toc-highlight">✅ <code>error: use of undeclared identifier &#39;displayTransform&#39;</code></a></li><li><a href="#-error-unknown-type-name-transform" class="table-of-contents__link toc-highlight">✅ <code>error: unknown type name &#39;Transform&#39;</code></a></li><li><a href="#-error-no-member-named-draw-in-androidlayer" class="table-of-contents__link toc-highlight">✅ <code>error: no member named &#39;draw&#39; in &#39;android::Layer&#39;</code></a></li><li><a href="#-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine" class="table-of-contents__link toc-highlight">✅ <code>error: use of undeclared identifier &#39;mRenderEngine&#39;; did you mean &#39;renderEngine&#39;?</code></a></li><li><a href="#-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending" class="table-of-contents__link toc-highlight">✅ <code>error: too few arguments to function call, expected 5, have 3 (RenderEngine-&gt;setupLayerBlending)</code></a></li><li><a href="#-error-use-of-undeclared-identifier-renderarea" class="table-of-contents__link toc-highlight">✅ <code>error: use of undeclared identifier &#39;renderArea&#39;</code></a></li><li><a href="#终于成功了2022-01-27-233703" class="table-of-contents__link toc-highlight">终于成功了！2022-01-27 23:37:03</a></li></ul></li><li><a href="#年前主要工作目标" class="table-of-contents__link toc-highlight">年前主要工作目标</a><ul><li><a href="#pre-check-list" class="table-of-contents__link toc-highlight">pre-check list</a></li><li><a href="#core-1-list" class="table-of-contents__link toc-highlight">core 1 list</a></li><li><a href="#core-2-list" class="table-of-contents__link toc-highlight">core 2 list</a></li><li><a href="#core-3-list" class="table-of-contents__link toc-highlight">core 3 list</a></li></ul></li><li><a href="#年前主要困难分析" class="table-of-contents__link toc-highlight">年前主要困难分析</a><ul><li><a href="#layercpp中关于win和position" class="table-of-contents__link toc-highlight"><code>Layer.cpp</code>中关于<code>win</code>和<code>position</code></a></li><li><a href="#surfaceflingercpp中关于-docomposesurfaces" class="table-of-contents__link toc-highlight"><code>surfaceflinger.cpp</code>中关于 <code>doComposeSurfaces</code></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/keeps-learning/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/keeps-learning/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Docusaurus</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/category/guides" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/keeps-learning/assets/js/runtime~main.3d1d49db.js"></script>
<script src="/keeps-learning/assets/js/main.09e96f98.js"></script>
</body>
</html>