<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-AndroidFramework/timewarp/TaskC1-timewarp/tw-research">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/keeps-learning/blog/rss.xml" title="南川笔记 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/keeps-learning/blog/atom.xml" title="南川笔记 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ00XLDNZ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-QFQ00XLDNZ",{anonymize_ip:!0})</script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">TIMEWARP RESEARCH | 南川笔记</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-research"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="TIMEWARP RESEARCH | 南川笔记"><meta data-rh="true" name="description" content="- Timewarp Guide"><meta data-rh="true" property="og:description" content="- Timewarp Guide"><link data-rh="true" rel="icon" href="/keeps-learning/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-research"><link data-rh="true" rel="alternate" href="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-research" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://markshawn2020.github.io/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-research" hreflang="x-default"><link rel="stylesheet" href="/keeps-learning/assets/css/styles.6bbfa55a.css">
<link rel="preload" href="/keeps-learning/assets/js/runtime~main.62df1d2c.js" as="script">
<link rel="preload" href="/keeps-learning/assets/js/main.402f255e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/keeps-learning/"><div class="navbar__logo"><img src="/keeps-learning/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/keeps-learning/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">南川笔记</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/keeps-learning/docs/">My Docs</a><a class="navbar__item navbar__link" href="/keeps-learning/blog">My Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/markshawn2020/keeps-learning" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keeps-learning/docs/">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keeps-learning/docs/TODO">TODO</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/keeps-learning/docs/SLAM/A01-recognizeLights">SLAM</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/A01-recognizeLights">A01: recognize lights</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/slam-research">slam-research</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/slambook2-ch13">slambook2-ch13</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/SLAM/slambook2-learning">slambook2-learning</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">AndroidFramework</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/AOSP/TaskA1-aosp-pull/aosp-pull">AOSP</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/adb-howto">adb howto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/arpara/arpara-vr-logic">arpara</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/frameworks-howto">frameworks howto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/hmdservice/TaskB1-hmdservice-compile/how-to-compile-arpara-hmdservice-on-AOSP10">hmdservice</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/rockchip/rockchip4-flash-manual">rockchip</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-bugfix">timewarp</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-bugfix">TaskC1-timewarp</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-bugfix">atw bugfix</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-research">TIMEWARP RESEARCH</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC2-opengl/opengl-howto">TaskC2-opengl</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/keeps-learning/docs/AndroidFramework/timewarp/arpara-glass-howto">arpara glass howto</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/Coding/CPP/cpp-howto">Coding</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/Notes/uploaded/I-am-me">Notes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/OS/Linux/centos-init-manual">OS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/keeps-learning/docs/Softwares/Adobe/PS/support-for-little-stars/">Softwares</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keeps-learning/docs/TODO-closed">TODO-closed</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/keeps-learning/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AndroidFramework</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">timewarp</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">TaskC1-timewarp</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">TIMEWARP RESEARCH</span><meta itemprop="position" content="4"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：0.16.0+</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>TIMEWARP RESEARCH</h1><ul><li><a href="#timewarp-guide">Timewarp Guide</a></li><li><a href="#source-code-research">Source Code Research</a><ul><li><a href="#decide-the-target-code">decide the target code</a></li></ul></li><li><a href="#sdk-logic-backward-track">SDK Logic Backward-track</a></li><li><a href="#sdk-logic-forward-implementation">SDK Logic Forward-implementation</a><ul><li><a href="#step-1-vertexshader-and-fragmentshader">step 1. <code>vertexShader</code> and <code>fragmentShader</code></a><ul><li><a href="#11-definition-of-vertexshader-and-fragmentshader">1.1. definition of <code>vertexShader</code> and <code>fragmentShader</code></a></li><li><a href="#12-usage-of-vertexshader-and-fragmentshader">1.2. usage of <code>vertexShader</code> and <code>fragmentShader</code></a></li><li><a href="#23-pose%E5%A7%BF%E6%80%81">2.3 <code>Pose</code>（姿态）</a></li><li><a href="#24-pass-cgpu_profile_beginend">2.4. PASS: <code>[CG]PU_PROFILE_(BEGIN|END)</code></a></li></ul></li><li><a href="#25-%E5%88%9D%E5%A7%8B%E5%8C%96-pose">2.5. 初始化 <code>Pose</code></a></li><li><a href="#26-%E8%8E%B7%E5%8F%96-pose">2.6 获取 <code>Pose</code></a></li></ul></li><li><a href="#sdk-custom">SDK custom</a><ul><li><a href="#implementation">implementation</a></li><li><a href="#fixme-gluniformmatrix4fv-is-depreciated">FIXME: <code>glUniformMatrix4fv is depreciated</code></a></li><li><a href="#todo-%E8%8E%B7%E5%8F%96%E7%9A%84%E5%A7%BF%E6%80%81%E4%B8%8D%E7%AD%89%E4%BA%8E%E6%88%91%E4%BB%AC%E5%AF%B9buffer%E8%A6%81%E5%81%9A%E7%9A%84%E6%93%8D%E4%BD%9C">TODO: 获取的姿态不等于我们对buffer要做的操作</a></li><li><a href="#fixed-how-to-init-c-class">FIXED: how to init C++ class</a></li><li><a href="#fixed-how-to-import-glint">FIXED: how to &quot;import&quot; <code>GLint</code></a></li></ul></li><li><a href="#framework-logic">Framework Logic</a><ul><li><a href="#intro-programcachecpp">intro: <code>ProgramCache.cpp</code></a></li><li><a href="#filter-out-uniform-logic">filter out <code>uniform</code> Logic</a></li><li><a href="#add-vertexshader-and-fragmentshader">add <code>vertexShader</code> and <code>fragmentShader</code></a></li></ul></li><li><a href="#timewarp-forecast">Timewarp Forecast</a><ul><li><a href="#documentation">documentation</a></li><li><a href="#workflow">workflow</a></li></ul></li><li><a href="#timewarp-algo">Timewarp Algo</a></li><li><a href="#markupdate2022-02-25-timewarp-framework-test">mark::update@2022-02-25: timewarp framework test</a><ul><li><a href="#%E6%89%93%E5%8D%B0-timewarp-matrix">打印 timewarp matrix</a></li></ul></li><li><a href="#can-we-change-log-level">can we change log level?</a></li><li><a href="#can-we-debug-shader">can we debug shader?</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="timewarp-guide">Timewarp Guide<a class="hash-link" href="#timewarp-guide" title="标题的直接链接">​</a></h2><ul><li>核心参考资料（Oculus 的ATW介绍） <a href="https://developer.oculus.com/documentation/native/android/mobile-timewarp-overview/" target="_blank" rel="noopener noreferrer">Asynchronous TimeWarp (ATW) | Oculus Developers</a></li></ul><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645101339108-d0a8d4e45f1bc1d7eff11beeef983a052fc7a0ed679f8f4e3d2a808b9cb91c51.png" alt="picture 1" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645101347871-f23d6d77ae06bd2e7f4f6aa23516d5ecc330afe6f0ead6c8789919f9d0041740.png" alt="picture 2" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645101359009-fde308c67c9e8d1207019e6f09568ef4507fd3f7eed53ce6d3a870ce4d5e6261.png" alt="picture 3" class="img_ev3q">  </p><p>In this article: <a href="https://www.jianshu.com/p/027916e345bc" target="_blank" rel="noopener noreferrer">Android N VR代码简析 - 简书</a>, it said:</p><blockquote><p>单独分离出一个SDK，除了方便应用开发者之外，主要的目的是用来把VR的一些核心算法隐藏起来，比如用来减少延迟的ATW异步时间扭曲算法就是被封装在这里，是闭源不公开的。
众所周知，在手机上面运行VR的时候一个最大的挑战就是延迟，当一副画面的延迟超过20MS，人就会感觉不舒服恶心，严重影响用户体验，一个好的VR产品都会尽量避免延迟。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code-research">Source Code Research<a class="hash-link" href="#source-code-research" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="decide-the-target-code">decide the target code<a class="hash-link" href="#decide-the-target-code" title="标题的直接链接">​</a></h3><p>According to the grep search and vimdiff, we can locate the target codes are in <code>./src/lib/cpp/Distortion/BarrelDistortion1ShaderProgramGL.cpp</code>.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645079933188-0fb7311936ddbe6e17d5fafb7ebcd6b384693c39f649f1ccd6884440cece9917.png" alt="picture 2" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645079885554-ded3bb730484c368a2695e269ba47fc7ad3e772bc3bad3bdf98171ab8f43cef6.png" alt="picture 1" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sdk-logic-backward-track">SDK Logic Backward-track<a class="hash-link" href="#sdk-logic-backward-track" title="标题的直接链接">​</a></h2><p>sdk关于 <code>timewarp</code> 的逻辑，尤其是 <code>Shader</code> 部分主要集中在 <code>vrsdk-20210813/src/lib/cpp/Distortion/BarrelDistortion1ShaderProgramGL.cpp</code> 文件中，并基于 <code>opengl</code> 的版本决定 <code>VertexShader</code> 和 <code>FragmentShader</code> 的初始化，其对应的版本也不同。</p><p><del>我们直接使用 <code>opengl3.3</code> 的版本就可以（也就是 <code>opengl-core</code> 对应的逻辑）部分。</del></p><p>mark::update@2022-02-19: 根据志刚反馈，车机使用的是<code>opengl 3.0</code>，因此我们只能使用 本SDK中<code>opengl 1.0</code> 的写法了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645107339477-4177bf852550cf415b931baf25f375fc201469290c17c62f91b0b37befbadbff.png" alt="picture 1" class="img_ev3q">  </p><p>其中 <code>BarrelDistortionShaderProgramPerApi</code> 函数是在 <code>cpp/Distortion/BarrelDistortionShaderProgram.h</code> （注意，不是1了）中定义的，它接收三个 Shader 参数，前面两个分别是 <code>VertexShader</code> 和 <code>FragmentShader</code>，最后一个是叫 <code>geomShader</code>，初始化为空。它们会调用 <code>ShaderBase</code> 函数。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645112317306-8e8d26282dffba206bd8c9c1e1cc4cd0e9fc00b4dd55ab97b5bcfbd868532515.png" alt="picture 5" class="img_ev3q">  </p><p>注意，这个 <code>ShaderBase</code> 函数其实是一个泛型，在我们的调用栈中，它实际是 <code>cpp/Distortion/BarrelDistortion1ShaderProgramGL.h</code> 中的 <code>ShaderProgramGL</code>。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645112700190-9449f0e393c7dc9fb7bde2cd41c9d5f319b1965e2af6cf78ff62bed9f60d4845.png" alt="picture 6" class="img_ev3q">  </p><p>也就是说，实际初始化时，调用的具体函数是 <code>ShaderProgramGL(vertexShader, fragmentShader, null)</code>。</p><p>它是在 <code>cpp/Renderer/gl/ShaderProgramGL.h</code> 中定义的：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645113409867-689ac83f3397660a54f44a0c1ee31bcaf12b2fabdd9a0f0f6397d6f83e891c3e.png" alt="picture 7" class="img_ev3q">  </p><p>查看实现，其实底层就是调的<code>cpp/Renderer/gl/ShaderProgramGL.cpp</code>（TO-CONFIRM: 应该是官方<code>opengl</code>） 的 <code>ShaderProgram</code>。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645113514126-ff2bc90994310fe39fdc65705750bc6bf855e61d899132ccde263efcd6f99e0b.png" alt="picture 8" class="img_ev3q">  </p><p>注意到这里也有 <code>IVR_GRAPHICS_API_GLES2</code> 和 <code>IVR_GRAPHICS_API_GLCORE</code> 的定义，<del>可以看出来，其实两个文件结构是差不多的</del>。mark::update@2022-02-18: 对比了下具体的文件，还是差挺多的，只有很少的一部分（比如 <code>compile</code>接口）有保留，其他的基本都改了，应该来说，结构差不多，但内容差了很多，深度定制了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645159048380-534d6cff90d4a85b84c2195517db44ba1776758331ce98584e525ea3249f3044.png" alt="picture 11" class="img_ev3q">  </p><p>最后追到 <code>cpp/Renderer/ShaderProgram.cpp</code> 里 <code>ShaderProgram</code> 的实现，可以看到就是一个初始化的过程。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645159373569-9bbc79c606ee2827a604a6cf730e01debbc81f7dc2a0eb098d3c97791d1314d1.png" alt="picture 12" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sdk-logic-forward-implementation">SDK Logic Forward-implementation<a class="hash-link" href="#sdk-logic-forward-implementation" title="标题的直接链接">​</a></h2><p>基于 <a href="#sdk-logic-backward-track">sdk logic backward-track</a> 的梳理，我们可以前向整理出整套sdk逻辑了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-vertexshader-and-fragmentshader">step 1. <code>vertexShader</code> and <code>fragmentShader</code><a class="hash-link" href="#step-1-vertexshader-and-fragmentshader" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="11-definition-of-vertexshader-and-fragmentshader">1.1. definition of <code>vertexShader</code> and <code>fragmentShader</code><a class="hash-link" href="#11-definition-of-vertexshader-and-fragmentshader" title="标题的直接链接">​</a></h4><p>原SDK中，基于 <code>opengl</code> 版本进行判断，选择是否使用 <code>opengl#version 100</code> 或者 <code>opengl#version 330</code>。</p><p>但是经过查询android官方opengl部分： <a href="https://developer.android.com/guide/topics/graphics/opengl?hl=zh-cn" target="_blank" rel="noopener noreferrer">OpenGL ES  |  Android 开发者  |  Android Developers</a>，发现可能只支持<code>opengl 3.1</code>：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645161819210-94b0b24bb07812169e7b14d2584066f11d105bb65ebf2824cbeafd7adbeb1b00.png" alt="picture 13" class="img_ev3q">  </p><p>理论上应该不至于，因为 <code>opengl 3.3</code> : <a href="https://en.wikipedia.org/wiki/OpenGL#OpenGL_3.3" target="_blank" rel="noopener noreferrer">OpenGL - Wikipedia</a> 早在2010年就发布了：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645161870835-8a0ab9ae3a92f44e4bc95b9422a7a930f1607c95bc5aed983adbc06aa3e7eb36.png" alt="picture 14" class="img_ev3q">  </p><p>!!! warning DEPRECIATED</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FIXED: 所以这一点还要确认一下。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">因此，目前的保守做法，就还是沿用老SDK的处理方式，根据opengl的不同版本，写两套处理程序（为精简，都去除了和旋转有关的内容），一套为了兼容（`opengl 1.0`），一套为了性能（`opengl 3.3`）：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">see: [define_shader.h](./define_shader.h)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>mark::update@2022-02-19: 已确认，车机只能使用 <code>opengl 3.9</code>。</p><p>这样我们就有了两个变量：</p><ol><li><code>s_barrelDistortion1VertexShader</code></li><li><code>s_barrelDistortion1FragmentShader</code></li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="12-usage-of-vertexshader-and-fragmentshader">1.2. usage of <code>vertexShader</code> and <code>fragmentShader</code><a class="hash-link" href="#12-usage-of-vertexshader-and-fragmentshader" title="标题的直接链接">​</a></h4><p>根据调用栈： </p><p>cpp++
BarrelDistortion1ShaderProgramGL::BarrelDistortion1ShaderProgramGL()
--&gt; BarrelDistortionShaderProgramPerApi(s_barrelDistortion1VertexShader, s_barrelDistortion1FragmentShader)
--&gt; ShaderBase(vertShader, fragShader, geomShader /<em>null</em>/)
--&gt; ShaderProgramGL(vertShader, fragShader, geomShader /<em>null</em>/)
--&gt; ShaderProgram(vertShader, fragShader, geomShader /<em>null</em>/)
--&gt; _vertShaderSource(vertShader), _fragShaderSource(fragShader), _geomShaderSource(geomShader)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，其实就是单纯赋值一直往上就可以了，最终在 `BarrelDistortion1ShaderProgramGL` 或者说 `ShaderProgram` 里有个 `_vertShaderSource`被初始化为 `s_barrelDistortion1VertexShader`，有个 `_fragShaderSource` 被初始化为 `s_barrelDistortion1FragmentShader`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### 1.3. dependencies of `vertexShader` and `fragmentShader`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其实怎么使用功能 `vertexShader` 和 `fragmentShader` 理论上不是我们需要思考的事，因为在 android 框架里，使用部分貌似是已经封装好的，我们只需初始化这两个shader并启用就好。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">而这一步，在后面的 [framework logic](#framework-logic) 里会继续深入，此处不是我们关心的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">而且我们确实有现在需要关心的问题，那就是两个Shader里还有一些变量需要我们手动提供。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如下图，`a_texcoord` 应该只是内部属性，不需要自己实现（TODO: 确认这一点）；而真正需要自己定义、实现与操作的是 `u_timewarp_mat` 和 `u_enable_timewarp` 变量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 16](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645164420291-f604b847b85aa1119ed4df29ba330be9a59fa936cf6cf8d08751497a591116f1.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### step 2. `setWrapMatrix`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### 2.1 call/set `u_enable_time_warp` and `u_timewarp_mat`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!!! note</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~~我们可以先从 `u_enable_time_warp` 变量入手，因为它只是一个 bool 类型变量，在理解了它的“前世今生”之后，可以更快地理解 `u_timewarp_mat`。~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mark::update@2022-02-18: 后续分析发现，其实 `u_enable_time_warp` 是在 `setWarpMatrix` 函数中和 `u_timewarp_mat` 一起设置的，所以也没有分开研究的必要。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 `src/lib/cpp/Distortion/BarrelDistortion1ShaderProgramGL.cpp` 中可以看到关于 `u_enable_time_warp` 相关的 set 操作（已修正原SDK误把 `_uniformTimewarpEnable` 写成 `_uniformRotationEnable` 的问题 ）。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">但其实，对照 `setScreenParameters` 中对 `_uniformRotationEnable` 的使用，可以发现，我们的 `_uniformTimeWarpEnable` 方法只有 set 1 的动作，而没有set 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 17](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645166936719-016396f18b4c4fb274fca9e8d18c38eec123a448ceb4cca13576d9ec03fd5186.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我们尝试添加 set 0 的操作，以支持 timewarp 的动态开关。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一个比较简单的方法，是保留现在的接口，但允许传入参数 `warpMatrix` 为空，然后当它为空时，我们设置 set `_uniformTimeWarpEnable` 为 0。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">修改如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 19](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645169682121-d34078661d59776fc5a02d68bd3735513940c76597c20312afafce6fde96a052.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">现在还得知道 `setWarpMatrix` 的逻辑。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### 2.2 `setWrapMatrix`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首先搜索所有 `setWarpMatrix` 相关的调用信息：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 21](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645172215721-7704936bd0e08b03339a88bc9574e8ce98f82695d8d268b1935f76f470e13a2e.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其中第一个就是我们刚刚修改（加入disable timewarp选项）的那个，然后其他都是初始化相关的，最终调用的就两个地方，也就是 `src/lib/cpp/Distortion/BarrelDistortion1RenderPass.cpp` 内的 `composeSingleEye` 和 `composeDoubleEye`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 22](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645176448825-5c255c6cb2f880756d3450bc84e1d8edabd27160f015aac4dcaf65aaaee228f6.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">询问了晓研哥，回复是“曾经提过一个让不支持3D分辨率的设备只输出2D画面的需求”，具体也不懂，也不是很重要，我们直接看 `composeDoubleEye` 就好。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TODO: `composeDoubleEye` 函数中与 `ShaderProgram` 有关的有四个方法调用：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 23](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645176614228-c65b03d91721b6c8b0e0e78652d166fb734369fd553701b3a02f7b07ea961a9f.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首先分析和 `timewarp` 相关的那个，使用了`getWarpMatrix`方法，容易知道，这个方法是在 `Renderer` 里面定义的：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 24](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645176839422-557fb596ea4a85211e087787e3f4276200a8fef3d576c4475184b106b96ec52f.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">进来发现，它其实只是使用了数组 `_warpMatrix`，因此我们需要知道这个数组的意思。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 25](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645176922723-209f658563875ceb5dda8763af1b8aa10ca18203130d20dfe4efafc951c533f8.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">结果发现，还是在这个文件里，有一个传参赋值动作：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 27](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645177011817-3b1a21df7eb71b72cf95aa6b991c8c33fa8a00090be02841890c71a61453d40c.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 26](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645176997898-3f44ebfceeab8796f1532c084c9774d24c06b6abe5e7c8fbb0cb2f119f44b11e.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">因此我们又得知道 `setWarpMatrix` 的赋值调用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此时如果直接搜索 `*1*GL*`，则发现回到了我们的起点……闭环了……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 28](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645177307017-9d8e3573c6d9b9927588d391e1c0637c9abca7d1c05d3b42b02dca356b94269f.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">说明，实际 `setWarpMatrix` 的动作还在外面，我们需要知道 `setWarpMatrix` 真正是由谁调用的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其实仔细看底层的 `setWarpMatrix` 会发现它有两个参数，第一个参数是眼睛。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">因此直接在根目录搜索，会发现是在 `Composer`里调用的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 29](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645177654553-d99cb22999a5773485f4308fc1a95dc69dc138d1d0fecc97392d971665be1838.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">至此，关于 `warpMatrix` 的逻辑栈就通了：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpp++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BarrelDistortion1RenderPass::composeDoubleEye()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; _shaderProgram-&gt;setWarpMatrix(getWarpMatrix(eye)) // _warpMatrix[eye]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// set  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VrComposerInproc::_distortionPass-&gt;setWarpMatrix(eye, warpMatrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; BarrelDistortion1ShaderProgramGL::setWarpMatrix(warpMatrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; _warpMatrix[eye] = warpMatrix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23-pose姿态">2.3 <code>Pose</code>（姿态）<a class="hash-link" href="#23-pose姿态" title="标题的直接链接">​</a></h4><p>姿态相关的是在 <code>Composer/VrComposerInProc.cpp</code> 中，主要函数是 <code>void VrComposerInProc::present(uint32_t renderOptions, const Pose &amp;renderPose)</code>：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645178554972-fec9c4518c220189bd6e73d9217bbe316a4352918935a90dde18a8c3f480f3dd.png" alt="picture 30" class="img_ev3q">  </p><p>其中 <code>renderOptions</code> 参数可以几乎不用管，用来判断逻辑的， 我们只需要 enable 它就可以。</p><p>核心处理是这部分，首先获取最新的姿态（接下来由 <code>hmdClient</code> 提供），然后算出一个矩阵，再设置给左右眼：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645180693642-ba78a1153e62a645caa0eb51f8e312bc3a470eb32cb2d03658e367be3648daad.png" alt="picture 31" class="img_ev3q">  </p><p>追到 <code>calculateWarpMatrices</code> ，发现就是个逆矩阵计算。(不过还需要通过 <code>computeViewMatrix</code> 函数得到每个矩阵。)</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645180840261-1f96d52e8a8f5ab7de37476437c68138beea0d5258ee82d0431ba2709f324eea.png" alt="picture 32" class="img_ev3q">  </p><p>再看 <code>computeViewMatrix</code> 函数，就是基于 <code>Pose</code> 的姿态属性，进行 <code>glm</code> 相关的计算（可以照抄）。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645181125920-5e12bb82603d93570f87eb62d4de9e101cb44b6aa0c305e2fc793f1fde41728a.png" alt="picture 33" class="img_ev3q">  </p><p>而 <code>Pose</code> 的定义是在 <code>./Tracker/TrackerClient.h</code> 中（这里虽然写的是 <code>PoseState</code>， 但实际上对比之前那个函数，会发现，应该就是 <code>Pose</code>）：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645181208590-b8bded1e4d065bd5b3a3352ca4357243e50ce23183fb88e16dc6df1d73f13d0c.png" alt="picture 34" class="img_ev3q">  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="24-pass-cgpu_profile_beginend">2.4. PASS: <code>[CG]PU_PROFILE_(BEGIN|END)</code><a class="hash-link" href="#24-pass-cgpu_profile_beginend" title="标题的直接链接">​</a></h4><blockquote><p>根据晓研哥指示，这部分适用于测试性能的，所以也不用看。</p></blockquote><p>在 <code>VrComposerInProc::present</code> 函数中，有个关于 <code>[CG]PU</code> 的调用值得注意：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645184570907-28e87ba2defce8077e7dbae6c3c8cbc595706541fe4c32e407f7dd52f0f66a13.png" alt="picture 36" class="img_ev3q">  </p><p>在 <code>src/common/CpuProfile.h</code> 中可以找到关于 <code>CPU_PROFILE_(BEGIN|END)</code> 的定义。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645187583404-eb0431553855fcd14b0a91540d36b37feb4e42b0c603b9ebcfbc1c948c3be3cc.png" alt="picture 38" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645187328248-c763c95de009709aa4c968ff99362b5a7bdb97185b3c8429eef11cdc039d471d.png" alt="picture 37" class="img_ev3q">  </p><p>在 <code>src/common/CpuProfile.cpp</code> 中可查到实现如下：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645187986029-c539c3894bb662726b8eb13e1510e92a32721402592378cc8b068a89ed477bfe.png" alt="picture 39" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-初始化-pose">2.5. 初始化 <code>Pose</code><a class="hash-link" href="#25-初始化-pose" title="标题的直接链接">​</a></h3><p>在 <code>TrackClient.h</code> 中定义了 <code>PoseState</code> 的数组，但是并没有什么set的操作。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645199303457-e03440c58786c29055b67a07093a24247f4f7c1657cd5e01b0d604e1619df674.png" alt="picture 41" class="img_ev3q">  </p><p>查看 <code>_historyBuffer</code> 相关的信息，发现主要还是集中在 <code>onSensorUpdate</code> 函数上。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645199369594-b182d7ef99e58bee5137c6cf06301ff5cf57ae55b4e6aba6a446ee64f8c83ede.png" alt="picture 42" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645199414532-3ab5efdaea105fe7159f4017aeb91c2e0b41f75a5a10ed33fa9002a95e743a62.png" alt="picture 43" class="img_ev3q">  </p><p>但其实这个函数里对 <code>_historyBuffer</code> 的set操作，也是基于其“本身”的，所以很奇怪：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645199492073-08c539ad900b2182fe0f0dda16b554f050fd455356f022f79482bbf01f1a0d5f.png" alt="picture 44" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="26-获取-pose">2.6 获取 <code>Pose</code><a class="hash-link" href="#26-获取-pose" title="标题的直接链接">​</a></h3><p>在 <code>TrackerPalHmdService.cpp</code> 的 <code>readSensor</code> 接口里获取 <code>hmdService</code> 的姿态数据，然后将姿态数据再基于自己的 <code>onSensorUpdate</code> 函数进行更新维护，并触发预测。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645200260860-4f7adc57d66017e1968db4db783322d948ae662ee883c6bac12cd824151d125c.png" alt="picture 45" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645200296274-3019781fc5146b961ac9f708f0a726c1b6e44dd7f744826c910811f0ab2c8368.png" alt="picture 46" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sdk-custom">SDK custom<a class="hash-link" href="#sdk-custom" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">implementation<a class="hash-link" href="#implementation" title="标题的直接链接">​</a></h3><p>一开始 <code>vertexShader</code> 中阉割旋转部分把 <code>gl_Position</code> 也阉割了，导致最后没有图形，补上来之后就有图形（三角形）了（但是是黑色）。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645473167572-7e9de9e0b54294f1a028c055f03e04feef939ac6fc999ef3858a697c3a246e8d.png" alt="picture 14" class="img_ev3q">  </p><p>黑色一般是着色没着成，检查了一下 <code>fragmentShader</code>，再对照官网case，果然，没有一个输出，加上后就有白色的三角形了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645473249075-64aa9719db7a5c5d6dc546d43da3ec1d331419343e26627893db4d846645ef9f.png" alt="picture 15" class="img_ev3q">  </p><p>!!!tip
结果后来发现，这个 <code>gl_FragColor</code> 是 1.0 版本产物，现在也不行……</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">![picture 19](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645475488760-5af09bfacb12d4acff18135c3bc7a7e9b88507f59a99b01802c5a055be5e9c4c.png)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">最后确定是用 `gl_FragColor` 但是不要加 `out`，并且我换成 `FragColor`也是不对的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">![picture 20](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645475598339-b17bd92138afbcf1e6b702deb6bb8343b6b8dc25c1d9d2837ab8226be565d743.png)  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着发现 <code>timewarp</code> 没效果，以为是 <code>a_texcoord</code> 没生效，于是测试添加一个明显的、固定的 <code>a_texcoord</code>，测了几个，结果还是不行。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645473308231-3f3e5430ae706d1d1b9db9146256cb625fbb9180cb269ec277d23cd3cf9a5590.png" alt="picture 16" class="img_ev3q">  </p><p>后来研究这部分函数<code>gl_FragColor = texture2D(eye_texture, t);</code>发现 <code>timewarp</code> 其实就是重新设置了贴纸的中心坐标（所以并没有什么神奇的），既然是这样，再联系我们之前的三角形问题，由于我们三角形的颜色是单一的白色，自然，就没有任何变化了（因为中心坐标无论在哪，周围都是白色）。</p><p>FIXME: 基于此，我突然想到，要是我们设置一个超出范围（0-1）的坐标，基于官网裁切、重复那部分章节，或许至少能有不一样的效果。</p><p>但是很遗憾，还是没有，如下，我设置成了 (1.2, 1.3) 都不行。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645473483639-3d66cd01ea124abea037b2b3c5e968f708b97a80631a0cd1e11cd95eca6e446d.png" alt="picture 17" class="img_ev3q">  </p><p>!!!tip
原来还有一个错误，这么设置固定的数组是不行的……</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">![picture 18](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645475387056-cbd35f7a3eb856a7013f6071f26fa976417fac0efb9c3b1a76cd029e44d7d7fc.png)  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但这也不是不可以接受，因为和教程中那个场景还是有可能不一样的，不过这个不是重点，这条路暂时不行，也不用深究，还有一个更加稳妥的办法，那就是换贴纸。</p><p>参照官网换贴纸的案例：<a href="https://github.com/JoeyDeVries/LearnOpenGL/blob/master/src/1.getting_started/4.1.textures/textures.cpp" target="_blank" rel="noopener noreferrer">LearnOpenGL/textures.cpp at master · JoeyDeVries/LearnOpenGL</a>：</p><hr><p>终于，有图片了，但是好奇怪，是非常扭曲的那种，即便我取消了一切shader操作也不行……</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645475869127-92d956fbb5f8ec89162b9032d4ace551539a665d142b13c25715148ad598074d.png" alt="picture 21" class="img_ev3q">  </p><p>经过不懈尝试，使用3.3+版本的 <code>glad</code> 结合官网的 <code>shader</code> <a href="https://github.com/JoeyDeVries/LearnOpenGL/tree/master/src/1.getting_started/4.1.textures" target="_blank" rel="noopener noreferrer">LearnOpenGL/src/1.getting_started/4.1.textures at master · JoeyDeVries/LearnOpenGL</a> 完成了初步的正常显示，如下：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645476671858-7f13ef4d3a1a5cbe5bc94e56ee958a99f5ce6d7c858e30112913ba3f0050b168.png" alt="picture 22" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixme-gluniformmatrix4fv-is-depreciated">FIXME: <code>glUniformMatrix4fv is depreciated</code><a class="hash-link" href="#fixme-gluniformmatrix4fv-is-depreciated" title="标题的直接链接">​</a></h3><p>We can find the definition of <code>glUniformMatrix4gv</code> at here <a href="https://www.khronos.org/registry/OpenGL-Refpages/es2.0/xhtml/glUniform.xml" target="_blank" rel="noopener noreferrer">glUniform</a>:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645260666205-78d660fb4698d0633c567e4e45c8b3993ee93fc59ec4b14b6a288edec9a82250.png" alt="picture 4" class="img_ev3q">  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="todo-获取的姿态不等于我们对buffer要做的操作">TODO: 获取的姿态不等于我们对buffer要做的操作<a class="hash-link" href="#todo-获取的姿态不等于我们对buffer要做的操作" title="标题的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixed-how-to-init-c-class">FIXED: how to init C++ class<a class="hash-link" href="#fixed-how-to-init-c-class" title="标题的直接链接">​</a></h3><p>As mentioned in <a href="https://stackoverflow.com/questions/12248703/creating-an-instance-of-class" target="_blank" rel="noopener noreferrer">c++ - Creating an instance of class - Stack Overflow</a>, we can use: <code>Foo* foo1 = new Foo ();</code> or <code>Foo foo2</code> to declare an instance of a class.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixed-how-to-import-glint">FIXED: how to &quot;import&quot; <code>GLint</code><a class="hash-link" href="#fixed-how-to-import-glint" title="标题的直接链接">​</a></h3><p>Just to add <code>#include &lt;OpenGL/gl.h&gt;</code>, then we can use <code>GLint</code>, since Mac has opengl supported built-in.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645259030449-7aa80cf0fc080c767693b49aff0c655c3cd67a046ec9aff8ad397c0deb38ebf1.png" alt="picture 2" class="img_ev3q">  </p><p>It&#x27;s inspired from <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/OpenGL-MacProgGuide/opengl_drawing/opengl_drawing.html#//apple_ref/doc/uid/TP40001987-CH404-SW8" target="_blank" rel="noopener noreferrer">Drawing to a Window or View</a>:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645259097457-7a57f4b719c630bcef342108e3d18ecb4da10e4bab214bbebd05766279ad500d.png" alt="picture 3" class="img_ev3q">  </p><p>More detailed configuration (on Windows) can be learned from <a href="https://www.youtube.com/watch?v=AUFZnA3lW_Q" target="_blank" rel="noopener noreferrer">How To Set Up OpenGL (and freeglut) on MinGW w/ CLion + Run Demo Programs | Game/3D programming - YouTube</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="framework-logic">Framework Logic<a class="hash-link" href="#framework-logic" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="intro-programcachecpp">intro: <code>ProgramCache.cpp</code><a class="hash-link" href="#intro-programcachecpp" title="标题的直接链接">​</a></h3><p>晓研哥说Shader的逻辑是在 <code>frameworks/native/libs/renderengine/gl/ProgramCache.cpp</code>，一开始我还表示十分怀疑，因为是一个带<code>Cache</code>名的文件。</p><p>但进去之后一看，不得了，都在这里。</p><p>比如 <code>VertexShader</code>:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645104307789-42761414203cb15cd5ed1663583d311b7d7dc3e75d04dc36d32c3822d1785d60.png" alt="picture 8" class="img_ev3q">  </p><p>还有 <code>FragmentShader</code>:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645104326249-7ac30af4022c1d56c473a522421cb052cf98c951e92f575dd4a745f13503c34e.png" alt="picture 9" class="img_ev3q">  </p><p>这两个Shader都是生成函数，并且还都集中定义在一个函数 <code>generateProgram</code> 下：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645104352170-2c953257331770aa542ec425632168b87c0c07ce33d86abc3a43d8a049febc54.png" alt="picture 10" class="img_ev3q">  </p><p>而 <code>generateProgram</code> 又是在 <code>useProgram</code> 函数下调用的（还有一些其他地方也在调用 <code>generateProgram</code>，但是主逻辑应该是在 <code>useProgram</code>这里 ）。</p><p><code>useProgram</code> 中接收 <code>EGLContext</code> 和 <code>Description</code>，其中 <code>Description</code> 用于生成 <code>needs</code>。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645102966351-cfa524c9390dfd2c1452687d26c92607379ca8b37cf039d0711e9601c3583c9d.png" alt="picture 4" class="img_ev3q">  </p><p><code>computeKey</code> 函数中对 <code>description</code> 进行处理，将目标属性一一加在 <code>needs</code> 上。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645103160792-1d33d27b31cabfd26ead64960e7b7f74cfb1d284cfd84f8e4350cc5e66c2082c.png" alt="picture 5" class="img_ev3q">  </p><p><code>Description</code> 是在 <code>renderengine/private/Description.h</code> 中定义的。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645103200832-a0e4bdaed9541deb5e4c5cc852e8a196dfc2beab98b053144a6c07826ab3afab.png" alt="picture 6" class="img_ev3q">  </p><p>具体位置是在 <code>frameworks/native/libs/renderengine/include/renderengine/private/Description.h</code></p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645103893037-f67f0b8dc2b57a71d1414a286fbb2088113b8c530e13595c44c42e79b482f1f9.png" alt="picture 7" class="img_ev3q">  </p><p>可以看到，还是比较复杂的，定义了很多属性，估计是全局的。</p><p>我们可能要基于这些属性，去操纵我们的目标。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filter-out-uniform-logic">filter out <code>uniform</code> Logic<a class="hash-link" href="#filter-out-uniform-logic" title="标题的直接链接">​</a></h3><p>We have seen some <code>uniform</code> variables defined in <code>Shader</code> language, such as <code>displayMaxLuminance</code>.</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645399159611-f4cf7fe64b23e2a05dae5e1dae7420059fcc67839b0f2e46b0757dc2d3f04c2e.png" alt="picture 1" class="img_ev3q">  </p><p>搜索发现，其实就是在 <code>Prime.cpp</code> 中进行赋值的。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645399323930-5c12eb631d6bbfb2fbfdc6d840c3ce1f72a177dde7a775f981f3c31cfeffe496.png" alt="picture 2" class="img_ev3q">  </p><p>可以看到，就是用 <code>glGetUniformLocation</code> 函数获得地址，接着用<code>glUniform1f</code> 基于 <code>Description &amp; desc</code> 进行赋值。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645399412540-12c6a9d96c1adf88ed88f8e70b8f5b863e170e627f04eb1a436bda3be3c4d18c.png" alt="picture 3" class="img_ev3q">  </p><p>不过这里有个疑惑，这个 <code>Program::Program</code> 的初始化，<code>vertex</code> 和 <code>fragment</code> 都是 <code>const char *</code>，和我们之前看到的不断的加文本不太一样，所以得看一下是怎么初始化的。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-vertexshader-and-fragmentshader">add <code>vertexShader</code> and <code>fragmentShader</code><a class="hash-link" href="#add-vertexshader-and-fragmentshader" title="标题的直接链接">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="timewarp-forecast">Timewarp Forecast<a class="hash-link" href="#timewarp-forecast" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="documentation">documentation<a class="hash-link" href="#documentation" title="标题的直接链接">​</a></h3><p>✨✨ 这是关于姿态的非常好的介绍资料</p><ul><li><a href="http://www.crazepony.com/book/wiki/attitude-math.html" target="_blank" rel="noopener noreferrer">姿态的数学表示方法 | Crazepony开源四轴飞行器</a></li></ul><p>✨✨ 这是一篇非常好的，手把手的基于MA和动量的时间序列预测教程：</p><ul><li><a href="https://phdinds-aim.github.io/time_series_handbook/02_LinearForecastingTrendandMomentumForecasting/02_LinearTrendandMomentumForecasting.html#momentum-strategies" target="_blank" rel="noopener noreferrer">Chapter 2: Linear, Trend, and Momentum Forecasting — Time Series Analysis Handbook</a></li></ul><p>✨✨ 理解卡尔曼滤波</p><ul><li><a href="https://www.zhihu.com/question/23971601" target="_blank" rel="noopener noreferrer">(19 封私信 / 68 条消息) 如何通俗并尽可能详细地解释卡尔曼滤波？ - 知乎</a></li></ul><p>✨✨ 理解传感器融合</p><ul><li><a href="https://www.youtube.com/watch?v=6qV3YjFppuc&amp;t=59s" target="_blank" rel="noopener noreferrer">Understanding Sensor Fusion and Tracking, Part 1: What Is Sensor Fusion? -
YouTube</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="workflow">workflow<a class="hash-link" href="#workflow" title="标题的直接链接">​</a></h3><div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="timewarp-algo">Timewarp Algo<a class="hash-link" href="#timewarp-algo" title="标题的直接链接">​</a></h2><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * see: glm of &quot;./ext/matrix_transform.inl&quot; 153L, 4728B</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @param m </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @param v </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @return </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mat4 </span><span class="token function" style="color:#d73a49">translate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mat4 m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vec3 v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mat4 </span><span class="token function" style="color:#d73a49">result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="markupdate2022-02-25-timewarp-framework-test">mark::update@2022-02-25: timewarp framework test<a class="hash-link" href="#markupdate2022-02-25-timewarp-framework-test" title="标题的直接链接">​</a></h2><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->timewarp 的 matrix 没有打印出来（可能是添加位置错误，那个地方是初始化用的）</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->timewarp shader效果异常（可能是 TexCoords 问题，因为输入是 vec4, 我们需要 vec2</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="打印-timewarp-matrix">打印 timewarp matrix<a class="hash-link" href="#打印-timewarp-matrix" title="标题的直接链接">​</a></h3><p>发现根本没有走我们的逻辑！</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645781575138-e73b62170a17742737c2602a69f32ae9125c07680404a719796eed62c4f8cc68.png" alt="picture 42" class="img_ev3q">  </p><p>所以这个时候需要 ide 进行调试了。</p><p>定位到我们打印 matrix 的部分，是在 <code>Program::setUniform</code> 里，后来我们加了断点，结果发现，逻辑是走的，但是我们的变量没有触发：</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645786799310-6446b04b1c59393fdaaa5387a859e0aba47f9bfbb52e83a357024fefa06a77aa.png" alt="picture 43" class="img_ev3q">  </p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645786832556-355194cfe1b92f8cc10676469801ca61e9f799f6886e5377ae2ffde2e68cbad3.png" alt="picture 44" class="img_ev3q">  </p><hr><p>修改后发现，还剩一个 <code>mArparaTimewarpEnableLoc</code> 没绑定上。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645787489410-6d0f8a7e51c55e30ca01dd0a09cbe83a81e62b446261a3095d4325f8afa4e3d1.png" alt="picture 45" class="img_ev3q">  </p><p>知道原因了，原来是被优化了。</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645787592305-c48c145796b8014da362311f9e7b50ef6b29e138d7a766cd9b29cf112d5d6321.png" alt="picture 46" class="img_ev3q">  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-change-log-level">can we change log level?<a class="hash-link" href="#can-we-change-log-level" title="标题的直接链接">​</a></h2><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adb shell setprop log.tag.XXX V</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ref: - <a href="https://stackoverflow.com/questions/2018263/how-do-i-enable-disable-log-levels-in-android" target="_blank" rel="noopener noreferrer">logging - How do I enable/disable log levels in Android? - Stack Overflow</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-debug-shader">can we debug shader?<a class="hash-link" href="#can-we-debug-shader" title="标题的直接链接">​</a></h2><p>see at <a href="https://stackoverflow.com/questions/41161346/is-it-possible-to-debug-shaders-in-android-opengl-es-2" target="_blank" rel="noopener noreferrer">Is it possible to debug shaders in Android OpenGL ES 2? - Stack Overflow</a>, it&#x27;s impossible:</p><p><img loading="lazy" src="https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/tw-research-1645781153080-6f7d1ae10fe226550c62e358e8ef6c070e4f3699e15b1ef40d3af976c6f6c055.png" alt="picture 40" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/markshawn2020/keeps-learning/edit/master/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-research.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2022-07-27T08:43:29.000Z">2022年7月27日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC1-timewarp/tw-bugfix"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">atw bugfix</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/keeps-learning/docs/AndroidFramework/timewarp/TaskC2-opengl/opengl-howto"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">opengl howto</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#timewarp-guide" class="table-of-contents__link toc-highlight">Timewarp Guide</a></li><li><a href="#source-code-research" class="table-of-contents__link toc-highlight">Source Code Research</a><ul><li><a href="#decide-the-target-code" class="table-of-contents__link toc-highlight">decide the target code</a></li></ul></li><li><a href="#sdk-logic-backward-track" class="table-of-contents__link toc-highlight">SDK Logic Backward-track</a></li><li><a href="#sdk-logic-forward-implementation" class="table-of-contents__link toc-highlight">SDK Logic Forward-implementation</a><ul><li><a href="#step-1-vertexshader-and-fragmentshader" class="table-of-contents__link toc-highlight">step 1. <code>vertexShader</code> and <code>fragmentShader</code></a></li><li><a href="#25-初始化-pose" class="table-of-contents__link toc-highlight">2.5. 初始化 <code>Pose</code></a></li><li><a href="#26-获取-pose" class="table-of-contents__link toc-highlight">2.6 获取 <code>Pose</code></a></li></ul></li><li><a href="#sdk-custom" class="table-of-contents__link toc-highlight">SDK custom</a><ul><li><a href="#implementation" class="table-of-contents__link toc-highlight">implementation</a></li><li><a href="#fixme-gluniformmatrix4fv-is-depreciated" class="table-of-contents__link toc-highlight">FIXME: <code>glUniformMatrix4fv is depreciated</code></a></li><li><a href="#todo-获取的姿态不等于我们对buffer要做的操作" class="table-of-contents__link toc-highlight">TODO: 获取的姿态不等于我们对buffer要做的操作</a></li><li><a href="#fixed-how-to-init-c-class" class="table-of-contents__link toc-highlight">FIXED: how to init C++ class</a></li><li><a href="#fixed-how-to-import-glint" class="table-of-contents__link toc-highlight">FIXED: how to &quot;import&quot; <code>GLint</code></a></li></ul></li><li><a href="#framework-logic" class="table-of-contents__link toc-highlight">Framework Logic</a><ul><li><a href="#intro-programcachecpp" class="table-of-contents__link toc-highlight">intro: <code>ProgramCache.cpp</code></a></li><li><a href="#filter-out-uniform-logic" class="table-of-contents__link toc-highlight">filter out <code>uniform</code> Logic</a></li><li><a href="#add-vertexshader-and-fragmentshader" class="table-of-contents__link toc-highlight">add <code>vertexShader</code> and <code>fragmentShader</code></a></li></ul></li><li><a href="#timewarp-forecast" class="table-of-contents__link toc-highlight">Timewarp Forecast</a><ul><li><a href="#documentation" class="table-of-contents__link toc-highlight">documentation</a></li><li><a href="#workflow" class="table-of-contents__link toc-highlight">workflow</a></li></ul></li><li><a href="#timewarp-algo" class="table-of-contents__link toc-highlight">Timewarp Algo</a></li><li><a href="#markupdate2022-02-25-timewarp-framework-test" class="table-of-contents__link toc-highlight">mark::update@2022-02-25: timewarp framework test</a><ul><li><a href="#打印-timewarp-matrix" class="table-of-contents__link toc-highlight">打印 timewarp matrix</a></li></ul></li><li><a href="#can-we-change-log-level" class="table-of-contents__link toc-highlight">can we change log level?</a></li><li><a href="#can-we-debug-shader" class="table-of-contents__link toc-highlight">can we debug shader?</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/keeps-learning/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/keeps-learning/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Docusaurus</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/category/guides" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/keeps-learning/assets/js/runtime~main.62df1d2c.js"></script>
<script src="/keeps-learning/assets/js/main.402f255e.js"></script>
</body>
</html>