"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3915],{3905:(e,a,n)=>{n.d(a,{Zo:()=>o,kt:()=>f});var t=n(67294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function c(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function p(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=t.createContext({}),s=function(e){var a=t.useContext(l),n=a;return e&&(n="function"==typeof e?e(a):c(c({},a),e)),n},o=function(e){var a=s(e.components);return t.createElement(l.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},u=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,o=p(e,["components","mdxType","originalType","parentName"]),u=s(n),f=r,m=u["".concat(l,".").concat(f)]||u[f]||d[f]||i;return n?t.createElement(m,c(c({ref:a},o),{},{components:n})):t.createElement(m,c({ref:a},o))}));function f(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=n.length,c=new Array(i);c[0]=u;var p={};for(var l in a)hasOwnProperty.call(a,l)&&(p[l]=a[l]);p.originalType=e,p.mdxType="string"==typeof e?e:r,c[1]=p;for(var s=2;s<i;s++)c[s]=n[s];return t.createElement.apply(null,c)}return t.createElement.apply(null,n)}u.displayName="MDXCreateElement"},4702:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>h,contentTitle:()=>f,default:()=>b,frontMatter:()=>u,metadata:()=>m,toc:()=>k});var t=n(3905),r=Object.defineProperty,i=Object.defineProperties,c=Object.getOwnPropertyDescriptors,p=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,o=(e,a,n)=>a in e?r(e,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[a]=n,d=(e,a)=>{for(var n in a||(a={}))l.call(a,n)&&o(e,n,a[n]);if(p)for(var n of p(a))s.call(a,n)&&o(e,n,a[n]);return e};const u={},f="surfaceflinger patch research",m={unversionedId:"AndroidFramework/TaskA5-sf-patches/sf-patch-research-2021",id:"version-0.16.0/AndroidFramework/TaskA5-sf-patches/sf-patch-research-2021",title:"surfaceflinger patch research",description:"- gerrit codes",source:"@site/versioned_docs/version-0.16.0/AndroidFramework/TaskA5-sf-patches/sf-patch-research-2021.md",sourceDirName:"AndroidFramework/TaskA5-sf-patches",slug:"/AndroidFramework/TaskA5-sf-patches/sf-patch-research-2021",permalink:"/keeps-learning/docs/0.16.0/AndroidFramework/TaskA5-sf-patches/sf-patch-research-2021",draft:!1,editUrl:"https://github.com/markshawn2020/keeps-learning/edit/master/docs/AndroidFramework/TaskA5-sf-patches/sf-patch-research-2021.md",tags:[],version:"0.16.0",lastUpdatedAt:1658910797,formattedLastUpdatedAt:"2022\u5e747\u670827\u65e5",frontMatter:{},sidebar:"docs",previous:{title:"surfaceflinger display research",permalink:"/keeps-learning/docs/0.16.0/AndroidFramework/TaskA4-sf-research/sf-howto"},next:{title:"surfaceflinger patch research 2022",permalink:"/keeps-learning/docs/0.16.0/AndroidFramework/TaskA5-sf-patches/sf-patch-research-2022"}},h={},k=[{value:"gerrit codes",id:"gerrit-codes",level:2},{value:"search the target gerrit",id:"search-the-target-gerrit",level:3},{value:"patch 1 &amp; 2 analysis",id:"patch-1--2-analysis",level:2},{value:"definition",id:"definition",level:3},{value:"classification",id:"classification",level:3},{value:"EASY: suppress <code>#error</code> problem of imported <code>gls2.h</code>",id:"easy-suppress-error-problem-of-imported-gls2h",level:3},{value:"EASY: <code>services/surfaceflinger/Android.mk</code>",id:"easy-servicessurfaceflingerandroidmk",level:3},{value:"PASS: <code>libs/gui/GLConsumer.cpp</code>",id:"pass-libsguiglconsumercpp",level:3},{value:"variable initialization",id:"variable-initialization",level:4},{value:"<code>services/surfaceflinger/SurfaceFlinger.cpp</code>",id:"servicessurfaceflingersurfaceflingercpp",level:3},{value:"part 1. initFB",id:"part-1-initfb",level:4},{value:"part 2. function of <code>initFB</code>",id:"part-2-function-of-initfb",level:4},{value:"HARD: part 3. <code>doComposeSurfaces</code>",id:"hard-part-3-docomposesurfaces",level:4},{value:"drawing flow",id:"drawing-flow",level:4},{value:"doComposeSurfaces code flow",id:"docomposesurfaces-code-flow",level:4},{value:"rendering client layers",id:"rendering-client-layers",level:4},{value:"\u7f16\u8bd1",id:"\u7f16\u8bd1",level:2},{value:"\u76ee\u524d\u7b56\u7565",id:"\u76ee\u524d\u7b56\u7565",level:3},{value:"\u76ee\u524d\u7b56\u7565\u66f4\u65b0@2022-01-27 15:16:38",id:"\u76ee\u524d\u7b56\u7565\u66f4\u65b02022-01-27-151638",level:3},{value:"\u2705 <code>error: use of undeclared identifier &#39;dirty&#39;</code>",id:"-error-use-of-undeclared-identifier-dirty",level:3},{value:"\u2705 <code>error: use of undeclared identifier &#39;displayTransform&#39;</code>",id:"-error-use-of-undeclared-identifier-displaytransform",level:3},{value:"\u2705 <code>error: unknown type name &#39;Transform&#39;</code>",id:"-error-unknown-type-name-transform",level:3},{value:"\u2705 <code>error: no member named &#39;draw&#39; in &#39;android::Layer&#39;</code>",id:"-error-no-member-named-draw-in-androidlayer",level:3},{value:"\u2705 <code>error: use of undeclared identifier &#39;mRenderEngine&#39;; did you mean &#39;renderEngine&#39;?</code>",id:"-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine",level:3},{value:"\u2705 <code>error: too few arguments to function call, expected 5, have 3 (RenderEngine-&gt;setupLayerBlending)</code>",id:"-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending",level:3},{value:"\u2705 <code>error: use of undeclared identifier &#39;renderArea&#39;</code>",id:"-error-use-of-undeclared-identifier-renderarea",level:3},{value:"\u7ec8\u4e8e\u6210\u529f\u4e86\uff012022-01-27 23:37:03",id:"\u7ec8\u4e8e\u6210\u529f\u4e862022-01-27-233703",level:3},{value:"\u5e74\u524d\u4e3b\u8981\u5de5\u4f5c\u76ee\u6807",id:"\u5e74\u524d\u4e3b\u8981\u5de5\u4f5c\u76ee\u6807",level:2},{value:"pre-check list",id:"pre-check-list",level:3},{value:"core 1 list",id:"core-1-list",level:3},{value:"core 2 list",id:"core-2-list",level:3},{value:"core 3 list",id:"core-3-list",level:3},{value:"\u5e74\u524d\u4e3b\u8981\u56f0\u96be\u5206\u6790",id:"\u5e74\u524d\u4e3b\u8981\u56f0\u96be\u5206\u6790",level:2},{value:"<code>Layer.cpp</code>\u4e2d\u5173\u4e8e<code>win</code>\u548c<code>position</code>",id:"layercpp\u4e2d\u5173\u4e8ewin\u548cposition",level:3},{value:"\u53ef\u75911. <code>Layer::prepareClientComposition()</code>",id:"\u53ef\u75911-layerprepareclientcomposition",level:4},{value:"\u53ef\u75912. <code>InputWindowInfo Layer::fillInputInfo()</code>",id:"\u53ef\u75912-inputwindowinfo-layerfillinputinfo",level:4},{value:"position\u4f3c\u4e4e\u6ca1\u6709\u88ab\u8c03\u7528\u7684\u56f0\u60d1",id:"position\u4f3c\u4e4e\u6ca1\u6709\u88ab\u8c03\u7528\u7684\u56f0\u60d1",level:4},{value:"<code>surfaceflinger.cpp</code>\u4e2d\u5173\u4e8e <code>doComposeSurfaces</code>",id:"surfaceflingercpp\u4e2d\u5173\u4e8e-docomposesurfaces",level:3}],g={toc:k};function b(e){var a,n=e,{components:r}=n,o=((e,a)=>{var n={};for(var t in e)l.call(e,t)&&a.indexOf(t)<0&&(n[t]=e[t]);if(null!=e&&p)for(var t of p(e))a.indexOf(t)<0&&s.call(e,t)&&(n[t]=e[t]);return n})(n,["components"]);return(0,t.kt)("wrapper",(a=d(d({},g),o),i(a,c({components:r,mdxType:"MDXLayout"}))),(0,t.kt)("h1",d({},{id:"surfaceflinger-patch-research"}),"surfaceflinger patch research"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#gerrit-codes"}),"gerrit codes"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#search-the-target-gerrit"}),"search the target gerrit")))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#patch-1--2-analysis"}),"patch 1 & 2 analysis"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#definition"}),"definition")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#classification"}),"classification")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#easy-suppress-error-problem-of-imported-gls2h"}),"EASY: suppress ",(0,t.kt)("inlineCode",{parentName:"a"},"#error")," problem of imported ",(0,t.kt)("inlineCode",{parentName:"a"},"gls2.h"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#easy-servicessurfaceflingerandroidmk"}),"EASY: ",(0,t.kt)("inlineCode",{parentName:"a"},"services/surfaceflinger/Android.mk"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#pass-libsguiglconsumercpp"}),"PASS: ",(0,t.kt)("inlineCode",{parentName:"a"},"libs/gui/GLConsumer.cpp")),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#variable-initialization"}),"variable initialization")))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#servicessurfaceflingersurfaceflingercpp"}),(0,t.kt)("inlineCode",{parentName:"a"},"services/surfaceflinger/SurfaceFlinger.cpp")),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#part-1-initfb"}),"part 1. initFB")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#part-2-function-of-initfb"}),"part 2. function of ",(0,t.kt)("inlineCode",{parentName:"a"},"initFB"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#hard-part-3-docomposesurfaces"}),"HARD: part 3. ",(0,t.kt)("inlineCode",{parentName:"a"},"doComposeSurfaces"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#drawing-flow"}),"drawing flow")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#docomposesurfaces-code-flow"}),"doComposeSurfaces code flow")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#rendering-client-layers"}),"rendering client layers")))))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E7%BC%96%E8%AF%91"}),"\u7f16\u8bd1"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E7%9B%AE%E5%89%8D%E7%AD%96%E7%95%A5"}),"\u76ee\u524d\u7b56\u7565")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E7%9B%AE%E5%89%8D%E7%AD%96%E7%95%A5%E6%9B%B4%E6%96%B02022-01-27-151638"}),"\u76ee\u524d\u7b56\u7565\u66f4\u65b0@2022-01-27 15:16:38")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-use-of-undeclared-identifier-dirty"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: use of undeclared identifier 'dirty'"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-use-of-undeclared-identifier-displaytransform"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: use of undeclared identifier 'displayTransform'"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-unknown-type-name-transform"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: unknown type name 'Transform'"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-no-member-named-draw-in-androidlayer"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: no member named 'draw' in 'android::Layer'"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: use of undeclared identifier 'mRenderEngine'; did you mean 'renderEngine'?"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: too few arguments to function call, expected 5, have 3 (RenderEngine->setupLayerBlending)"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#white_check_mark-error-use-of-undeclared-identifier-renderarea"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"a"},"error: use of undeclared identifier 'renderArea'"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E7%BB%88%E4%BA%8E%E6%88%90%E5%8A%9F%E4%BA%862022-01-27-233703"}),"\u7ec8\u4e8e\u6210\u529f\u4e86\uff012022-01-27 23:37:03")))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E5%B9%B4%E5%89%8D%E4%B8%BB%E8%A6%81%E5%B7%A5%E4%BD%9C%E7%9B%AE%E6%A0%87"}),"\u5e74\u524d\u4e3b\u8981\u5de5\u4f5c\u76ee\u6807"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#pre-check-list"}),"pre-check list")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#core-1-list"}),"core 1 list")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#core-2-list"}),"core 2 list")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#core-3-list"}),"core 3 list")))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E5%B9%B4%E5%89%8D%E4%B8%BB%E8%A6%81%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90"}),"\u5e74\u524d\u4e3b\u8981\u56f0\u96be\u5206\u6790"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#layercpp%E4%B8%AD%E5%85%B3%E4%BA%8Ewin%E5%92%8Cposition"}),(0,t.kt)("inlineCode",{parentName:"a"},"Layer.cpp"),"\u4e2d\u5173\u4e8e",(0,t.kt)("inlineCode",{parentName:"a"},"win"),"\u548c",(0,t.kt)("inlineCode",{parentName:"a"},"position")),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E5%8F%AF%E7%96%911-layerprepareclientcomposition"}),"\u53ef\u75911. ",(0,t.kt)("inlineCode",{parentName:"a"},"Layer::prepareClientComposition()"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#%E5%8F%AF%E7%96%912-inputwindowinfo-layerfillinputinfo"}),"\u53ef\u75912. ",(0,t.kt)("inlineCode",{parentName:"a"},"InputWindowInfo Layer::fillInputInfo()"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#position%E4%BC%BC%E4%B9%8E%E6%B2%A1%E6%9C%89%E8%A2%AB%E8%B0%83%E7%94%A8%E7%9A%84%E5%9B%B0%E6%83%91"}),"position\u4f3c\u4e4e\u6ca1\u6709\u88ab\u8c03\u7528\u7684\u56f0\u60d1")))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",d({parentName:"li"},{href:"#surfaceflingercpp%E4%B8%AD%E5%85%B3%E4%BA%8E-docomposesurfaces"}),(0,t.kt)("inlineCode",{parentName:"a"},"surfaceflinger.cpp"),"\u4e2d\u5173\u4e8e ",(0,t.kt)("inlineCode",{parentName:"a"},"doComposeSurfaces")))))),(0,t.kt)("h2",d({},{id:"gerrit-codes"}),"gerrit codes"),(0,t.kt)("h3",d({},{id:"search-the-target-gerrit"}),"search the target gerrit"),(0,t.kt)("p",null,"search: ",(0,t.kt)("inlineCode",{parentName:"p"},"status:merged project:oneos/platform/frameworks/native branch:project-dev")),(0,t.kt)("p",null,"url: ",(0,t.kt)("a",d({parentName:"p"},{href:"http://192.168.0.241:8080/#/q/status:merged+project:oneos/platform/frameworks/native+branch:project-dev"}),"http://192.168.0.241:8080/#/q/status:merged+project:oneos/platform/frameworks/native+branch:project-dev")),(0,t.kt)("h2",d({},{id:"patch-1--2-analysis"}),"patch 1 & 2 analysis"),(0,t.kt)("h3",d({},{id:"definition"}),"definition"),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"p1")," \u6307 patch 1\uff0c\u5373 ",(0,t.kt)("inlineCode",{parentName:"p"},"merge from rk3399")),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"p2")," \u6307 patch 2\uff0c\u5373 ",(0,t.kt)("inlineCode",{parentName:"p"},"feature vr 2d mode")),(0,t.kt)("p",null,"p2 \u57fa\u4e8e p1\uff0c\u4e2d\u95f4\u8fd8\u6709\u5176\u4ed6\u4e00\u4e2acommit\uff0c\u4e0d\u8fc7\u8c8c\u4f3c\u548cp2\u65e0\u5173\uff0c\u4e0d\u6784\u6210\u4f9d\u8d56\u5173\u7cfb\u3002"),(0,t.kt)("p",null,"\u76ee\u524d\u57fa\u4e8e",(0,t.kt)("inlineCode",{parentName:"p"},"combinediff"),"\u5c06",(0,t.kt)("inlineCode",{parentName:"p"},"p1"),"\u4e0e",(0,t.kt)("inlineCode",{parentName:"p"},"p2"),"\u5408\u5e76\u4e5f\u662f\u6ca1\u6709\u95ee\u9898\uff0c\u4e0d\u62a5\u9519\u7684\u3002"),(0,t.kt)("p",null,"p1\u6539\u52a8\u6d89\u53ca\u523060\u4e2a\u5de6\u53f3\u7684\u6587\u4ef6\uff0c\u4e3b\u8981\u4f5c\u7528\u662faosp\u5411rk\u7684\u9002\u914d\uff08\u5927\u81f4\u4f5c\u7528\u80af\u5b9a\u662f\u8fd9\u4e2a\uff0c\u5177\u4f53\u573a\u666f\u7b49\u4e0d\u6e05\u695a\uff09\uff0c\u800cp2\u6539\u52a8\u6d89\u53ca9\u4e2a\uff0c\u4f7f\u652f\u6301\u4e86vr\u6a21\u5f0f\u7684\u529f\u80fd\u3002"),(0,t.kt)("p",null,"p1\u548cp2\u4e4b\u95f4\u6709\u51e0\u4e2a\u6587\u4ef6\u662f\u91cd\u5408\u7684\uff0c\u4e5f\u5c31\u662f\u5148\u540e\u6539\u52a8\u7684\uff0c\u56e0\u6b64\u8981\u60f3\u76f4\u63a5\u6253patch 2\uff0c\u9700\u8981\u5bf9patch 1\u4e2d\u76f8\u5173\u7684\u6587\u4ef6\u8fdb\u884c\u5206\u6790\uff0c\u7406\u51fa\u4e13\u5c5e\u4e8ep2\u7684\u6539\u52a8\u7684\u6781\u5c0f\u96c6\u3002"),(0,t.kt)("h3",d({},{id:"classification"}),"classification"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-text"}),"Both in p1, p2:\n\n- [ ] libs/gui/GLConsumer.cpp\n- [ ] services/surfaceflinger/Android.mk\n- [ ] services/surfaceflinger/Layer.cpp\n- [ ] services/surfaceflinger/Layer.h\n- [ ] services/surfaceflinger/SurfaceFlinger.cpp\n- [ ] services/surfaceflinger/SurfaceFlinger.h\n\nAdded in p2:\n\n- [ ] libs/gui/include/gui/ISurfaceComposerClient.h\n- [ ] services/surfaceflinger/HmdType6DistortionMesh.cpp\n- [ ] services/surfaceflinger/HmdType6DistortionMesh.h\n")),(0,t.kt)("p",null,"\u8fd9\u4e9b\u6587\u4ef6\u5927\u6982\u53ef\u4ee5\u5206\u6210\u4ee5\u4e0b\u51e0\u7ec4\uff0c\u5e76\u5206\u6279\u5206\u6790\u5b8c\u6210\u3002"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"\u7f16\u8bd1\u90e8\u5206\uff1a",(0,t.kt)("inlineCode",{parentName:"li"},"Android.mk"),"\uff0c\u5f88\u7b80\u5355\uff0cp1\u4e0d\u7528\u8003\u8651\uff0c\u76f4\u63a5\u8003\u8651\u5728p2\u4e2d\u52a0\u4e00\u4e2acpp\u5373\u53ef\u3002"),(0,t.kt)("li",{parentName:"ol"},"\u4e0d\u7528\u8003\u8651\u4f46\u4e24\u90e8\u5206\u90fd\u6709\u7684\u6587\u4ef6\uff1a",(0,t.kt)("inlineCode",{parentName:"li"},"GLConsumer.cpp"),"\uff0c\u8fd9\u4e2a\u6587\u4ef6\u7ecf\u8fc7\u5206\u6790\uff0c\u6ca1\u6709\u5fc5\u8981\u52a8\u3002"),(0,t.kt)("li",{parentName:"ol"},"\u4e0d\u7528\u52a8\u8111\u7684\u6838\u5fc3\u6587\u4ef6:",(0,t.kt)("inlineCode",{parentName:"li"},"ISurfaceComposerClient.h"),"\uff0c\u8fd9\u4e2a\u6587\u4ef6\u4e3b\u8981\u662f\u5b9a\u4e49\u4e86\u4e00\u4e2avr\u53d8\u91cf\uff0c\u4f9b",(0,t.kt)("inlineCode",{parentName:"li"},"surfaceflinger"),"\u4f7f\u7528\uff0c\u6240\u4ee5\u5f88\u7b80\u5355\u3002"),(0,t.kt)("li",{parentName:"ol"},"\u4e0d\u7528\u4fee\u6539\u7684\u4e24\u4e2a\u6838\u5fc3\u6587\u4ef6\uff1a",(0,t.kt)("inlineCode",{parentName:"li"},"HmdType6DistortionMesh.cpp|h"),"\uff0c\u8fd9\u4e24\u4e2a\u6587\u4ef6\u57fa\u672c\u53ef\u4ee5\u5199\u6b7b\uff0c\u800c\u4e14\u662f\u57fa\u4e8e\u7b97\u6cd5\u81ea\u52a8\u751f\u6210\u7684\uff0c\u6240\u4ee5\u4e5f\u4e0d\u9700\u8981\u624b\u6539\u3002"),(0,t.kt)("li",{parentName:"ol"},"\u9700\u8981\u770b\u4f46\u4e0d\u96be\u7684\u4e24\u4e2a\u6838\u5fc3\u6587\u4ef6\uff1a",(0,t.kt)("inlineCode",{parentName:"li"},"Layer.cpp|h"),"\uff0c\u8fd9\u4e24\u4e2a\u6587\u4ef6\u8981\u770b\u4e00\u4e0b\u3002"),(0,t.kt)("li",{parentName:"ol"},"\u9700\u8981\u770b\u6700\u96be\u7684\u4e24\u4e2a\u6838\u5fc3\u6587\u4ef6\uff1a",(0,t.kt)("inlineCode",{parentName:"li"},"surfaceflinger.cpp|h"),"\uff0c\u91cd\u70b9\u5206\u6790\uff01"),(0,t.kt)("li",{parentName:"ol"},"\u5176\u5b83\u53ea\u5728p1\u4e2d\u52a8\u7684\u6587\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u6682\u65f6\u5148\u4e0d\u770b\uff0c\u5982\u679c\u63a5\u4e0b\u6765\u7f16\u8bd1\u6709\u7528\u5230\u7684\uff0c\u518d\u52a0\uff01")),(0,t.kt)("h3",d({},{id:"easy-suppress-error-problem-of-imported-gls2h"}),"EASY: suppress ",(0,t.kt)("inlineCode",{parentName:"h3"},"#error")," problem of imported ",(0,t.kt)("inlineCode",{parentName:"h3"},"gls2.h")),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f \u4e0d\u6ce8\u91ca\u8fd9\u4e2a\u5c31\u7f16\u4e0d\u8fc7\u53bb\uff0cluci\u7528\u7684\u65e7\u7248\u4f9d\u8d56\uff0c\u6216\u8005\u5355\u7eaf\u5730\u4e0d\u8be5\u628a\u5b83\u4eec\u5bfc\u5165\u5230 ",(0,t.kt)("inlineCode",{parentName:"p"},"surfaceflinger.cpp / Layer.cpp"),"\u5185")),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-sh"}),'sed  -E "s|(#error.*gl2)|//\\1|p" services/surfaceflinger/Layer.cpp\nsed  -E "s|(#error.*gl2)|//\\1|p" services/surfaceflinger/SurfaceFlinger.cpp\n')),(0,t.kt)("h3",d({},{id:"easy-servicessurfaceflingerandroidmk"}),"EASY: ",(0,t.kt)("inlineCode",{parentName:"h3"},"services/surfaceflinger/Android.mk")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643106263791-f437ddb26e9cb79f654853b88a29b64f8d9f9de30885faa31bb710648a3556f0.png",alt:"picture 41"})),"  "),(0,t.kt)("p",null,"p1\u5173\u4e8emk\u90e8\u5206\uff0c\u6700\u5927\u7684\u7bc7\u5e45\u662f",(0,t.kt)("inlineCode",{parentName:"p"},"rockchip support"),"\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8df3\u8fc7\uff0c\u770b\u4e86\u4e5f\u6ca1\u7528\uff0c\u76ee\u6807\u662f\u9ad8\u901a\u7684\u3002\uff08\u5982\u679c\u540e\u671f\u5b9e\u5728\u8981\u5bf9\u8fd9\u90e8\u5206\uff0c\u90a3\u5c31\u8ba4\u4e86\u5427\uff09"),(0,t.kt)("p",null,"\u9664\u6b64\u4e4b\u5916\uff0c\u5c31\u662f\u52a0\u4e86",(0,t.kt)("inlineCode",{parentName:"p"},"rk"),"\u4e13\u7528\u7684",(0,t.kt)("inlineCode",{parentName:"p"},"librga"),"\u4f9d\u8d56\uff0c\u8fd9\u4e2a\u9ad8\u901a\u4e5f\u7528\u4e0d\u7740\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643106525915-0556ab703bde3abacaa1c349aaae854f0ca887e0fe95340acee86a82caa20a8c.png",alt:"picture 42"})),"  "),(0,t.kt)("p",null,"p1\u5c31\u662f\u8fd9\u4e48\u4e9b\u6539\u52a8\uff0c\u6240\u4ee5\u5b9e\u9645\u4e0a\u5bf9\u9879\u76ee\u6ca1\u6709\u4efb\u4f55\u5e2e\u52a9\u3002"),(0,t.kt)("p",null,"p2\u5219\u52a0\u4e86\u4e00\u4e2a",(0,t.kt)("inlineCode",{parentName:"p"},"HmdType6DistortionMesh.cpp"),"\u7684\u4f9d\u8d56\uff0c\u5c31\u662f\u6211\u4eec\u81ea\u5df1\u7684\u90a3\u4e2a\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643106603903-23b4912d18a8053a444b0b247f94e5c560891a0ee252b35e2bb87f5352874967.png",alt:"picture 43"})),"  "),(0,t.kt)("p",null,"\u5728\u539f\u751f8\u7684",(0,t.kt)("inlineCode",{parentName:"p"},"Android.mk"),"\u4e2d\uff0c\u5b83\u5176\u5b9e\u5c31\u662f\u52a0\u5728",(0,t.kt)("inlineCode",{parentName:"p"},"LOCAL_SRC_FILES"),"\u91cc\u7684\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643109587318-b2da803315284f3547262e9706ab1bb73a568cc72e647c18d114e3a065da522f.png",alt:"picture 44"})),"  "),(0,t.kt)("p",null,"\u5c3d\u7ba18\u5df2\u7ecf\u6709",(0,t.kt)("inlineCode",{parentName:"p"},"Android.bp"),"\u4e86\uff0c\u4f46\u5176\u5b9e\u8fd8\u6ca1\u6b63\u5f0f\u5f00\u59cb\u7528\uff08TODO: \u5177\u4f53\u533a\u522b\u5f85\u67e5\uff09\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643116633259-574c82039d43cc89a3a7a9a9f2a1266bacc4274b22a481e9d3e0dde6e44f5474.png",alt:"picture 46"})),"  "),(0,t.kt)("p",null,"\u6240\u4ee5\u8981\u628a\u52a0cpp\u7684\u52a8\u4f5c\u6539\u523011\u7684",(0,t.kt)("inlineCode",{parentName:"p"},"bp"),"\u4e2d\u53bb\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643109875995-7539232556a1fa87e9ffb6910c80c63c2a7b31833dd97cc814efcd6816b7cbe6.png",alt:"picture 45"})),"  "),(0,t.kt)("p",null,"\u6839\u636e\u68c0\u7d22\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u8981\u52a0\u5728",(0,t.kt)("inlineCode",{parentName:"p"},"filegroup.srcs"),"\u4e0b\uff08\u548c",(0,t.kt)("inlineCode",{parentName:"p"},"Layer.cpp | FrameTracker.cpp"),"\u4e00\u8d77\uff09\u3002"),(0,t.kt)("p",null,"\u547d\u4ee4\u53ef\u5982\u4e0b\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-sh"}),"# mac sed -> gsed\n# :warning: alias need to work in next commands\nif [[ $(uname) == Darwin ]]; then alias sed=gsed; fi;\n")),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-sh"}),'# \u5728surfaceflinger/Android.bp\u5185\u52a0\u5165\u79c1\u6709\u5b9e\u73b0\nSRC="HmdType6DistortionMesh.cpp"\nT=\'"\'$SRC\'", // mark added at \'$(date +%Y-%m-%d\\ %H:%M:%S)\nF="services/surfaceflinger/Android.bp"\nP=\'"Layer.cpp",\'\nif grep $SRC $F;\nthen echo "found";\nelse echo "not found";\necho $T | sed \'s|^.*$|s_^(.*?)(\'$P\'.*)$_\\\\1\\\\2\\\\n\\\\1\\0_|\' | sed -i.bak -E -f- $F\nfi;\n')),(0,t.kt)("h3",d({},{id:"pass-libsguiglconsumercpp"}),"PASS: ",(0,t.kt)("inlineCode",{parentName:"h3"},"libs/gui/GLConsumer.cpp")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643103121263-7460c1d919e7a11e5e65830708304f8a20cc09bd6175822271cd62deeef3c31f.png",alt:"picture 34"})),"  "),(0,t.kt)("p",null,"\u5728",(0,t.kt)("inlineCode",{parentName:"p"},"GLConsumer.cpp"),"\u4e2d\uff0cp1\u4e3b\u8981\u662f\u52a0\u4e86\u4e00\u4e2a",(0,t.kt)("strong",{parentName:"p"},"\u5bf9\u9f50\u51fd\u6570"),"\uff1a"),(0,t.kt)("p",null,"cpp++\nbufferWidth = (cropRect.width() + 31) & (~31);"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{}),"\n\u5177\u4f53\u53ef\u4ee5\u770b\u6211\u548cchen\u59d0\u7684\u8bf7\u6559\u8bb0\u5f55\uff1a\n\n![picture 35](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104031704-cdeb8648205dc69ec4352cbda34fa9718f611cdf5b5e08c046e0d3ed1927bad0.png)  \n\n![picture 36](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104038721-0c2f2634d5070f0493f786e6a96626cf5d376545c8703d566149d21bc1d78dcc.png)  \n\n![picture 37](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104043233-a06964a558bbe6829684e3032f2f2a5b2efc439c70004fccb88b6a3a2e8c021a.png)  \n\n\u6240\u4ee5\uff0c\u5b9e\u9645\u4e0a p1\u53ea\u662f\u4e00\u4e2a\u5c0f\u5c0f\u7684\u6027\u80fd\u4f18\u5316\uff0c\u5bf9\u4e8e\u4e1a\u52a1\u6765\u8bf4\uff0c\u5e94\u8be5\u5f71\u54cd\u4e0d\u5927\uff0c\u4e0d\u8fc7\u786e\u5b9e\u662f\u503c\u5f97\u5173\u6ce8\u7684\u4e00\u4e2a\u6539\u52a8\uff0c\u5f97\u53bb11\u4e0a\u770b\u770b\u3002\n\n\u7136\u800c11\u770b\u7684\u7ed3\u679c\u5c31\u662f\uff0c\u5b8c\u5168\u6ca1\u6709\u8fd9\u56de\u4e8b\uff01\n\n![picture 38](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104398250-911dad0fe36ae180059835431f11e15d4e6150e50ab7806f75daea4506b345b8.png)  \n\n\u6240\u4ee5\uff0c\u6211\u4eec\u4e5f\u4e0d\u7528\u7ba1\u8fd9\u4e2a\u51fd\u6570\u4e86\uff01\n\n\u63a5\u7740\u662fp2\u4e2d\u7684\u6539\u52a8\uff0c\u5766\u767d\u8bf4\uff0c\u6211\u6ca1\u61c2\u4ed6\u6539\u52a8\u7684\u610f\u4e49\u3002\n\n![picture 1](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643032866621-9dd0251e560a24ddc5d1b91d91d8bbb013d2da3597a4887bca852187fcf2a09b.png)  \n\n\u5728\u539f\u6765\u7684\u903b\u8f91\u4e2d\uff0c\u6709\u4e00\u4e2a\u9759\u6001\u53d8\u91cf`sReleasedTexImageBuffer`\u521d\u59cb\u5316\u4e3a\u7a7a\uff0c\u7136\u540e\u63a5\u6536buffer\u6570\u636e\u3002\n\n\u8fd9\u662f\u4e00\u4e2a\u521d\u59cb\u5316\u8bbe\u8ba1\uff0c\u6ce8\u610f\u6ce8\u91ca\uff1a`// The first time, create the debug texture in case the application continues to use it.`\n\n\u4f46\u540e\u6765\u7684\u903b\u8f91\u4e2d\uff0c\u5374\u628a\u8fd9\u4e2a\u521d\u59cb\u5316\u5224\u65ad\u7ed9\u53bb\u6389\u4e86\uff0c\u4e8e\u662f\u4e4e\u6bcf\u6b21\u90fd\u4f1a\u65b0\u751f\u6210\u4e00\u4e2abuffer\uff08\u663e\u7136\uff0c\u8fd9\u4e2a\u6548\u7387\u4f1a\u5927\u5927\u964d\u4f4e\uff09\u3002\n\n\u5728\u53e6\u4e00\u4e2a\u5b98\u65b9diff\uff1a[Diff - 9870c9b^! - platform/frameworks/native - Git at Google](https://android.googlesource.com/platform/frameworks/native/+/9870c9b%5E!/) \u4e2d\uff08\u4e0d\u77e5\u9053\u662f\u54ea\u4e2a\u7248\u672c\u5bf9\u54ea\u4e2a\u7248\u672c\uff09\uff0c\u5f88\u6e05\u6670\u5730\u5c06\u539f\u5148\u7684\u83b7\u5f97`mReleasedTexImageBuffer`\u6539\u6210\u4e86\u83b7\u5f97`getDebugTexImageBuffer()`\u3002\n\n![picture 2](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643033403953-02c9e6213fd5519490cd23b29c05719ee9531b24ed9e97bf2ad9435991334eea.png)  \n\n\u57fa\u4e8e\u6b64\uff0c\u6709\u7406\u7531\u5224\u5b9a\uff0c\u8fd9\u91cc\u7684\u6539\u52a8\u53ea\u662f\u4e00\u4e2a`debug/release`\u6216\u521d\u59cb\u5316\u76f8\u5173\u7684\u533a\u522b\uff0c\u5bf9\u76ee\u524d\u7684vr\u96c6\u6210\u76ee\u6807\u53ef\u80fd\u6ca1\u6709\u4ec0\u4e48\u5f71\u54cd\uff0c\u53ea\u4e0d\u8fc7\u4ee4\u4eba\u56f0\u60d1\u7684\u662f\uff0c\u5b83\u7684\u6539\u52a8\u4f3c\u4e4e\u4e0e\u5b98\u65b9\u7684\u6539\u52a8\u6709\u4e9b\u76f8\u8fd1\uff0c\u5374\u53c8\u4e0d\u5b8c\u5168\u4e00\u6837\uff0c\u4e0d\u77e5\u5230\u5e95\u662f\u7248\u672c\u5347\u7ea7\u7684\u95ee\u9898\u8fd8\u662f\u5565\uff08\u6bd4\u5982\u8bf4\u4f7f\u7528debug\u7684\u7248\u672c\u662f8\uff0c\u800c\u6e90\u4ee3\u7801\u7248\u672c\u662f7\uff0c\u4e8e\u662f\u4e3a\u4e86\u5c067\u7684\u90e8\u5206\u5347\u7ea7\u62108\uff0c\u5c31\u7528\u4e86\u8fd9\u79cd\u6539\u52a8\u529e\u6cd5\uff0c\u4ec5\u4ec5\u662f\u4e00\u79cd\u731c\u6d4b\uff0c\u5f88\u6709\u53ef\u80fd\u4e0d\u5bf9\uff09\n\n\u5177\u4f53\u89c1\u6211\u548c\u6653\u7814\u54e5\u7684\u8ba8\u8bba\uff1a\n\n![picture 40](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104628305-66437969f15d8a23eb8f491d7e2d8c0e8839c24a0c7238396fe1df0317abcbf1.png)  \n\ncheck\u4e86\u4e00\u4e0b11\u4e2d\u7684\u4ee3\u7801\uff0c\u4e5f\u662f\u6ca1\u53d8\u7684\uff1a\n\n![picture 39](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643104552627-777845363dfb2d005d2c5e6aa9b3869987fcc1fec7a8e7880b5ac6ec54090c86.png)  \n\n\u6240\u4ee5p2\u7684\u6539\u52a8\u4e5f\u5ffd\u89c6\uff01\n\nref:\n\n- \u5b8c\u6574\u7684\u5b9e\u73b0\uff1a[libs/gui/GLConsumer.cpp - platform/frameworks/native - Git at Google](https://android.googlesource.com/platform/frameworks/native/+/master/libs/gui/GLConsumer.cpp)\n\n### EASY: `services/surfaceflinger/Layer.h`\n\n> :sparkles: \u89c1\u8bc6\u5230`\u5bf9\u6bd4\u6d4f\u89c8\u5206\u6790(line in side)`\u7684\u5f3a\u5927\u4e86\u5427\uff01\n\n![picture 51](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643132425592-dc09daee4b9581cabb5142d14c3cee28a9714568f336451ac657a3609793a513.png)  \n\n\u53ef\u4ee5\u770b\u5230\uff0c\u5728 `Layer.h` \u4e2d\uff0cp1\u91cc\u57fa\u672c\u90fd\u662f\u5b9a\u4e49\u7684\u548c rk \u76f8\u5173\u7684\u53d8\u91cf\u548c\u51fd\u6570\uff0c\u867d\u7136\u6709\u4e00\u4e2a `RK_VR` \u7684\u53d8\u91cf\u548c\u903b\u8f91\u5904\u7406\u5f88\u5438\u5f15\u6ce8\u610f\u529b\uff0c\u4f46\u662f\u8be2\u95ee\u4e86\u6653\u7814\u5f97\u5230\u7684\u56de\u590d\u90fd\u662f\u660e\u786e\u7684\u4e0d\u7528\u770b\u3002\n\n![picture 52](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643132607551-8c8e22178f1d4f0ad220e613f209239047cef5fea7b0c5f6ec0b4217acda5427.png)  \n\n\u800c p2 \u5f88\u7b80\u5355\uff0c\u5c31\u662f\u52a0\u5165\u4e86vr\u7684\u53d8\u91cf\u6807\u8bc6\uff0c\u5e76\u63d0\u4f9b\u4e86`get | set`\u7684\u65b9\u6cd5\u3002\n\n![picture 14](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643041501426-002bd50f36a307ff05a627d558984c31d8ce0877b03b6bb2b21fcc2264c88963.png)  \n\n### `services/surfaceflinger/Layer.cpp`\n\n#### HARD: `win.right = hw->getWidth();`\n\n![picture 53](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643133906128-eaaf0240b6d8e31bda6fcaf21527e860a64303c889e1a90f8966e45f0e5de36e.png)  \n\n\u4e0d\u51fa\u610f\u5916\uff0cp1\u4e2d\u6709\u5927\u91cf\u548cRK\u76f8\u5173\u7684\u5b9a\u4e49\u4e0e\u5b9e\u73b0\uff0c\u7bc7\u5e45\u5f88\u957f\uff0c\u76ee\u6d4b\u4e3b\u8981\u5b9e\u73b0\u4e86`RK_VR`\u548c`RK_STEREO`\u4e24\u4e2a\u6a21\u5f0f\uff0c\u4f46\u6839\u636e\u6653\u7814\u6307\u793a\uff0c\u90fd\u4e0d\u7528\u770b\uff0c\u8fd9\u6837\u7684\u8bdd\uff0c\u5c31\u5b9e\u9645\u4e0a\u7b49\u4e8ep1\u6ca1\u6539\u5565\u4e86\u3002\n\n\u552f\u4e00\u6539\u7684\u5f71\u54cd\u5230p2\u7684\u5e94\u8be5\u662f\u8fd9\u4e2a`win`\uff0c\u5b83\u628a\u539f\u5148\u7684`ComputeBounds`\u6539\u6210\u4e86`FloatRectBounds`\uff0c\u4f30\u8ba1\u662f\u4e3a\u4e86\u66f4\u7cbe\u786e\u7684\u5b9e\u73b0\u65cb\u8f6c\u3001VR\u7b49\u53d8\u6362\u7684\u610f\u601d\u5427\u3002\u4f46\u5bf9p2\u7684\u63a5\u53e3\u5374\u662f\u53ef\u4ee5\u4e0d\u53d8\u7684\uff0c\u76ee\u6d4b\u6765\u770b\u3002\u4e5f\u5c31\u662f\u4ee5\u4e0b\u4ee3\u7801\u51e0\u4e4e\u53ef\u4ee5\u7167\u6284\u3002\n\ncpp++\n    if(mIsVr) {\n        win.right = hw->getWidth();\n    }\n\n")),(0,t.kt)("p",null,"\u800c\u5b83\u7684\u4e0b\u65b9\u5c31\u662f"),(0,t.kt)("p",null,"cpp++\nfloat left   = float(win.left)   / float(s.active.w);\nfloat top    = float(win.top)    / float(s.active.h);\nfloat right  = float(win.right)  / float(s.active.w);"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{}),'\n~~\u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e2a\u5199sed\u811a\u672c\u3002~~\n\n\u7136\u800c\uff0c\u8fd9\u4e2a\u60f3\u6cd5\u5931\u8d25\u4e86\uff0c8\u523011\u53d8\u5f97\u592a\u5927\u4e86\uff0c\u5df2\u7ecf\u641c\u4e0d\u5230 ` float left   = float(win.left)   / float(s.active.w);` \u8fd9\u4e2a\u4e86\u3002\n\n![picture 54](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643134635239-1d6f9de87874186699deb6ed33071fb79b0389f60e8dab41332727b8da9010e8.png)  \n\n\u6240\u4ee5\u5f97\u5b9a\u4f4d\u5230\u51fa\u5904\u3002\n\n![picture 55](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643137004483-5b3b4140ab77de72ef4a5b848121194f6d2102e27c2fe23e84823f184ad2f7b8.png)  \n\n\u5728 `drawWithOpenGL` \u51fd\u6570\u4e2d\uff0c\u5b83\u63a5\u6536\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f`hw`\uff0c\u7c7b\u578b\u662f`DisplayDevice`\uff0c\u7d27\u63a5\u7740\u5f00\u59cb\u521b\u5efa`Rect`\u7c7b\u578b\u7684`win`\u53d8\u91cf\u3002\n\n\u6539\u52a8\u5c31\u662f\u5728\u8fd9\u91cc\u8fdb\u884c\u7684\uff0c\u4e00\u65e6\u68c0\u6d4b\u5230\u662fvr\u6a21\u5f0f\uff0c\u5c31\u8ba9\u8fd9\u4e2a`win`\u53d8\u91cf\u7684\u5bbd\u5ea6\u4fee\u6539\u4e3a`hw`\u7684\u5bbd\u5ea6\uff1a`win.right = hw->getWidth()`\u3002\n\n\u8fd9\u91cc\u6211\u4eec\u5f97\u77e5\u9053\u8fd9\u4e2a`computeBounds()`\u6784\u9020\u51fd\u6570\u662f\u548b\u56de\u4e8b\u3002\n\n![picture 56](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643137518943-d8297585f5c0fa99e05666d3eaeb3a8e87e544c55deb73dd390d224ab758b3c9.png)  \n\n\u8fd8\u597d\uff0c8\u548c11\u5728\u8fd9\u91cc\u7684\u533a\u522b\u4e0d\u662f\u5f88\u5927\uff0c\u53ea\u4e0d\u8fc7`computeBounds`\u540d\u5b57\u6539\u6210\u4e86`getBounds`\uff0c\u5185\u90e8\u5b9e\u73b0\u4e5f\u76f8\u5e94\u5730\u66f4\u7b80\u6d01\u4e86\u4e00\u4e9b\uff0c\u6838\u5fc3\u601d\u60f3\u5c31\u662f\u7a97\u53e3\u533a\u57df\u51cf\u53bb\u900f\u660e\u533a\u57df\uff0c\u5f97\u5230\u7684\u5c31\u662f\u6240\u8c13`Rect`\uff0c\u4e5f\u5c31\u662f\u5b9e\u9645\u533a\u57df\u5427\u3002~~\u81f3\u4e8e\u7ed3\u6784\u4f53\u662f\u5565\uff0c\u56db\u4e2a\u5750\u6807\u5417\uff0c\u8fd8\u662f\u5565\uff0c\u5e94\u8be5\u5012\u4e5f\u4e0d\u662f\u90a3\u4e48\u91cd\u8981\u3002~~\n\n\u4e0d\u8fc7\u8fd9\u6837\uff0c\u56de\u5230\u524d\u9762\u90a3\u4e2a\u51fd\u6570\uff1a`win.right = hw->getWidth`\u5c31\u6709\u70b9\u602a\u4e86\uff0c`hw`\u548c`getBounds()`\u4e4b\u95f4\u53c8\u662f\u4ec0\u4e48\u5173\u7cfb\u5462\u3002\n\nTODO: \u6211\u8fd9\u91cc\u5176\u5b9e\u4e3b\u8981\u56f0\u60d1\u7684\u5728\u4e8e\uff0c\u5982\u679c`win`\u662f\u6307\u90a3\u4e2a\u6d3b\u52a8\u7a97\u53e3\uff0c\u6bd4\u5982\u8bf4\u67d0\u4e2a\u6d6e\u52a8\u7a97\u53e3\uff0c\u90a3\u5728vr\u6a21\u5f0f\u4e0b\u5355\u72ec\u6539\u5176`right`\u4e3a`hw`\u7684\u5bbd\u5ea6\uff0c\u800c\u4e0d\u628a`left`\u6539\u62100\uff0c\u8fd9\u662f\u5426\u4f1a\u6709\u95ee\u9898\u5462\uff1f\u81f3\u5c11\u770b\u8d77\u6765\u4e0d\u662f\u90a3\u4e48\u5bf9\u79f0\uff0c\u6240\u4ee5\u8fd9\u91cc\u5728\u539f\u7406\u4e0a\u6765\u8bf4\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u56f0\u60d1\u3002\n\n\u8fd8\u662f\uff0c\u5148\u770b\u770b\u5982\u4f55\u572811\u4e2d\u5b9e\u73b0\u8fd9\u4e2a\u4fee\u6539\u5427\u3002\n\n##### \u53ef\u75911. `Layer::prepareClientComposition()`\n\n![picture 58](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138949603-bd8010805a1b2d7274c9adf4c6c21c43c549711742aadeb94d21c388e1468ca7.png)  \n\n\u5728\u8fd9\u5757\u91cc\uff0c\u6700\u5927\u7684\u53ef\u7591\u539f\u56e0\u662f\u6b63\u597d\u4e0e\u5de6\u8fb98\u7684\u7248\u672c\u5bf9\u9f50\uff0c\u5e76\u4e14\u51fd\u6570\u540d\u5c31\u662f\u5728\u753b\u56fe\uff1a\n\n![picture 59](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139039422-45fe81e61a85a9a61de7d2d34b40023143d959a149be023b1f89ef875e73a6eb.png)  \n\n\u53e6\u5916\u4e5f\u6709\u4e00\u4e2a\u5173\u952e\u8d4b\u503c\u8bed\u53e5\uff1a`layerSettings.geometry.boundaries = bounds;`\uff0c\u6211\u4eec\u82e5\u5728\u8d4b\u503c\u4e4b\u524d\uff0c\u4fee\u6539`bounds.right`\u4e3a`hw.getWidth()`\uff0c\u6216\u8bb8\u5c31\u548c8\u5bf9\u9f50\u4e86\u3002\n\n\u53ea\u4e0d\u8fc7\u6700\u5927\u7684\u95ee\u9898\u662f\uff0c\u8fd9\u4e2a\u51fd\u6570\u4e0d\u63a5\u6536`hw`\u7684\u53c2\u6570\u2026\u2026\uff0c\u6240\u4ee5\uff0c\u5f88\u53ef\u80fd\uff0c\u4e0d\u662f\u6211\u4eec\u76f8\u8981\u7684\u3002\n\n\u4f46\u6211\u53c8\u627e\u4e86\u4e00\u4e0b`hw`\u7684\u7c7b`DeviceDisplay`\uff0c\u53d1\u73b0\u8fd9\u4e2a\u6587\u4ef6\u91cc\u5f88\u5c11\u7528\uff1a\n\n![picture 60](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139341595-57becab0aa04cd092d41f5176b3f5afd575609567c75524f460af9e009e9996e.png)  \n\n\u5e76\u4e14 `hw->`\u7684\u8c03\u7528\u4e5f\u662f\u4e00\u4e2a\u90fd\u6ca1\u3002\n\n##### \u53ef\u75912. `InputWindowInfo Layer::fillInputInfo()`\n\n![picture 57](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138409793-047823adc1fbf5db5d36fc05a824d31ff9e81110a4ce1a4ef69833d217f0c026.png)  \n\n\u6211\u57fa\u4e8e`getBounds`\u51fd\u6570\u8ffd\u5230\u8fd9\u5757\uff08\u53ef\u75911\u4e5f\u6709`getBounds`\uff09\uff0c\u53d1\u73b0\u4ee3\u7801\u7ed3\u6784\u5c31\u6bd4\u8f83\u50cf\u76ee\u6807\u4ee3\u7801\u3002\u5c24\u5176\u662f`x|ySurfaceInset`\u7684\u6784\u9020\u4e0e\u4f7f\u7528\uff0c\u53ef\u4ee5\u770b\u5230`xSurfaceInset`\u4e5f\u7528\u5230\u4e86`layerBounds.getWidth()`\u51fd\u6570\uff0c\u5e76\u4e14\u540e\u7eed\u8fd8\u6709\u4e00\u53e5`layerBounds.inset(xSurfaceInset, ySurfaceInset, xSurfaceInset, ySurfaceInset);`\u770b\u8d77\u6765\u4eff\u4f5b\u5728\u6784\u9020\u4e24\u4e2a\u773c\u955c\u7684\u67d0\u4e9b\u53c2\u6570\u4e00\u6837\u3002\n\n#### MID: `position`\n\n![picture 61](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139564016-37973fb37dbac73e4fa89c3e2d7fb127e1415c0699dc370f39de3ffd47749d10.png)  \n\n\u5206\u6790\u4e86`win`\u540e\uff0c\u4e0b\u9762\u7684\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u5173\u4e8e`position`\u7684\uff0c\u7136\u800c\u5149\u4ece\u8fd9\u6bb5\u6765\u770b\u7684\u8bdd\uff0c\u4f3c\u4e4e\u6ca1\u6709\u8d77\u5230\u4efb\u4f55\u4f5c\u7528\uff0c\u4ec5\u4ec5\u662f\u4e00\u4e2a\u8d4b\u503c\uff0c\u6240\u4ee5\u4e0d\u592a\u61c2\u8fd9\u4e2a\u8bbe\u8ba1\u3002\u5982\u679c\u8fd9\u662f\u4e2a\u5168\u5c40\u53d8\u91cf\uff0c\u6211\u8fd8\u6bd4\u8f83\u660e\u767d\uff0c\u8bf4\u660e`position[2]`\u53ef\u80fd\u662f\u5de6\u773c\u53f3\u8fb9\u70b9\uff0c\u800c`position[3]`\u662f\u53f3\u773c\u5de6\u8fb9\u70b9\u3002\n\n### EASY: `libs/gui/include/gui/ISurfaceComposerClient.h`\n\n![picture 3](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643033846337-6802e52cc14b9224fef4725b5669c87755209b419956bd021bf4d9964743f521.png)  \n\n\u8be5\u6587\u4ef6\u4e2d\uff0c\u53ea\u589e\u52a0\u4e86\u4e00\u4e2a`eVrWindow`\u7684\u53d8\u91cf\u3002\n\n\u800c\u5b83\u5176\u5b9e\u53ea\u662f\u5728`surfaceflinger.cpp`\u4e2d\u7528\u4e8e\u5224\u65ad\u662f\u5426\u662f`vr`\u6a21\u5f0f\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\u76f4\u767d\u3002\n\n![picture 4](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643034044680-f14735982c660c54119d8c30ba2c493318c839a4dcc947981240d04b555f4b70.png)  \n\n#### MID: `services/surfaceflinger/HmdType6DistortionMesh.h`\n\n\u8fd9\u4e2a\u6587\u4ef6\u4e5f\u662f\u65b0\u589e\u7684\uff0c\u548c [[3/9, MID] `services/surfaceflinger/HmdType6DistortionMesh.cpp`](#39-mid-servicessurfaceflingerHmdType6DistortionMeshcpp) \u914d\u5957\uff0c\u662f\u5176\u5934\u6587\u4ef6\u5b9a\u4e49\uff0c\u9700\u8981\u4ed4\u7ec6\u5206\u6790\u4e00\u4e0b\u3002\n\n\u5176\u4e2d\'DistortionCorrection tool\' \u53ef\u4ee5\u751f\u6210mesh\u77e9\u9635\uff0c\u76ee\u524d\u8fd9\u4e2asdk\u540e\u7eed\u9700\u8981\u7684\u8bdd\u8fd8\u8981\u518d\u627e\u6653\u7814\u770b\u770b\u3002\n\n![picture 9](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643040148049-06f4be1b8f9329cbd382b432af2ed50f60d1f2570370536de4095854cbd4c8f0.png)  \n\n\u5927\u81f4\u7406\u89e3\u4e86\u4e00\u4e0b\uff1a\n\n1. ~~`#define HMD_TYPE6_DM_VERTCOUNT 10201` \u5e94\u8be5\u5c31\u662f\u5bbd\u5ea6\u50cf\u7d20`1020`\u4e58\u4ee510\u518d\u52a0\u4e00\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e2a\u50cf\u7d20\u70b9\u670910\u4e2a`vert`\uff0c\u5e94\u8be5\u662f\u6307`vertex`\u9876\u70b9\u7684\u610f\u601d~~\n2. `HMD_TYPE6_DM_WIDTH/HEIGHT`\u4ee3\u8868\u4e00\u4e2amesh\u7684\u5bbd\u4e0e\u9ad8\uff0c\u957f\u5ea6\u90fd\u662f100\uff0c\u4e5f\u5c31\u662f\u6709101\u4e2a\u9876\u70b9\uff0c\u6240\u4ee5\u4e00\u4e2amesh\u5c31\u6709`HMD_TYPE6_DM_VERTCOUNT = 101 * 101 = 10201`\u4e2a\u9876\u70b9\n3. `#define HMD_TYPE6_DM_IDXCOUNT  (HMD_TYPE6_DM_WIDTH * HMD_TYPE6_DM_HEIGHT * 3 * 2)` \uff1a\u4e24\u4e2a\u4e09\u89d2\u5f62\uff0c\u6bcf\u4e2a\u4e09\u89d2\u5f62\u4e09\u4e2a\u9876\u70b9\uff0c`IDXCOUNT`\u5c31\u662f\u603b\u7d22\u5f15\u6570\u7684\u610f\u601d\n4. `#define HMD_TYPE6_DM_ELEMCOUNT (HMD_TYPE6_DM_VERTCOUNT * 4)` \u6bcf\u4e2a`vert`\u5e94\u8be5\u67094\u4e2a\u7ef4\u5ea6\u7684\u6570\u636e\uff0c`x y u v` \u6216\u8005 `a b c d`\uff0c\u53ef\u4ee5\u770b\u505a\u662f\u7ed3\u6784\u4f53\u5185\u6700\u5c0f\u5355\u5143\u7684\u603b\u4e2a\u6570\n5. `#define HMD_TYPE6_DM_SIZE (HMD_TYPE6_DM_ELEMCOUNT * sizeof(float))` \u6240\u6709\u9876\u70b9\u7684\u5b58\u50a8\u7a7a\u95f4\u5927\u5c0f\n6. `#define HMD_TYPE6_DM_K0~5` \u516d\u4e2a\u53c2\u6570\n\n#### EASY: `services/surfaceflinger/HmdType6DistortionMesh.cpp`\n\n![picture 5](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643036038107-6f5bfa4f08a73c080083d6658e6c99c07bda32e73215ff0da0cc550426c67150.png)  \n\n\u8be5\u6587\u4ef6\u5c5e\u4e8e\u65b0\u589e\uff0c\u5185\u5bb9\u662f\u57fa\u4e8e\u7a0b\u5e8f\u81ea\u52a8\u751f\u6210\u7684\uff0c\u4e0d\u8fc7\u751f\u6210\u811a\u672c\u4e5f\u662f\u8001SDK\u4e86\u3002\n\n![picture 6](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643036091354-24e7e13ad10eeb2616e356fc5fb3c324683ec92e9c6fc0347b611ebe179a5fbb.png)  \n\n### MID: `services/surfaceflinger/SurfaceFlinger.h`\n\n![picture 62](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643141116414-687d66c090a80e5605ccb2195b6f58e78cb17670744a61c5488e8aae8e1f495c.png)  \n\np1\u91cc\u9762\u5168\u662f\u548cRK\u76f8\u5173\u7684\uff0c\u6ca1\u5565\u597d\u770b\u7684\uff0c\u76f4\u63a5\u770bp2\u3002\n\n![picture 16](https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643042375823-7b1c802f21be285ac5167118355b488311204fe26cfb06c306d771a612851110.png)  \n\np2\u91cc\u4e3b\u8981\u662f\u5b9a\u4e49\u4e868\u4e2a\u53d8\u91cf\u548c1\u4e2a\u521d\u59cb\u5316\u51fd\u6570\u3002\n\n\u5176\u4e2d4\u4e2a\u53d8\u91cf\u90fd\u662fmesh\uff0c\u4e24\u4e2a\uff08`mLeftEyeMesh | mRightEyeMesh`\uff09\u662fvr\u6a21\u5f0f\u4e0b\u7684\u5de6\u53f3\u773cmesh\uff0c\u4e24\u4e2a\uff08`mLMesh | mRMesh`\uff09\u5e94\u8be5\u662f\u6b63\u5e38\u60c5\u51b5\u4e0b\u7684\u5de6\u53f3\u773cmesh\u3002\n\n`mDistortionEnabled`\u63a7\u5236\u662f\u5426\u542f\u7528\u53cd\u7578\u53d8\u3002\n\n`mFrameBuffer | mTextureName | mTexture` \u5e94\u8be5\u90fd\u662f\u4e3a `initFB` \u51fd\u6570\u670d\u52a1\u7684\u3002\n\n\u73b0\u5728\uff0c\u6211\u4eec\u8981\u8ffd\u8e2a\u4e00\u4e0b\uff0c\u8fd9\u51e0\u4e2a\u5305\u7684\u5bfc\u5165\u95ee\u9898\uff0c\u56e0\u4e3aAPI\u53d8\u52a8\u5f88\u5927\u3002\n\n\u9996\u5148\u662f`Mesh.h`\u548c`Texture.h`\uff0c\u539f\u5148\u57288\u4e2d\u662f\u5728`surfaceflinger/RenderEngine`\u4e0b\uff0c11\u5219\u6362\u4e86\u5730\u65b9\uff1a\n\n```sh\n\u279c  native git:(b8293fd0e0) \u2717 find . -name "Mesh.h"\n./libs/renderengine/include/renderengine/Mesh.h\n\n\u279c  native git:(b8293fd0e0) \u2717 find . -name "Texture.h"\n./libs/renderengine/include/renderengine/Texture.h\n')),(0,t.kt)("p",null,"\u8ffd\u8fc7\u53bb\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643141519785-f873abee7c470d96e142c3aa5364827a8a82bb4123ea6c6eaa34c801dc63c45d.png",alt:"picture 63"})),"  "),(0,t.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0c\u57288\u7684",(0,t.kt)("inlineCode",{parentName:"p"},"surfaceflinger.cpp"),"\u4e2d\u9700\u8981\u7684\u4e24\u4e2a\u51fd\u6570",(0,t.kt)("inlineCode",{parentName:"p"},"getPositionArray()"),"\u548c",(0,t.kt)("inlineCode",{parentName:"p"},"getTexCoordArray()"),"\u90fd\u5728\uff0c\u8fd9\u8bf4\u660eapi\u63a5\u53e3\u6ca1\u53d8\uff0c\u53ea\u662f\u4f4d\u7f6e\u53d8\u4e86\uff0c\u90a3\u5c31\u6bd4\u8f83\u597d\u8bf4\u3002\u57fa\u4e8e\u6b64\uff0c",(0,t.kt)("inlineCode",{parentName:"p"},"Texture.h"),"\u7684\u8c03\u7528\u90e8\u5206\u6682\u65f6\u5c31\u4e0d\u770b\u4e86\uff0c\u5e94\u8be5\u6bd4\u8f83\u7a33\u59a5\u3002"),(0,t.kt)("p",null,"update at 2022-01-27: NO! \u7f16\u8bd1\u523010\u540e\u53d1\u73b0\u6709\u5404\u79cd\u95ee\u9898\uff0c\u4e3b\u8981\u662f\u8bed\u6cd5\u5c42\u9762\u7684\uff0c\u540e\u6765\u53d1\u73b0\uff0c\u63a5\u53e3\u8fd8\u662f\u6709\u4e00\u4e9b\u53d8\u5316\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643256750858-a6fc4675727af6e51e1500700eaec2cd7d3be2feaae48ba2dac19424d599e11c.png",alt:"picture 89"})),"  "),(0,t.kt)("p",null,"\u9996\u5148\uff0c\u5982\u4e0a\uff0c\u547d\u540d\u7a7a\u95f4\u6709\u53d8\u5316\uff0c\u539f\u6765\u662f",(0,t.kt)("inlineCode",{parentName:"p"},"android::Mesh"),"\uff0c\u73b0\u5728\u53d8\u6210",(0,t.kt)("inlineCode",{parentName:"p"},"android::renderengine::Mesh"),"\u4e86\u3002"),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"gl2.h"),"\u548c",(0,t.kt)("inlineCode",{parentName:"p"},"gl2ext.h"),"\u7684\u4f4d\u7f6e\u4e0d\u592a\u4e00\u6837\uff0c\u5728\u53e6\u4e00\u4e2a\u6a21\u5757\u4e0b\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-sh"}),'\u279c  native git:(b8293fd0e0) \u2717 find . -name "gl2.h"\n./opengl/include/GLES2/gl2.h\n\n\u279c  native git:(b8293fd0e0) \u2717 find . -name "gl2ext.h"\n./opengl/include/GLES2/gl2ext.h\n')),(0,t.kt)("p",null,"\u4f46\u672c\u8d28\u8fd8\u662f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u4ee3\u7801\u5e94\u8be5\u5c31\u6bd4\u8f83\u597d\u5199\u4e86\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5c31\u662f\u628a",(0,t.kt)("inlineCode",{parentName:"p"},"RenderEngine"),"\u6539\u6210",(0,t.kt)("inlineCode",{parentName:"p"},"renderengine"),"\u5176\u5b83\u7167\u6284\u3002\u524d\u7f00\u5e94\u8be5\u4e0d\u7528\u52a0\u4e86\uff0c\u56e0\u4e3a",(0,t.kt)("inlineCode",{parentName:"p"},"include"),"\u4e0b\u5e94\u8be5\u4f1a\u6709\u73af\u5883\u53d8\u91cf\uff0c\u81ea\u52a8\u80fd\u641c\u7d22\u5230\u3002"),(0,t.kt)("h4",d({},{id:"variable-initialization"}),"variable initialization"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643184157839-37d1c335d7b499ec969a1e6772e7ca1b23cdab2daabb0f64366f3ee2c80a56af.png",alt:"picture 74"})),"  "),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643184227668-9c72ba2d4ab05453921ad65bca9735089fc63a0966706c0883373601e8476b1b.png",alt:"picture 75"})),"  "),(0,t.kt)("p",null,"\u5bf9\u6bd4\u6765\u770b\uff0c\u786e\u5b9a\u628a\u521d\u59cb\u5316\u53d8\u91cf\u5199\u5728\u4f4d\u7f6e5\u5373\u53ef\u3002"),(0,t.kt)("h3",d({},{id:"servicessurfaceflingersurfaceflingercpp"}),(0,t.kt)("inlineCode",{parentName:"h3"},"services/surfaceflinger/SurfaceFlinger.cpp")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643142332055-4ad345818863122d35aca8a353f315178b086666c831a3fefd0e32257b294f1d.png",alt:"picture 64"})),"  "),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"surfaceflinger.cpp"),"\u7684p1\u91cc\u5bf9\u65cb\u8f6c\u505a\u4e86\u8f83\u591a\u7684\u8003\u8651\uff0c\u5e76\u4e14\u8fd8\u5305\u62ec\u4e00\u70b9\u975eRK\u5c5e\u6027\u7684\u4fee\u6539\uff0c\u597d\u5728\u6211\u4eec\u76ee\u524d\u4e5f\u4e0d\u7528\u65cb\u8f6c\uff0c\u6240\u4ee5p1\u5bf9\u4e8e\u6211\u4eec\u6765\u8bf4\u4f9d\u65e7\u53ef\u4ee5\u5ffd\u89c6\u3002"),(0,t.kt)("p",null,"\u63a5\u4e0b\u6765\u91cd\u70b9\u770bp2\u3002"),(0,t.kt)("h4",d({},{id:"part-1-initfb"}),"part 1. initFB"),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f \u7f16\u8bd1\u987a\u5e8f\u6709\u95ee\u9898\u3002\u601d\u8def\uff0c\u5bf9\u68078\u91cc\u9762\u7684\u4e00\u4e9b\u521d\u59cb\u5316\u53d8\u91cf\uff0c\u572811\u4e2d\u627e\u5bf9\u5e94\u7684\u65b0\u7684\u6784\u9020\u65b9\u5f0f\u3002")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643042777978-417faf89b357d77feae1fa777d737459a5d70a6214656aba3790a419963e4898.png",alt:"picture 17"})),"  "),(0,t.kt)("p",null,"\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\uff0c",(0,t.kt)("inlineCode",{parentName:"p"},"mLeftEyeMesh/mRightEyeMesh"),"\u548c",(0,t.kt)("inlineCode",{parentName:"p"},"mLMesh/mRMesh"),"\u7684\u521d\u59cb\u5316\u53c2\u6570\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u4e3a\u5565\u8fd9\u4e48\u521d\u59cb\u5316\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u5f62\u8c61\u8ba4\u8bc6\u3002"),(0,t.kt)("p",null,"\u26a0\ufe0f \u8fd9\u6bb5\u4e2d\u5199\u4e86\u4e00\u4e9b\u6bd4\u8f83\u5173\u952e\u7684\u7cfb\u7edf\u53c2\u6570\uff0c\u662f\u6211\u4eec\u9700\u8981\u53bb\u9a8c\u8bc1\u6838\u5b9e\u7684\uff0c\u503c\u5f97\u5f15\u8d77\u6ce8\u610f\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-yaml"}),"## /system/build.prop\npersist.sys.framebuffer.main=1920x1080\n\n# HDMI display:\nsys.hwc.device.primary=HDMI-A \n# VRG:\nsys.hwc.device.primary=DP\n")),(0,t.kt)("p",null,"\u800c\u4ed6\u8bf4",(0,t.kt)("inlineCode",{parentName:"p"},"uint32_t width = 1920; // half of display size"),"\uff0c\u8bf4\u660e\u5bbd\u5ea6\u90fd\u662f\u6309\u71673840\u6765\u7b97\u7684\u3002"),(0,t.kt)("p",null,"\u7136\u540e\u5c31\u662f\u5bf9\u680710\u7248\u672c\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643185687929-684a3a046f2ee223d226408e6c157616274f8c54702ac4feb37374240d8818de.png",alt:"picture 76"})),"  "),(0,t.kt)("p",null,"10\u91cc\u9762\u867d\u7136\u52a0\u4e86",(0,t.kt)("inlineCode",{parentName:"p"},"Factory"),"\u7684\u521d\u59cb\u5316\u65b9\u5f0f\uff0c\u4f46\u5176\u5b9e\u53ea\u662f\u5176\u4e2d\u4e00\u4e2a\u5c5e\u6027\uff0c\u6ce8\u610f\u770b",(0,t.kt)("inlineCode",{parentName:"p"},"mFactory"),"\u7684\u524d\u7f00",(0,t.kt)("inlineCode",{parentName:"p"},"m"),"\u4e0e\u5176\u4ed6\u7684",(0,t.kt)("inlineCode",{parentName:"p"},"mXXX"),"\u662f\u7b49\u4ef7\u7684\uff0c\u800c\u6211\u4eec\u8981\u52a0\u7684\u53d8\u91cf\u6b63\u662f",(0,t.kt)("inlineCode",{parentName:"p"},"mXXX"),"\u7c7b\u578b\uff0c\u6240\u4ee5\u5c31\u53ef\u4ee5\u4e0d\u7528\u7ba1",(0,t.kt)("inlineCode",{parentName:"p"},"mFactory"),"\u91cc\u9762\u662f\u4ec0\u4e48\uff0c\u56e0\u4e3a\u662f\u540c\u7ea7\u7684\u3002"),(0,t.kt)("h4",d({},{id:"part-2-function-of-initfb"}),"part 2. function of ",(0,t.kt)("inlineCode",{parentName:"h4"},"initFB")),(0,t.kt)("p",null,"\u26a0\ufe0f \u76ee\u6d4b ",(0,t.kt)("inlineCode",{parentName:"p"},"initFB")," \u51fd\u6570\u7edd\u5927\u90e8\u5206\u90fd\u4e0d\u9700\u8981\u6539\uff0c\u4e0d\u8fc7\u6709\u4e00\u4e2a\u7cfb\u7edf\u5c5e\u6027 ",(0,t.kt)("inlineCode",{parentName:"p"},"vr.luci.distortion.enable")," \u503c\u5f97\u6ce8\u610f\uff0c\u4f1a\u57fa\u4e8e\u8fd9\u4e2a\u51b3\u5b9a\u662f\u5426\u542f\u7528\u53cd\u7578\u53d8\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643045333549-7ac057aaa61ddf8c4e60350e3789827e11e3bee1b3a21781326ec0399fcec2a5.png",alt:"picture 19"})),"  "),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/research-diff-1643045571855-3c6ce4abe57b1c9aef7c01beffec3e8f4422b45c0e980bd444f28dfcafd8099b.png",alt:"picture 20"})),"  "),(0,t.kt)("h4",d({},{id:"hard-part-3-docomposesurfaces"}),"HARD: part 3. ",(0,t.kt)("inlineCode",{parentName:"h4"},"doComposeSurfaces")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144378837-b02055303c54561f2c6769b85e61e9213186d752c210af0d1d507899a61f690a.png",alt:"picture 65"})),"  "),(0,t.kt)("p",null,"\u5f88\u60e8\u554a\uff0c8\u91cc\u9762\u7684\u63a5\u53e3\u76f4\u63a5\u88ab\u5265\u4e86\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144504135-08af60009b0a7f5dfecaf1b01b1d718be6b7aefaed131e72e18aa2a3a0e33496.png",alt:"picture 66"})),"  "),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144692166-10a3bf592b15344ddcc3939b5f372ccde6f8ca9d275aaee1f53c1a12e2e47478.png",alt:"picture 67"})),"  "),(0,t.kt)("p",null,"\u592a\u60e8\u4e86\uff01\u6b63\u597d\u662f10->11\u63a5\u53e3\u88ab\u5265\u4e86\uff01"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643145769167-82f36a6b3eb301404a04d6cbdb6ece0c9751161413fa7882fad10c07da2661ce.png",alt:"picture 68"})),"  "),(0,t.kt)("h4",d({},{id:"drawing-flow"}),"drawing flow"),(0,t.kt)("p",null,"ref: ",(0,t.kt)("a",d({parentName:"p"},{href:"https://waynewolf.github.io/2014/06/22/surfaceflinger-and-client/"}),"https://waynewolf.github.io/2014/06/22/surfaceflinger-and-client/")),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-text"}),'handleMessageRefresh\n     |\u2014> preComposition\n     |\u2014> rebuildLayerStacks\n     |\u2014> setUpHWComposer\n          |\u2014> HWComposer::createWorkList <== hwc="" structures="" are="" allocated="" |\u2014=""> Layer::setGeometry()\n          |\u2014  set per frame data\n          |\u2014  HWComposer::prepare\n               |\u2014> hwc prepare\n     |\u2014> doComposition\n          |---- skip composition on external display if condition meets\n          |\u2014> doDisplayComposition\n          |    |\u2014> doComposeSurfaces\n          |     |\u2014> DisplayDevice::swapBuffers\n          |          |\u2014> eglSwapBuffers\n          |          |\u2014> FramebufferSurface::advanceFrame\n          |\u2014> DisplayDevice::flip(\u2026)     <== just="" update="" statistics="" count="" |--=""> Call DisplayDevice::compositionComplete(), notify each display\n               |--\x3e DisplaySurface::compositionComplete()\n                    |--\x3e FramebufferSurface::compositionComplete()\n                         |--\x3e HWComposer::fbCompositionComplete()\n                              |--\x3e NoOP if HWC >= 1.1\n                              |--\x3e used only in framebuffer device case.\n          |\u2014> postFrameBuffer\n               |\u2014> HWComposer::commit\n                    |\u2014> hwc set\n                    |\u2014> update retireFenceFd of hwc_display_contents_1\n               |\u2014> DisplayDevice::onSwapBuffersCompleted\n                    |\u2014> FramebufferSurface::onFrameComitted\n               |\u2014> Layer::onLayerDisplayed\n               |\u2014   update some statistics\n     |\u2014> postComposition \n')),(0,t.kt)("p",null,"ref: ",(0,t.kt)("a",d({parentName:"p"},{href:"https://zhuanlan.zhihu.com/p/127324424"}),"https://zhuanlan.zhihu.com/p/127324424")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643146727064-cfab15ef79d008d64d5c5c29bb93680cfbfe470563fb4a9b1fac82a572690c18.png",alt:"picture 69"})),"  "),(0,t.kt)("h4",d({},{id:"docomposesurfaces-code-flow"}),"doComposeSurfaces code flow"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-text"}),"handleMessageRefresh -> doComposition -> doDisplayComposition -> doComposeSurfaces\n")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Preparation work:",(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},"If GLES and hwc compositing, clear frame buffer target first"),(0,t.kt)("li",{parentName:"ul"},"If GLES only, drawWarmHole first"))),(0,t.kt)("li",{parentName:"ul"},"Render layers to framebuffer",(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},"For all layers if using hwc",(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},"do nothing if HWC_OVERLAY layer, display hardware will blend the layer"),(0,t.kt)("li",{parentName:"ul"},"render with opengl if HWC_FRAMEBUFFER layer, call layer->draw()"),(0,t.kt)("li",{parentName:"ul"},"set the layer\u2019s acquireFence"))),(0,t.kt)("li",{parentName:"ul"},"For all layers if no hwc",(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},"just render with OpenGL, call layer->draw()"))))),(0,t.kt)("li",{parentName:"ul"},"Now all the GLES layers are drawn on frame buffer target, waiting to swapBuffers")),(0,t.kt)("h4",d({},{id:"rendering-client-layers"}),"rendering client layers"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643150328404-b6176d87255273165579bfd2a35670f914000f9426a8818582fe30c9af7a333b.png",alt:"picture 70"})),"  "),(0,t.kt)("h2",d({},{id:"\u7f16\u8bd1"}),"\u7f16\u8bd1"),(0,t.kt)("p",null,"\u5728\u628a\u7b2c\u4e8c\u4e2apatch\u7684\u6240\u6709\u5185\u5bb9\u90fd\u6253\u8fdbAOSP 10\u540e\u8fdb\u884c\u7f16\u8bd1\uff0c\u53d1\u73b0\u4e86\u65b0\u7684\u9519\u8bef\uff0c\u6709\u4e9b\u53d8\u91cf\u6ca1\u6709\uff0c\u8fd9\u8bf4\u660e\u67d0\u4e9b\u662f\u5728p1\u91cc\u5b9a\u4e49\u7684\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643259309065-400df4bbf3122953663fc51c354aedddc86e1c4e6c9bfedcc83b70fd1108c903.png",alt:"picture 90"})),"  "),(0,t.kt)("p",null,"\u8fd9\u5c31\u9ebb\u70e6\u4e86\u2026\u2026"),(0,t.kt)("p",null,"\u53c8\u662f\u6f2b\u957f\u7684\u627e\u53d8\u91cf\u8fc7\u7a0b\u3002"),(0,t.kt)("h3",d({},{id:"\u76ee\u524d\u7b56\u7565"}),"\u76ee\u524d\u7b56\u7565"),(0,t.kt)("p",null,"\u5c06\u5728ubuntu\u673a\u4e0a\u6240\u6709\u7684commit\u4fdd\u5b58\u6210\u65b0\u7684patch\uff0c\u6253\u56de\u4e3b\u673an10\u73af\u5883\uff0c\u518d\u4e0en8\u8fdb\u884c\u5bf9\u6bd4"),(0,t.kt)("h3",d({},{id:"\u76ee\u524d\u7b56\u7565\u66f4\u65b02022-01-27-151638"}),"\u76ee\u524d\u7b56\u7565\u66f4\u65b0@2022-01-27 15:16:38"),(0,t.kt)("p",null,"\u8003\u8651\u5230\u6709\u5f88\u591a\u7248\u672c\u95ee\u9898\u4e00\u4e00\u8981\u4fee\u590d\uff0c\u6240\u4ee5\u91c7\u7528git\u65b9\u5f0f\u5355\u72ec\u5bf9surfaceflinger\u8fdb\u884c\u63a7\u5236\u7ba1\u7406\uff0c\u4f46\u662f\u4e4b\u524d\u7531\u4e8e\u628a\u897f\u74dc\u7684 ",(0,t.kt)("inlineCode",{parentName:"p"},"hmdservice")," \u52a0\u8fdb\u6765\u5728",(0,t.kt)("inlineCode",{parentName:"p"},"native"),"\u7ea7\u522b\u4e00\u4e0b",(0,t.kt)("inlineCode",{parentName:"p"},"add"),"\u4e86\uff0c\u5bfc\u81f4git\u810f\u4e86\u3002"),(0,t.kt)("p",null,"\u6240\u4ee5\u73b0\u5728\uff0c\u62f7\u8d1d\u4e86\u4e00\u4efd\u5f53\u524d\u7684 ",(0,t.kt)("inlineCode",{parentName:"p"},"surfaceflinger"),"\uff08\u65e0git\u7248\u672c\uff09\uff0c\u7136\u540e\u91cd\u65b0\u62c9\u4e00\u4efd",(0,t.kt)("inlineCode",{parentName:"p"},"surfaceflinger"),"\uff0c\u63a5\u7740",(0,t.kt)("inlineCode",{parentName:"p"},"git init"),"\uff0c\u518d\u628a\u539f\u6765\u7684 ",(0,t.kt)("inlineCode",{parentName:"p"},"surfaceflinger"),"\u62f7\u8d1d\u56de\u6765\uff0c\u518d\u7528",(0,t.kt)("inlineCode",{parentName:"p"},"git commit"),"\u8fdb\u884c\u66f4\u65b0\uff0c\u8fd9\u6837\u5c31\u6709",(0,t.kt)("inlineCode",{parentName:"p"},"git history"),"\u4e86\uff0c\u53ef\u4ee5\u7528\u4e8e\u751f\u6210\u7eaf\u51c0\u7684patch\u3002"),(0,t.kt)("h3",d({},{id:"-error-use-of-undeclared-identifier-dirty"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: use of undeclared identifier 'dirty'")),(0,t.kt)("p",null,"problem:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270250699-1c9b572414150473871cc166d63ffc1f9db000bc70832683ff679bc566a8e739.png",alt:"picture 94"})),"  "),(0,t.kt)("p",null,"analysis:"),(0,t.kt)("p",null,"\u867d\u7136\u4f4d\u7f6e\u5bf9\u4e86\u3002"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643260910516-4abaab424f67566d72adcc7e9abbb2b307cb061d87d4a36d150f189c45242253.png",alt:"picture 91"})),"  "),(0,t.kt)("p",null,"\u4f46\u5176\u5b9e10\u91cc\u9762\u6362\u540d\u5b57\u4e86\u2026\u2026"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643260957409-fa660a0b04134b6438e205e23cd65c20fb141bd3165cb11f1609294f2c26fee5.png",alt:"picture 92"})),"  "),(0,t.kt)("p",null,"resolution:"),(0,t.kt)("p",null,"change ",(0,t.kt)("inlineCode",{parentName:"p"},"dirty.in")," to be ",(0,t.kt)("inlineCode",{parentName:"p"},"debugRegion.in"),", then fixed."),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270380057-954041c435c5766e2a9246e7117a4a459a521f5a79a7a79f2303fd5285f851fd.png",alt:"picture 95"})),"  "),(0,t.kt)("h3",d({},{id:"-error-use-of-undeclared-identifier-displaytransform"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: use of undeclared identifier 'displayTransform'")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643261575586-cfca4d2780992850c4e04abea21bf5408be3b635015dce9579b570189ec50702.png",alt:"picture 93"})),"  "),(0,t.kt)("h3",d({},{id:"-error-unknown-type-name-transform"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: unknown type name 'Transform'")),(0,t.kt)("p",null,"reason:"),(0,t.kt)("p",null,"when added ",(0,t.kt)("inlineCode",{parentName:"p"},"displayTransform")," line, then introduces ",(0,t.kt)("inlineCode",{parentName:"p"},"Transform")," which is not imported."),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270733917-88cfbcc1133a098b2826d05c30e3b39d6d8ee14d7cb0b5a8f0638d9d17e8aa81.png",alt:"picture 96"})),"  "),(0,t.kt)("p",null,"analysis:"),(0,t.kt)("p",null,"the ",(0,t.kt)("inlineCode",{parentName:"p"},"Transform")," is defined at: ",(0,t.kt)("inlineCode",{parentName:"p"},"ui/"),":"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643270989945-25cc87f8ab8ed0edcbb29ff230e4bae7ceac528caedc5e2d5f6c6a3a58ad77d6.png",alt:"picture 98"})),"  "),(0,t.kt)("p",null,"and the raw 10 used a ",(0,t.kt)("inlineCode",{parentName:"p"},"ui")," prefix both in ",(0,t.kt)("inlineCode",{parentName:"p"},".h")," and in ",(0,t.kt)("inlineCode",{parentName:"p"},".cpp")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643271063371-bfa7569154cf91f89dc21bd4e5721d8c3147664285e4452d12f86b057ed18eee.png",alt:"picture 99"})),"  "),(0,t.kt)("p",null,(0,t.kt)("del",{parentName:"p"},"so we need manually add a ",(0,t.kt)("inlineCode",{parentName:"del"},"ui")," namespace or add ",(0,t.kt)("inlineCode",{parentName:"del"},"ui")," prefix when we use ",(0,t.kt)("inlineCode",{parentName:"del"},"Transform")," variable.")),(0,t.kt)("p",null,"So it's not wise to add a ",(0,t.kt)("inlineCode",{parentName:"p"},"ui")," namespace in case of introducing conflict or affecting efficiency."),(0,t.kt)("p",null,"It's better for us to manually add ",(0,t.kt)("inlineCode",{parentName:"p"},"ui")," prefix when we use the ",(0,t.kt)("inlineCode",{parentName:"p"},"Transform")," variable."),(0,t.kt)("p",null,"resolution:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643271284098-f4a1b2cdf2424fa314a06bbed114872856c668e162db1bb0e1c45e39c6f9b599.png",alt:"picture 100"})),"  "),(0,t.kt)("p",null,"ok:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643271321290-c49b3cbb94321e9e2238ea90e0f40f39820261a82ae79eedafb2333871fb9508.png",alt:"picture 101"})),"  "),(0,t.kt)("h3",d({},{id:"-error-no-member-named-draw-in-androidlayer"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: no member named 'draw' in 'android::Layer'")),(0,t.kt)("p",null,"analysis:"),(0,t.kt)("p",null,"simulate what AOSP 10 is doing when 8 is ",(0,t.kt)("inlineCode",{parentName:"p"},"draw"),"ing."),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279221765-a1e4058d1e04f5d37f0a516a93209ef3d1b3ddba7f55fc4f7900eee0d1918d3a.png",alt:"picture 103"})),"  "),(0,t.kt)("p",null,"It can be seen that the ",(0,t.kt)("inlineCode",{parentName:"p"},"draw")," becomes a more sophisticated ",(0,t.kt)("inlineCode",{parentName:"p"},"prepare-xxx"),", just copy it now!"),(0,t.kt)("p",null,"resolution:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279430687-975f38e5baea3c7fb28b39f497903ea1adff155bd30ee69226c9fed65ff8bb3a.png",alt:"picture 106"})),"  "),(0,t.kt)("p",null,"ok:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279186528-7be5d583cf681cd2e1ea09285900e3a16d75fa3d886125fbe68bc8922e2a823f.png",alt:"picture 102"})),"  "),(0,t.kt)("h3",d({},{id:"-error-use-of-undeclared-identifier-mrenderengine-did-you-mean-renderengine"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: use of undeclared identifier 'mRenderEngine'; did you mean 'renderEngine'?")),(0,t.kt)("p",null,"problem:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279394094-1e450fe68afcb37d5e44a2828b89e1c3990fc7ab9377dc988e62fa8ff5b2c0e7.png",alt:"picture 105"})),"  "),(0,t.kt)("p",null,"reason:"),(0,t.kt)("p",null,"not initialized (even not defined in ",(0,t.kt)("inlineCode",{parentName:"p"},".h")," ?):"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279496721-63842bc08930f43fc784d44b88fce06f6d98587154b89a735c93b057c5c253d2.png",alt:"picture 107"})),"  "),(0,t.kt)("p",null,"do not exist exactly in ",(0,t.kt)("inlineCode",{parentName:"p"},".h")," !"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279565516-6244202abc3f4d78c323b4c8f1020c9e4cbe196f7d4834eee0b32fbb9fa30657.png",alt:"picture 108"})),"  "),(0,t.kt)("p",null,"resolution:"),(0,t.kt)("p",null,"just add it !"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279898807-928c19aec2a62ffc35659af4183e664b9a33be7d8e4aa0e9ffcf9f0e17aa227e.png",alt:"picture 109"})),"  "),(0,t.kt)("p",null,"ok:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643279913238-cf52cc95e317162963545b1a547daa9dbf7b4890f7555e5f532fd24026886d8f.png",alt:"picture 111"})),"  "),(0,t.kt)("h3",d({},{id:"-error-too-few-arguments-to-function-call-expected-5-have-3-renderengine-setuplayerblending"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: too few arguments to function call, expected 5, have 3 (RenderEngine->setupLayerBlending)")),(0,t.kt)("p",null,"reason: the api changes."),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"setupLayerBlending")," \u7684\u65b0\u63a5\u53e3\u91cc\u53d6\u6d88\u6389\u4e86 ",(0,t.kt)("inlineCode",{parentName:"p"},"alpha")," \uff08\u8fd9\u4e2a\u5012\u89c9\u5f97\u65e0\u6240\u8c13\uff09\uff0c\u4f46\u662f\u65b0\u589e\u4e86 ",(0,t.kt)("inlineCode",{parentName:"p"},"disableTexture"),", ",(0,t.kt)("inlineCode",{parentName:"p"},"color"),", ",(0,t.kt)("inlineCode",{parentName:"p"},"cornerRadius")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643292858686-1f7a4757e6e3e83dde525b484a6bd5db04a64037f9a973c164f047b8d1a367b4.png",alt:"picture 117"})),"  "),(0,t.kt)("p",null,"analysis:"),(0,t.kt)("p",null,"We can learn from this:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643292958805-09c2701d0625b1dfbd79c9f850e2f4d6283d58523ae82b34c0a383d463b708d2.png",alt:"picture 118"})),"  "),(0,t.kt)("p",null,"And the ",(0,t.kt)("inlineCode",{parentName:"p"},"color")," and ",(0,t.kt)("inlineCode",{parentName:"p"},"radius")," is derived from ",(0,t.kt)("inlineCode",{parentName:"p"},"layer")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643292986311-2e4418c71630b84636051ef3671cf04d57ba17dd3b2b4b1c5db9faf3c56e468d.png",alt:"picture 119"})),"  "),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293004105-7710cb8c71467925ad086b641ab0924796c179471cc9f608852d6088b67e7b8d.png",alt:"picture 120"})),"  "),(0,t.kt)("p",null,"Except the ",(0,t.kt)("inlineCode",{parentName:"p"},"mTexture")," is alone:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293026912-63f585a4bc133f40b0e1a2135a6e8934a605ac2e788817a3d18f245329baf253.png",alt:"picture 121"})),"  "),(0,t.kt)("p",null,"ok:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293040926-f04cffcb41fe54e5f505f75826d5e60a17ceeb3226514f031e379afb4e1272d0.png",alt:"picture 122"})),"  "),(0,t.kt)("h3",d({},{id:"-error-use-of-undeclared-identifier-renderarea"}),"\u2705 ",(0,t.kt)("inlineCode",{parentName:"h3"},"error: use of undeclared identifier 'renderArea'")),(0,t.kt)("p",null,"reason:"),(0,t.kt)("p",null,"It's caused by my change the ",(0,t.kt)("inlineCode",{parentName:"p"},"draw")," to be ",(0,t.kt)("inlineCode",{parentName:"p"},"prepareLayer")," in where there is no layers."),(0,t.kt)("p",null,"resolution:"),(0,t.kt)("p",null,"Now we just commented them, since it's possible that they are not that important and annoying to simulate a ",(0,t.kt)("inlineCode",{parentName:"p"},"draw")," function using ",(0,t.kt)("inlineCode",{parentName:"p"},"setupLayerBlending"),"."),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643293414679-afb2a4aa3891330597ff734e28f65e82963a1ec415b50c0fa7e64dce8b9f4fca.png",alt:"picture 123"})),"  "),(0,t.kt)("p",null,"ok / bonjour:"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643297485831-621052ab16b1695fa050b8d0c4ebd6c8b18fcf3ca52cb65ffadc0c730dec3379.png",alt:"picture 124"})),"  "),(0,t.kt)("h3",d({},{id:"\u7ec8\u4e8e\u6210\u529f\u4e862022-01-27-233703"}),"\u7ec8\u4e8e\u6210\u529f\u4e86\uff012022-01-27 23:37:03"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643297534048-7dc15ff720dd39a7cf6577f3c9cc7e09e479b79e480b590062851a4ff29952b0.png",alt:"picture 125"})),"  "),(0,t.kt)("h2",d({},{id:"\u5e74\u524d\u4e3b\u8981\u5de5\u4f5c\u76ee\u6807"}),"\u5e74\u524d\u4e3b\u8981\u5de5\u4f5c\u76ee\u6807"),(0,t.kt)("h3",d({},{id:"pre-check-list"}),"pre-check list"),(0,t.kt)("ul",d({},{className:"contains-task-list"}),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","++ Check props in ",(0,t.kt)("inlineCode",{parentName:"li"},"/system/build.prop"),"; note: \u8fd9\u4e2a\u6682\u65f6\u5148\u4e0d\u7528\u7ba1\u4e86\uff0c\u627e\u667a\u4f1f\u627e\u4e86\u4e00\u4e0b\uff0c\u90fd\u6ca1\u627e\u5230")),(0,t.kt)("h3",d({},{id:"core-1-list"}),"core 1 list"),(0,t.kt)("ul",d({},{className:"contains-task-list"}),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","+++ Add files of ",(0,t.kt)("inlineCode",{parentName:"li"},"HmdType6DistortionMesh")),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","+++ Add ",(0,t.kt)("inlineCode",{parentName:"li"},"HmdType6DistortionMesh")," into ",(0,t.kt)("inlineCode",{parentName:"li"},"Android.mk"))),(0,t.kt)("h3",d({},{id:"core-2-list"}),"core 2 list"),(0,t.kt)("ul",d({},{className:"contains-task-list"}),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","+++ suppress ",(0,t.kt)("inlineCode",{parentName:"li"},"#error")," of ",(0,t.kt)("inlineCode",{parentName:"li"},"gls2.h")),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","++ Add variable ",(0,t.kt)("inlineCode",{parentName:"li"},"eVrWindow")," into ",(0,t.kt)("inlineCode",{parentName:"li"},"ISurfaceComposerClient.h")),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","+++ Add variables definition into ",(0,t.kt)("inlineCode",{parentName:"li"},"surfaceflinger.h")),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","+++ Add ",(0,t.kt)("inlineCode",{parentName:"li"},"initFB")," into ",(0,t.kt)("inlineCode",{parentName:"li"},"surfaceflinger.cpp")),(0,t.kt)("li",{parentName:"ul"},"[?]"," +++ Add ",(0,t.kt)("inlineCode",{parentName:"li"},"doComposeSurfaces")," into ",(0,t.kt)("inlineCode",{parentName:"li"},"surfaceflinger.cpp"))),(0,t.kt)("h3",d({},{id:"core-3-list"}),"core 3 list"),(0,t.kt)("ul",d({},{className:"contains-task-list"}),(0,t.kt)("li",d({parentName:"ul"},{className:"task-list-item"}),(0,t.kt)("input",d({parentName:"li"},{type:"checkbox",checked:!0,disabled:!0}))," ","++ Add ",(0,t.kt)("inlineCode",{parentName:"li"},"vr")," variable and ",(0,t.kt)("inlineCode",{parentName:"li"},"get|set")," into ",(0,t.kt)("inlineCode",{parentName:"li"},"Layer.h")," (but implemented in ",(0,t.kt)("inlineCode",{parentName:"li"},"surfaceflinger.cpp"),")"),(0,t.kt)("li",{parentName:"ul"},"[?]"," + Add ",(0,t.kt)("inlineCode",{parentName:"li"},"win.right")," and ",(0,t.kt)("inlineCode",{parentName:"li"},"position")," into ",(0,t.kt)("inlineCode",{parentName:"li"},"Layer.cpp"))),(0,t.kt)("h2",d({},{id:"\u5e74\u524d\u4e3b\u8981\u56f0\u96be\u5206\u6790"}),"\u5e74\u524d\u4e3b\u8981\u56f0\u96be\u5206\u6790"),(0,t.kt)("h3",d({},{id:"layercpp\u4e2d\u5173\u4e8ewin\u548cposition"}),(0,t.kt)("inlineCode",{parentName:"h3"},"Layer.cpp"),"\u4e2d\u5173\u4e8e",(0,t.kt)("inlineCode",{parentName:"h3"},"win"),"\u548c",(0,t.kt)("inlineCode",{parentName:"h3"},"position")),(0,t.kt)("p",null,"\u8fd9\u662fpatch\u622a\u56fe\uff1a"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-problems-1643166975497-f3269e96a60010bb3b024829d8d884748f7870a6c070e92c708da11c0516b0a4.png",alt:"picture 71"})),"  "),(0,t.kt)("p",null,"\u8fd9\u662fAOSP 8 \u548c 11 \u4e2d\u8fd9\u90e8\u5206\u4ee3\u7801\u4f4d\u7f6e\uff1a"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-problems-1643167134668-81d592f0345aba1a0e67f670a66b9ea7772884ab0a2dbe340e772325a65170f8.png",alt:"picture 72"})),"  "),(0,t.kt)("p",null,"8\u4e2dpatch\u4fee\u6539\u7684\u90e8\u5206\u662f\u5728",(0,t.kt)("inlineCode",{parentName:"p"},"drawWithOpenGL"),"\u51fd\u6570\u5185\uff0c\u4f46\u662f11\u4e2d\u540c\u6587\u4ef6\u6ca1\u6709\u8fd9\u5757\u5185\u5bb9\uff0c11\u4e2dOpenGL\u6574\u4f53\u90fd\u79fb\u51fa\u53bb\u4e86\u3002\u8fd9\u662f\u7b2c\u4e00\u4e2a\u95ee\u9898\u3002"),(0,t.kt)("p",null,"\u7b2c\u4e8c\u4e2a\u95ee\u9898\u5c31\u662f\uff0c\u8fd9\u4e2a",(0,t.kt)("inlineCode",{parentName:"p"},"win.right = hw->getWidth()"),"\u6211\u6ca1\u6709\u592a\u7406\u89e3\u3002",(0,t.kt)("inlineCode",{parentName:"p"},"win"),"\u662f\u57fa\u4e8e",(0,t.kt)("inlineCode",{parentName:"p"},"bounds(computeBounds())"),"\u5f97\u5230\u7684\uff0c\u662f\u51cf\u53bb\u900f\u660e\u533a\u57df\u540e\u7684\u533a\u57df\uff0c\u5b83\u7684\u6784\u9020\u5982\u4e0b\uff1a"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643137518943-d8297585f5c0fa99e05666d3eaeb3a8e87e544c55deb73dd390d224ab758b3c9.png",alt:"picture 56"})),"  "),(0,t.kt)("p",null,"8\u548c11\u5728\u8fd9\u91cc\u7684\u533a\u522b\u4e0d\u662f\u5f88\u5927\uff0c\u53ea\u4e0d\u8fc7",(0,t.kt)("inlineCode",{parentName:"p"},"computeBounds"),"\u540d\u5b57\u6539\u6210\u4e86",(0,t.kt)("inlineCode",{parentName:"p"},"getBounds"),"\uff0c\u5185\u90e8\u5b9e\u73b0\u4e5f\u76f8\u5e94\u5730\u66f4\u7b80\u6d01\u4e86\u4e00\u4e9b\uff0c\u6838\u5fc3\u601d\u60f3\u5c31\u662f\u7a97\u53e3\u533a\u57df\u51cf\u53bb\u900f\u660e\u533a\u57df\uff0c\u5f97\u5230\u7684\u5c31\u662f\u6240\u8c13",(0,t.kt)("inlineCode",{parentName:"p"},"Rect"),"\uff0c\u4e5f\u5c31\u662f\u5b9e\u9645\u533a\u57df\u5427\u3002",(0,t.kt)("del",{parentName:"p"},"\u81f3\u4e8e\u7ed3\u6784\u4f53\u662f\u5565\uff0c\u56db\u4e2a\u5750\u6807\u5417\uff0c\u8fd8\u662f\u5565\uff0c\u5e94\u8be5\u5012\u4e5f\u4e0d\u662f\u90a3\u4e48\u91cd\u8981\u3002")),(0,t.kt)("p",null,"\u6211\u8fd9\u91cc\u5176\u5b9e\u4e3b\u8981\u56f0\u60d1\u7684\u5728\u4e8e\uff0c\u5982\u679c",(0,t.kt)("inlineCode",{parentName:"p"},"win"),"\u662f\u6307\u90a3\u4e2a\u6d3b\u52a8\u7a97\u53e3\uff0c\u6bd4\u5982\u8bf4\u67d0\u4e2a\u6d6e\u52a8\u7a97\u53e3\uff0c\u90a3\u5728vr\u6a21\u5f0f\u4e0b\u5355\u72ec\u6539\u5176",(0,t.kt)("inlineCode",{parentName:"p"},"right"),"\u4e3a",(0,t.kt)("inlineCode",{parentName:"p"},"hw"),"\u7684\u5bbd\u5ea6\uff0c\u800c\u4e0d\u628a",(0,t.kt)("inlineCode",{parentName:"p"},"left"),"\u6539\u62100\uff0c\u8fd9\u662f\u5426\u4f1a\u6709\u95ee\u9898\u5462\uff1f\u81f3\u5c11\u770b\u8d77\u6765\u4e0d\u662f\u90a3\u4e48\u5bf9\u79f0\uff0c\u6240\u4ee5\u8fd9\u91cc\u5728\u539f\u7406\u4e0a\u6765\u8bf4\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u56f0\u60d1\u3002"),(0,t.kt)("p",null,"\u8fd8\u662f\uff0c\u5148\u770b\u770b\u5982\u4f55\u572811\u4e2d\u5b9e\u73b0\u8fd9\u4e2a\u4fee\u6539\u5427\u3002"),(0,t.kt)("h4",d({},{id:"\u53ef\u75911-layerprepareclientcomposition"}),"\u53ef\u75911. ",(0,t.kt)("inlineCode",{parentName:"h4"},"Layer::prepareClientComposition()")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138949603-bd8010805a1b2d7274c9adf4c6c21c43c549711742aadeb94d21c388e1468ca7.png",alt:"picture 58"})),"  "),(0,t.kt)("p",null,"\u5728\u8fd9\u5757\u91cc\uff0c\u6700\u5927\u7684\u53ef\u7591\u539f\u56e0\u662f\u6b63\u597d\u4e0e\u5de6\u8fb98\u7684\u7248\u672c\u5bf9\u9f50\uff0c\u5e76\u4e14\u51fd\u6570\u540d\u5c31\u662f\u5728\u753b\u56fe\uff1a"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139039422-45fe81e61a85a9a61de7d2d34b40023143d959a149be023b1f89ef875e73a6eb.png",alt:"picture 59"})),"  "),(0,t.kt)("p",null,"\u53e6\u5916\u4e5f\u6709\u4e00\u4e2a\u5173\u952e\u8d4b\u503c\u8bed\u53e5\uff1a",(0,t.kt)("inlineCode",{parentName:"p"},"layerSettings.geometry.boundaries = bounds;"),"\uff0c\u6211\u4eec\u82e5\u5728\u8d4b\u503c\u4e4b\u524d\uff0c\u4fee\u6539",(0,t.kt)("inlineCode",{parentName:"p"},"bounds.right"),"\u4e3a",(0,t.kt)("inlineCode",{parentName:"p"},"hw.getWidth()"),"\uff0c\u6216\u8bb8\u5c31\u548c8\u5bf9\u9f50\u4e86\u3002"),(0,t.kt)("p",null,"\u53ea\u4e0d\u8fc7\u6700\u5927\u7684\u95ee\u9898\u662f\uff0c\u8fd9\u4e2a\u51fd\u6570\u4e0d\u63a5\u6536",(0,t.kt)("inlineCode",{parentName:"p"},"hw"),"\u7684\u53c2\u6570\u2026\u2026\uff0c\u6240\u4ee5\uff0c\u5f88\u53ef\u80fd\uff0c\u4e0d\u662f\u6211\u4eec\u76f8\u8981\u7684\u3002"),(0,t.kt)("p",null,"\u4f46\u6211\u53c8\u627e\u4e86\u4e00\u4e0b",(0,t.kt)("inlineCode",{parentName:"p"},"hw"),"\u7684\u7c7b",(0,t.kt)("inlineCode",{parentName:"p"},"DeviceDisplay"),"\uff0c\u53d1\u73b0\u8fd9\u4e2a\u6587\u4ef6\u91cc\u5f88\u5c11\u7528\uff1a"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139341595-57becab0aa04cd092d41f5176b3f5afd575609567c75524f460af9e009e9996e.png",alt:"picture 60"})),"  "),(0,t.kt)("p",null,"\u5e76\u4e14 ",(0,t.kt)("inlineCode",{parentName:"p"},"hw->"),"\u7684\u8c03\u7528\u4e5f\u662f\u4e00\u4e2a\u90fd\u6ca1\u3002"),(0,t.kt)("h4",d({},{id:"\u53ef\u75912-inputwindowinfo-layerfillinputinfo"}),"\u53ef\u75912. ",(0,t.kt)("inlineCode",{parentName:"h4"},"InputWindowInfo Layer::fillInputInfo()")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643138409793-047823adc1fbf5db5d36fc05a824d31ff9e81110a4ce1a4ef69833d217f0c026.png",alt:"picture 57"})),"  "),(0,t.kt)("p",null,"\u6211\u57fa\u4e8e",(0,t.kt)("inlineCode",{parentName:"p"},"getBounds"),"\u51fd\u6570\u8ffd\u5230\u8fd9\u5757\uff08\u53ef\u75911\u4e5f\u6709",(0,t.kt)("inlineCode",{parentName:"p"},"getBounds"),"\uff09\uff0c\u53d1\u73b0\u4ee3\u7801\u7ed3\u6784\u5c31\u6bd4\u8f83\u50cf\u76ee\u6807\u4ee3\u7801\u3002\u5c24\u5176\u662f",(0,t.kt)("inlineCode",{parentName:"p"},"x|ySurfaceInset"),"\u7684\u6784\u9020\u4e0e\u4f7f\u7528\uff0c\u53ef\u4ee5\u770b\u5230",(0,t.kt)("inlineCode",{parentName:"p"},"xSurfaceInset"),"\u4e5f\u7528\u5230\u4e86",(0,t.kt)("inlineCode",{parentName:"p"},"layerBounds.getWidth()"),"\u51fd\u6570\uff0c\u5e76\u4e14\u540e\u7eed\u8fd8\u6709\u4e00\u53e5",(0,t.kt)("inlineCode",{parentName:"p"},"layerBounds.inset(xSurfaceInset, ySurfaceInset, xSurfaceInset, ySurfaceInset);"),"\u770b\u8d77\u6765\u4eff\u4f5b\u5728\u6784\u9020\u4e24\u4e2a\u773c\u955c\u7684\u67d0\u4e9b\u53c2\u6570\u4e00\u6837\u3002"),(0,t.kt)("h4",d({},{id:"position\u4f3c\u4e4e\u6ca1\u6709\u88ab\u8c03\u7528\u7684\u56f0\u60d1"}),"position\u4f3c\u4e4e\u6ca1\u6709\u88ab\u8c03\u7528\u7684\u56f0\u60d1"),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643139564016-37973fb37dbac73e4fa89c3e2d7fb127e1415c0699dc370f39de3ffd47749d10.png",alt:"picture 61"})),"  "),(0,t.kt)("p",null,"\u5206\u6790\u4e86",(0,t.kt)("inlineCode",{parentName:"p"},"win"),"\u540e\uff0c\u4e0b\u9762\u7684\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u5173\u4e8e",(0,t.kt)("inlineCode",{parentName:"p"},"position"),"\u7684\uff0c\u7136\u800c\u5149\u4ece\u8fd9\u6bb5\u6765\u770b\u7684\u8bdd\uff0c\u4f3c\u4e4e\u6ca1\u6709\u8d77\u5230\u4efb\u4f55\u4f5c\u7528\uff0c\u4ec5\u4ec5\u662f\u4e00\u4e2a\u8d4b\u503c\uff0c\u6240\u4ee5\u4e0d\u592a\u61c2\u8fd9\u4e2a\u8bbe\u8ba1\u3002\u5982\u679c\u8fd9\u662f\u4e2a\u5168\u5c40\u53d8\u91cf\uff0c\u6211\u8fd8\u6bd4\u8f83\u660e\u767d\uff0c\u8bf4\u660e",(0,t.kt)("inlineCode",{parentName:"p"},"position[2]"),"\u53ef\u80fd\u662f\u5de6\u773c\u53f3\u8fb9\u70b9\uff0c\u800c",(0,t.kt)("inlineCode",{parentName:"p"},"position[3]"),"\u662f\u53f3\u773c\u5de6\u8fb9\u70b9\u3002"),(0,t.kt)("h3",d({},{id:"surfaceflingercpp\u4e2d\u5173\u4e8e-docomposesurfaces"}),(0,t.kt)("inlineCode",{parentName:"h3"},"surfaceflinger.cpp"),"\u4e2d\u5173\u4e8e ",(0,t.kt)("inlineCode",{parentName:"h3"},"doComposeSurfaces")),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-problems-1643167933698-db055f067f102fdb102f9439b13842250003015447719c5459a4593af867b2b9.png",alt:"picture 73"})),"  "),(0,t.kt)("p",null,(0,t.kt)("img",d({parentName:"p"},{src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/surfaceflinger-patch-research-1643144378837-b02055303c54561f2c6769b85e61e9213186d752c210af0d1d507899a61f690a.png",alt:"picture 65"})),"  "),(0,t.kt)("p",null,"\u5f88\u60e8\uff0c8\u91cc\u9762\u7684\u63a5\u53e3\u76f4\u63a5\u88ab\u5265\u4e86\uff0c\u7ecf\u8fc7\u5bf9\u6bd4\uff0c\u5b9e\u9645\u4e0a10\u8fd8\u662f\u6709\u7684\uff0c\u6240\u4ee5\u662f11\u65f6\u5220\u7684\u3002"),(0,t.kt)("p",null,"\u800c ",(0,t.kt)("inlineCode",{parentName:"p"},"doComposeSurfaces")," \u51fd\u6570\u6b63\u597d\u8fd8\u6bd4\u8f83\u590d\u6742\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-text"}),'handleMessageRefresh\n     |\u2014> preComposition\n     |\u2014> rebuildLayerStacks\n     |\u2014> setUpHWComposer\n          |\u2014> HWComposer::createWorkList <== hwc="" structures="" are="" allocated="" |\u2014=""> Layer::setGeometry()\n          |\u2014  set per frame data\n          |\u2014  HWComposer::prepare\n               |\u2014> hwc prepare\n     |\u2014> doComposition\n          |---- skip composition on external display if condition meets\n          |\u2014> doDisplayComposition\n          |    |\u2014> doComposeSurfaces\n          |     |\u2014> DisplayDevice::swapBuffers\n          |          |\u2014> eglSwapBuffers\n          |          |\u2014> FramebufferSurface::advanceFrame\n          |\u2014> DisplayDevice::flip(\u2026)     <== just="" update="" statistics="" count="" |--=""> Call DisplayDevice::compositionComplete(), notify each display\n               |--\x3e DisplaySurface::compositionComplete()\n                    |--\x3e FramebufferSurface::compositionComplete()\n                         |--\x3e HWComposer::fbCompositionComplete()\n                              |--\x3e NoOP if HWC >= 1.1\n                              |--\x3e used only in framebuffer device case.\n          |\u2014> postFrameBuffer\n               |\u2014> HWComposer::commit\n                    |\u2014> hwc set\n                    |\u2014> update retireFenceFd of hwc_display_contents_1\n               |\u2014> DisplayDevice::onSwapBuffersCompleted\n                    |\u2014> FramebufferSurface::onFrameComitted\n               |\u2014> Layer::onLayerDisplayed\n               |\u2014   update some statistics\n     |\u2014> postComposition \n')),(0,t.kt)("p",null,"\u76ee\u524d\u5df2\u77e5\u7684\uff0c\u5173\u4e8eopengl\u7684\u5b9e\u73b0\u8def\u5f84\u53d8\u52a8\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",d({parentName:"pre"},{className:"language-text"}),"## Mesh.h, Texture.h \u90fd\u5728\u8be5\u76ee\u5f55\u4e0b\nRenderEngine --\x3e ./libs/renderengine/include/renderengine\n\n## gls2.h, gls2ext.h \u90fd\u5728\u8be5\u76ee\u5f55\u4e0b\nGLES2 --\x3e ./opengl/include/GLES2\n")),(0,t.kt)("p",null,"\u4f46\u662f\u5173\u952e\u662f ",(0,t.kt)("inlineCode",{parentName:"p"},"doComposeSurfaces")," \u4e2d\u7684\u51fd\u6570\u4f53\u975e\u5e38\u5927\uff0c\u7ed3\u679c\u523011\u5168\u88ab\u5272\u51fa\u53bb\u4e86\u3002"))}b.isMDXComponent=!0}}]);